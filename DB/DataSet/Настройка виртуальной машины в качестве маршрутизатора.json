{
  "title": "Настройка виртуальной машины в качестве маршрутизатора",
  "chapters": [
    {
      "name": "Настройка виртуальной машины в качестве маршрутизатора",
      "content": "Практические руководства Evolution    \n\n # Настройка виртуальной машины в качестве маршрутизатора   Эта статья полезна?          \nС помощью этого руководства вы настроите виртуальную машину в качестве маршрутизатора и с ее помощью организуете доступ в интернет для других машин в подсети.\nМаршрутизатор позволяет перенаправлять трафик от одного сетевого интерфейса к другому.\nПринцип его работы состоит в следующем:\n1. На сетевой интерфейс маршрутизатора приходит трафик от других машин подсети.\n2. При прохождении трафика через маршрутизатор в заголовках IP-пакетов происходит подмена адреса источника.\n3. Виртуальные машины в подсети получают доступ в интернет с помощью публичного IP-адреса, который назначен на сетевой интерфейс маршрутизатора.\nТаким образом можно полностью контролировать трафик, не используя SNAT-шлюзы и другие облачные инструменты.\nВы будете использовать следующие сервисы:\n- Виртуальные машины — сервис, в рамках которого предоставляется виртуальная машина.\n- Публичный IP-адрес.\nШаги:\n1. Разверните ресурсы в облаке.\n2. Настройте маршрутизатор.\n3. Настройте сетевой интерфейс маршрутизатора.\n4. Настройте клиентскую ВМ.\n\n## Перед началом работы\n1. Зарегистрируйтесь в личном кабинете Cloud.ru.\nЕсли вы уже зарегистрированы, войдите под своей учетной записью.\n2. Убедитесь, что для вашей учетной записи достаточно прав на проект.\nПри необходимости настройте права или запросите их у администратора.\n\n## 1. Разверните ресурсы в облаке\nНа этом шаге вы создадите две виртуальные машины: маршрутизатор и клиент.\nМаршрутизатор будет принимать трафик от других ВМ в подсети.\nКлиентская виртуальная машина без публичного IP-адреса будет получать доступ в интернет через маршрутизатор.\n1. Создайте виртуальную машину со следующими параметрами:\n- Название — vm-router.\n- Зона доступности — ru.AZ-1.\n- Образ — публичный образ Ubuntu 22.04.\n- Сетевой интерфейс — выберите тип Подсеть с публичным IP.\n- VPC — Default.\n- Подсеть — Default_ru.AZ-1.\nСкопируйте и сохраните адрес подсети: он потребуется для дальнейшей настройки.\n- Публичный IP — оставьте Арендовать новый или выберите IP-адрес из списка арендованных.\n- Логин — router.\n- Метод аутентификации — Пароль.\n- Пароль — задайте пароль пользователя.\n2. В строке ВМ vm-router скопируйте и сохраните адрес из столбца Внутренний IP: он потребуется для дальнейшей настройки.\n3. Создайте виртуальную машину со следующими параметрами:\n- Название — vm-client.\n- Зона доступности — ru.AZ-1.\n- Образ — публичный образ Ubuntu 22.04.\n- Сетевой интерфейс — выберите тип Подсеть.\n- VPC — Default.\n- Подсеть — Default_ru.AZ-1.\n- Логин — client.\n- Метод аутентификации — Пароль.\n- Пароль — задайте пароль пользователя.\n\n## 2. Настройте маршрутизатор\nНа маршрутизаторе необходимо настроить правила, по которым он управляет трафиком.\n1. Нажмите на название виртуальной машины vm-router.\n2. Перейдите на вкладку Серийная консоль.\n3. Введите логин и пароль пользователя, указанные при создании ВМ.\n4. Включите маршрутизацию пакетов в параметрах ядра.\n1. Проверьте текущий статус параметра.\nВыполните команду:\n```\ncat /proc/sys/net/ipv4/ip_forward\n```\n\nРезультат выполнения команды:\n2. Откройте файл /etc/sysctl.conf для редактирования:\n```\nsudo nano /etc/sysctl.conf\n```\n3. Найдите строку #net.ipv4.ip_forward=1 и удалите знак # в начале.\nСохраните изменения.\n4. Примените изменения:\n```\nsudo sysctl -p /etc/sysctl.conf\n```\n5. Создайте правило маршрутизации, которое при передаче трафика подменяет IP-адрес виртуальных машин в подсети на IP-адрес маршрутизатора:\n```\nsudo iptables -t nat -A POSTROUTING -o enp3s0 -s <subnet_address> -j SNAT --to <internal_router_ip>\n```\n\nГде:\n- <subnet_address> — адрес подсети Default_ru.AZ-1.\n- <internal_router_ip> — внутренний IP-адрес виртуальной машины vm-router.\n6. Сохраните правило:\n```\nsudo mkdir /etc/iptables && touch /etc/iptables/iptables.rules && iptables-save > /etc/iptables/iptables.rules\n```\n\n## 3. Настройте сетевой интерфейс маршрутизатора\nНа сетевом интерфейсе маршрутизатора необходимо отключить проверку адресов источника и назначения.\n1. На странице сервиса «Виртуальные машины» выберите виртуальную машину vm-router.\n2. Перейдите на вкладку Сетевые параметры.\n3. В правом верхнем углу блока нужного сетевого интерфейса нажмите  и выберите Свойства.\n4. Отключите опцию Проверка адреса источника/назначения.\n5. Подтвердите отключение.\n\n## 4. Настройте клиентскую ВМ\nПосле настройки маршрутизатора нужно изменить статические маршруты на клиентской ВМ.\n1. На странице сервиса «Виртуальные машины» выберите виртуальную машину vm-client.\n2. Перейдите на вкладку Серийная консоль.\n3. Введите логин и пароль пользователя, указанные при создании ВМ.\n4. Удалите маршрут по умолчанию:\n```\nsudo ip r delete default\n```\n5. Добавьте новый маршрут по умолчанию, который указывает на vm-router:\n```\nsudo ip r add default via <internal_router_ip> dev enp3s0\n```\n\nГде <internal_router_ip> — внутренний IP-адрес виртуальной машины vm-router.\n6. Измените маршруты к DNS-серверам на vm-client:\n```\nsudo ip r add 8.8.8.8 via <internal_router_ip> dev enp3s0sudo ip r add 8.8.4.4 via <internal_router_ip> dev enp3s0\n```\n7. Проверьте доступ в интернет с помощью команды ping:\n```\nping -c 10 cloud.ru\n```\n\nУбедитесь, что пакеты возвращаются.\nПример ответа команды:\n```\nPING cloud.ru (185.71.64.201) 56(84) bytes of data.64 bytes from 185.71.64.201 (185.71.64.201): icmp_seq=1 ttl=57 time=5.55 ms64 bytes from 185.71.64.201 (185.71.64.201): icmp_seq=2 ttl=57 time=2.53 ms64 bytes from 185.71.64.201 (185.71.64.201): icmp_seq=3 ttl=57 time=1.82 ms64 bytes from 185.71.64.201 (185.71.64.201): icmp_seq=4 ttl=57 time=1.88 ms64 bytes from 185.71.64.201 (185.71.64.201): icmp_seq=5 ttl=57 time=1.71 ms64 bytes from 185.71.64.201 (185.71.64.201): icmp_seq=6 ttl=57 time=1.79 ms64 bytes from 185.71.64.201 (185.71.64.201): icmp_seq=7 ttl=57 time=1.67 ms64 bytes from 185.71.64.201 (185.71.64.201): icmp_seq=8 ttl=57 time=1.58 ms64 bytes from 185.71.64.201 (185.71.64.201): icmp_seq=9 ttl=57 time=1.65 ms64 bytes from 185.71.64.201 (185.71.64.201): icmp_seq=10 ttl=57 time=1.97 ms\n--- cloud.ru ping statistics ---10 packets transmitted, 10 received, 0% packet loss, time 13059ms\n```\nТеперь трафик с vm-client передается в интернет через vm-router.\n\n## Результат\nВы научились настраивать виртуальную машину в качестве маршрутизатора и управлять через нее доступом в интернет для других виртуальных машин в подсети.\n\n  [© 2025 Cloud.ru](https://cloud.ru)",
      "debug": {
        "start_page": 1,
        "end_page": 1
      }
    }
  ]
}