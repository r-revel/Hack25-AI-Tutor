{
  "title": "Развертывание Deployment с горизонтальным масштабированием подов",
  "chapters": [
    {
      "name": "Развертывание Deployment с горизонтальным масштабированием подов",
      "content": "Практические руководства Evolution    \n\n # Развертывание Deployment с горизонтальным масштабированием подов   Эта статья полезна?          \nВ сценарии развернем Deployment с Apache и PHP, а затем зададим условия изменения количества подов в зависимости от нагрузки на виртуальный процессор:\n- Пороговая нагрузка на виртуальный процессор — 60% от запрошенного на запуск контейнера.\n- Минимальное количество реплик — 2.\n- Максимальное количество реплик — 7.\n\n## Перед началом работы\n1. Создайте кластер Managed Kubernetes и хотя бы одну группу узлов.\n2. Установите плагин Metrics Server.\n3. Подключитесь к кластеру Managed Kubernetes.\n\n## Шаг 1. Создайте Deployment\nСохраните следующую спецификацию в файл cloudru-php-apache.yaml:\n```\napiVersion: apps/v1kind: Deploymentmetadata:  name: cloudru-php-apache  namespace: defaultspec:  replicas: 3  selector:    matchLabels:      run: cloudru-php-apache  template:    metadata:      labels:        run: cloudru-php-apache    spec:      containers:      - name: hpa-example        image: mk8s.registry.smk.sbercloud.dev/hpa-example        ports:        - containerPort: 80        resources:          requests:            cpu: \"250m\"---apiVersion: v1kind: Servicemetadata:  name: cloudru-php-apache  labels:    run: cloudru-php-apachespec:  ports:  - port: 80  selector:    run: cloudru-php-apache\n```\n\nОбязательно укажите параметр resources.requests.cpu — запрос CPU для запуска контейнера, чтобы выполнять автоматическое масштабирование на основе использования ресурса в процентах.\nВыполните команду:\n```\nkubectl create -f cloudru-php-apache.yaml\n```\n\nЕсли команда выполнена успешно, появится сообщение:\n```\ndeployment.apps/cloudru-php-apache created\n```\n\n## Шаг 2. Создайте Horizontal Pod Autoscaler одним из способов\n\nСпособ 1Сохраните следующую спецификацию в файл cloudru-hpa.yaml:\n```\napiVersion: autoscaling/v1kind: HorizontalPodAutoscalermetadata:  name: cloudru-hpaspec:  scaleTargetRef:    apiVersion: apps/v1    kind: Deployment    name: cloudru-php-apache  minReplicas: 2  maxReplicas: 7  targetCPUUtilizationPercentage: 60\n```\n\nЗатем выполните команду:\n```\nkubectl create -f cloudru-hpa.yaml\n```\n\nСпособ 2Выполните команду:\n```\nkubectl autoscale deployment cloudru-php-apache --cpu-percent=60 --min=2 --max=7\n```\n\nВ результате будет создан Horizontal Pod Autoscaler для Deployment cloudru-php-apache.\nПри нагрузке на виртуальный процессор:\n- выше 60% от запрошенной нагрузки на каждый контейнер — количество подов будет постепенно увеличиваться, пока не достигнет семи;\n- ниже 60% от запрошенной нагрузки на каждый контейнер — количество подов будет постепенно уменьшаться, пока не достигнет двух.\nДля горизонтального масштабирования подов можно использовать не только метрики CPU, но и RAM.\nВ этом случае для создания HPA используйте следующую спецификацию:\n```\napiVersion: autoscaling/v2kind: HorizontalPodAutoscalermetadata:  name: cloudru-php-apachespec:  scaleTargetRef:    apiVersion: apps/v1    kind: Deployment    name: cloudru-php-apache  minReplicas: 2  maxReplicas: 7  metrics:  - type: Resource    resource:      name: cpu      target:        type: Utilization        averageUtilization: 60  - type: Resource    resource:      name: memory      target:        type: AverageValue        averageValue: 500Mi\n```\n\nПри увеличении нагрузки на виртуальный процессор выше 60%  от запрошенной нагрузки на каждый контейнер и занятой оперативной памяти более 500 МиБ, количество подов будет увеличиваться, пока не достигнет семи подов.\nПри уменьшении нагрузки на виртуальный процессор ниже 60% от запрошенной нагрузки на каждый контейнер и занятой оперативной памяти менее 500 МиБ, количество подов будет уменьшаться, пока не достигнет двух подов.\n\n## Шаг 3. Получите список HPA в кластере\nВыполните команду:\n```\nkubectl get hpa\n```\n\nОтвет будет содержать следующее:\n```\nNAME                 REFERENCE                       TARGETS   MINPODS   MAXPODS   REPLICAS   AGEcloudru-php-apache   Deployment/cloudru-php-apache   0%/60%    2         7        3          121s\n```\n\n## Шаг 4. Создайте нагрузку для веб-сервера\nВыполните команду:\n```\nkubectl run -i --tty load-generator --rm --image=busybox --restart=Never -- /bin/sh -c \"while sleep 0.01; do wget -q -O- http://cloudru-php-apache; done\"\n```\n\nЧтобы наблюдать за масштабированием, периодически запускайте следующую команду в терминале, отличном от терминала, на котором вы выполняли предыдущий шаг:\n```\nkubectl get hpa cloudru-php-apache --watch\n```\n\nОтвет будет содержать следующее:\n```\nNAME                 REFERENCE                       TARGETS   MINPODS   MAXPODS   REPLICAS   AGEcloudru-php-apache   Deployment/cloudru-php-apache   200%/60%    2         7        3          5m34s\n```\n\nТак как потребление процессора возросло до 200% от запрошенного, количество реплик было увеличено до 5:\n```\nNAME                 REFERENCE                       TARGETS   MINPODS   MAXPODS   REPLICAS   AGEcloudru-php-apache   Deployment/cloudru-php-apache   200%/60%    2         7        5          7m\n```\n\nУвеличение количества подов может занять несколько минут.\n\n## Шаг 5. Остановите нагрузку для веб-сервера\nЧтобы завершить генерацию нагрузки, в терминале, где вы создали под, запускающий образ busybox, нажмите Ctrl + C.\nЗатем через несколько минут выполните команду:\n```\nkubectl get hpa cloudru-php-apache --watch\n```\n\nРезультат:\n```\nNAME                 REFERENCE                        TARGETS   MINPODS   MAXPODS   REPLICAS   AGEcloudru-php-apache   Deployment/cloudru-php-apache    0%/60%    2         7        1          10m\n```\n\n## Шаг 6. Удалите ресурсы\nЕсли вы закончили работать с HPA, удалите созданные ресурсы.\n1. Удалите cloudru-hpa:\n```\nkubectl delete cloudru-hpa cloudru-php-apache\n```\n\nПри удалении HPA Deployment остается в существующем масштабе и не возвращается к количеству реплик, указанному в исходной спецификации Deployment.\nЕсли необходимо, измените количество реплик, например, до трех:\n```\nkubectl scale deployment cloudru-php-apache --replicas=3\n```\n2. Удалите Deployment:\n```\nkubectl delete deployment cloudru-php-apache\n```\n\nРезультат:\n```\ndeployment.apps \"cloudru-php-apache\" deleted\n```\n\nПоды удалятся вместе с Deployment.\n3. Если необходимо, удалите кластер.\nСм.также Горизонтальное масштабирование подов\n\n  [© 2025 Cloud.ru](https://cloud.ru)",
      "debug": {
        "start_page": 1,
        "end_page": 1
      }
    }
  ]
}