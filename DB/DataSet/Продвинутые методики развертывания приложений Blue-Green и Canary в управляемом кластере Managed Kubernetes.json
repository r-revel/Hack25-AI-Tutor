{
  "title": "Продвинутые методики развертывания приложений Blue-Green и Canary в управляемом кластере Managed Kubernetes",
  "chapters": [
    {
      "name": "Продвинутые методики развертывания приложений Blue-Green и Canary в управляемом кластере Managed Kubernetes",
      "content": "Практические руководства Evolution    \n\n # Продвинутые методики развертывания приложений Blue-Green и Canary в управляемом кластере Managed Kubernetes   Эта статья полезна?          \nС помощью этого руководства вы научитесь работать с продвинутыми стратегиями развертывания контейнерных приложений Blue-Green Deployment и Canary Deployment в управляемом кластере Managed Kubernetes на платформе Cloud.ru Evolution.\nBlue-Green Deployment — это метод развертывания, использующий две идентичные среды: синюю — текущую и зеленую — новую.\nПока пользователи работают с синей средой, в зеленой разворачивается и тестируется обновление.\nПосле проверки весь трафик мгновенно переключается на зеленую среду.\nЭто позволяет обновлять приложение без простоев и быстро откатываться в случае проблем.\nCanary Deployment — это стратегия постепенного развертывания, при котором новая версия приложения сначала выпускается для небольшой группы пользователей.\nЭто позволяет протестировать работу обновления в реальных условиях с минимальным риском.\nЕсли канареечная, то есть новая, версия показывает стабильность, развертывание постепенно расширяется на всех пользователей.\nТакой подход обеспечивает контроль над рисками и позволяет быстро откатить изменения при обнаружении проблем.\nВы будете использовать следующие сервисы:\n- Виртуальные машины — сервис, в рамках которого предоставляется виртуальная машина.\n- Managed Kubernetes — сервис управления кластерами Kubernetes на вычислительных ресурсах облака.\n- Artifact Registry для хранения, совместного использования и управления Docker-образами и Helm-чартами.\n- Docker — система контейнеризации.\nШаги:\n1. Сгенерируйте ключевую пару и загрузите публичный ключ SSH в облако Cloud.ru Evolution.\n2. Создайте виртуальную машину и установите Docker.\n3. Соберите образ простого веб-приложения.\n4. Создайте приватный реестр в Artifact Registry и загрузите в него образ приложения.\n5. Создайте кластер Managed Kubernetes и подключите плагин Ingress Nginx.\n6. Разверните Blue-приложение.\n7. Реализуйте стратегию Blue-Green.\n8. Реализуйте стратегию Canary.\n\n## Перед началом работы\n1. Зарегистрируйтесь в личном кабинете Cloud.ru.\nЕсли вы уже зарегистрированы, войдите под своей учетной записью.\n2. Убедитесь, что у вас достаточно прав для создания реестра и загрузки артефактов в сервисе Artifact Registry.\n3. Создайте группу безопасности с правилами, разрешающими доступ по портам 8080 и 8081 для внешнего IP-адреса локальной машины.\nУзнайте адрес локальной машины через сервис https://www.myip.ru.\n\n## 1. Сгенерируйте ключевую пару и загрузите публичный ключ SSH в облако Cloud.ru Evolution\n1. Сгенерируйте ключевую пару SSH.\n2. Загрузите публичный ключ в облако Cloud.ru Evolution.\n\n## 2. Создайте виртуальную машину и установите Docker\n1. Создайте виртуальную машину с параметрами:\n- Гарантированная доля vCPU — 10%.\n- vCPU, шт. — 2.\n- RAM, ГБ — 4.\n- Загрузочный диск → Размер, ГБ — 30.\n- Сетевой интерфейс №1 — Подсеть с публичным IP.\n- Группы безопасности — группа, созданная перед началом работы.\n- Авторизация пользователя → Метод аутентификации — Публичный ключ и Пароль.\nВ списке виртуальных машин появится новая ВМ.\nПримерно через минуту ее статус должен измениться на «Запущена».\n2. Подключитесь к виртуальной машине через серийную консоль.\n3. Установите Docker на ВМ.\nДля этого в серийной консоли выполните команды:\n```\nsudo apt update -ysudo apt upgrade -ycurl -fsSL get.docker.com -o get-docker.sh && sh get-docker.shsudo groupadd dockersudo usermod -aG docker $USERnewgrp docker\n```\n4. Чтобы проверить, что Docker установлен и работает корректно, выполните команду:\n```\ndocker version\n```\n\n## 3. Соберите образ простого веб-приложения\n1. На ВМ создайте каталог с рабочим проектом deploy-lab:\n```\nmkdir ~/deploy-lab\n```\n2. В этом каталоге создайте еще два: blue-app и green-app:\n```\nmkdir ~/deploy-lab/blue-appmkdir ~/deploy-lab/green-app\n```\n3. В каталоге blue-app создайте файл index.html:\n```\nnano ~/deploy-lab/blue-app/index.html\n```\n4. В index.html добавьте код:\n```\n<!DOCTYPE html><html lang=\"ru\"><head>    <meta http-equiv=\"Cache-Control\" content=\"no-cache\">    <meta charset=\"UTF-8\">    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">    <title>Синий квадрат</title>    <style>        body {            margin: 0;            padding: 0;            display: flex;            justify-content: center;            align-items: center;            height: 100vh;            background-color: #f0f8ff;            font-family: Arial, sans-serif;        }        .blue-square {            width: 250px;            height: 250px;            background-color: #0066ff;            border-radius: 10px;            box-shadow: 0 0 20px rgba(0, 102, 255, 0.5);            display: flex;            justify-content: center;            align-items: center;            color: white;            font-size: 18px;            font-weight: bold;            text-align: center;        }    </style></head><body>    <div class=\"blue-square\">        Синяя версия 1.0<br>        This is the stable version of the application.    </div></body></html>\n```\n5. Создайте dockerfile:\n```\nnano ~/deploy-lab/blue-app/dockerfile\n```\n6. В dockerfile добавьте код:\n```\nFROM nginx:alpineCOPY index.html /usr/share/nginx/html/index.htmlRUN rm -f /usr/share/nginx/html/*.defaultEXPOSE 80\n```\n7. В каталоге green-app создайте файл index.html:\n```\nnano ~/deploy-lab/green-app/index.html\n```\n8. В index.html добавьте код:\n```\n<!DOCTYPE html><html lang=\"ru\"><head>    <meta http-equiv=\"Cache-Control\" content=\"no-cache\">    <meta charset=\"UTF-8\">    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">    <title>Зеленый квадрат</title>    <style>        body {            margin: 0;            padding: 0;            display: flex;            justify-content: center;            align-items: center;            height: 100vh;            background-color: #f0fff0;            font-family: Arial, sans-serif;        }        .green-square {            width: 250px;            height: 250px;            background-color: #00cc66;            border-radius: 10px;            box-shadow: 0 0 20px rgba(0, 204, 102, 0.5);            display: flex;            justify-content: center;            align-items: center;            color: white;            font-size: 18px;            font-weight: bold;            text-align: center;        }    </style></head><body>    <div class=\"green-square\">        Зеленая версия 2.0<br>        This is the new, updated version of the application!    </div></body></html>\n```\n9. Создайте dockerfile:\n```\nnano ~/deploy-lab/green-app/dockerfile\n```\n10. В dockerfile добавьте код:\n```\nFROM nginx:alpineCOPY index.html /usr/share/nginx/html/index.htmlRUN rm -f /usr/share/nginx/html/*.defaultEXPOSE 80\n```\n11. Соберите образы приложений:\n```\ndocker build -t blue-app:1.0 -f /home/<user>/deploy-lab/blue-app/dockerfile $HOME/deploy-lab/blue-app/docker build -t green-app:2.0 -f /home/<user>/deploy-lab/green-app/dockerfile $HOME/deploy-lab/green-app/\n```\n\nГде <user> — имя пользователя, которое указали при создании ВМ.\n12. Запустите контейнеры:\n```\ndocker run -d -p 8080:80 --name blue-container blue-app:1.0docker run -d -p 8081:80 --name green-container green-app:2.0\n```\n\nВ адресную строку браузера введите по очереди адреса:\n- http://<public-ip>:8080 — приложение «Синий квадрат»;\n- http://<public-ip>:8081 — приложение «Зеленый квадрат».\nГде <public-ip> — публичный IP-адрес, присвоенный ВМ при ее создании на шаге 2.\n\n## 4. Создайте приватный реестр в Artifact Registry и загрузите образ приложения\n1. Создайте приватный реестр и авторизуйтесь в нем.\nПрисвойте реестру название blue-green-canary-registry.\nНазвание реестра должно быть уникальным.\n2. Чтобы перетегировать ранее собранные образы и залить их в blue-green-canary-registry, выполните команды:\n```\ndocker tag blue-app:1.0 blue-green-canary-registry.cr.cloud.ru/blue-app:1.0docker tag green-app:2.0 blue-green-canary-registry.cr.cloud.ru/green-app:2.0docker push blue-green-canary-registry.cr.cloud.ru/blue-app:1.0docker push blue-green-canary-registry.cr.cloud.ru/green-app:2.0\n```\n\nВ результате этой операции образы blue-app и green-app появятся в Artifact Registry.\n\n## 5. Создайте кластер Managed Kubernetes и подключите плагин Ingress Nginx\n1. Создайте кластер Managed Kubernetes.\nКластер необходимо создавать в той же VPC, что и ВМ.\nОстальные параметры можно оставить по умолчанию.\nПри создании группы узлов укажите следующие параметры:\n- Гарантированная доля vCPU, % — 30.\n- CPU, шт. — 2.\n- RAM, ГБ — 4.\n- Объем хранилища — 30.\n- Количество узлов — 2.\nСоздание кластера занимает примерно пять минут.\n2. В кластер установите Ingress Nginx.\n3. Подключитесь к кластеру с ВМ.\n\n## 6. Разверните Blue-приложение\n1. В каталоге deploy-lab создайте манифест deploy-myapp-blue-v1.yaml:\n```\ncd ~/deploy-labnano deploy-myapp-blue-v1.yaml\n```\n2. Скопируйте в deploy-myapp-blue-v1.yaml код манифеста:\n```\napiVersion: apps/v1kind: Deploymentmetadata:  name: blue-appspec:  replicas: 3  selector:    matchLabels:      app: demo-app  template:    metadata:      labels:        app: demo-app        version: v1    spec:      containers:        - name: web          image: blue-green-canary-registry.cr.cloud.ru/blue-app:1.0          ports:            - containerPort: 80\n```\n\nГде blue-green-canary-registry.cr.cloud.ru/blue-app:1.0 — путь до образа, который был загружен в Artifact Registry.\n3. В этом же каталоге создайте файл svc-myapp-blue.yaml:\n```\nnano svc-myapp-blue.yaml\n```\n4. Скопируйте в файл svc-myapp-blue.yaml код манифеста:\n```\n# Сервис для основного приложения blue (v1)apiVersion: v1kind: Servicemetadata:  name: blue-app-servicespec:  selector:    app: demo-app    version: v1 # Добавляя этот лейбл, мы маршрутизируем трафик только на деплоймент myapp-blue  ports:    - protocol: TCP      port: 80      targetPort: 80  type: ClusterIP # Внутренний сервис для доступа изнутри кластера\n```\n5. В этом же каталоге создайте файл ingress-myapp.yaml с содержимым:\n```\n# Этот Ingress будет направлять внешний трафик к нашему сервисуapiVersion: networking.k8s.io/v1kind: Ingressmetadata:  name: demo-app-ingress  annotations:    nginx.ingress.kubernetes.io/rewrite-target: /spec:  ingressClassName: nginx  rules:    - http:        paths:          - path: /            pathType: Prefix            backend:              service:                name: blue-app-service                port:                  number: 80\n```\n6. Чтобы создать ресурсы Kubernetes, выполните команды:\n```\nkubectl apply -f deploy-myapp-blue-v1.yamlkubectl apply -f svc-myapp-blue.yamlkubectl apply -f ingress-myapp.yaml\n```\n7. Проверьте создание ресурсов:\n```\nkubectl get svc,pods,ingress\n```\nНа этом шаге мы организовали подачу трафика на стабильную версию приложения demo-app извне через Ingress-контроллер.\nЧтобы проверить работоспособность приложения, определите внешний IP Ingress-контроллера.\nДля этого используйте команду:\n```\nkubectl get svc -n=ingress\n```\n\nВ результате вы увидите информацию по External IP:\n```\nNAME                                 TYPE           CLUSTER-IP      EXTERNAL-IP    PORT(S)                      AGEingress-nginx-controller             LoadBalancer   10.104.209.33   XX.XXX.XXX.XX  80:30652/TCP,443:30796/TCP   7h\n```\n\nВведите в браузере http://<EXTERNAL-IP> и увидите отображаемую версию приложения.\n\n## 7. Реализуйте стратегию Blue-Green\n1. В каталоге deploy-lab создайте YAML-манифест Green-приложения:\n```\nnano deploy-myapp-green-v2.yaml\n```\n2. Скопируйте в deploy-myapp-green-v2.yaml код манифеста:\n```\n# Версия приложения на которую будем обновляться green (v2)apiVersion: apps/v1kind: Deploymentmetadata:  name: green-app # Важно: другое имя!spec:  replicas: 3  selector:    matchLabels:      app: demo-app  template:    metadata:      labels:        app: demo-app        version: v2    spec:      containers:        - name: web          image: blue-green-canary-registry.cr.cloud.ru/green-app:2.0 # лейбл новой версии v2          ports:            - containerPort: 80\n```\n3. В каталоге deploy-lab создайте svc-myapp-green.yaml:\n```\nnano svc-myapp-green.yaml\n```\n4. Скопируйте в svc-myapp-green.yaml код манифеста:\n```\n# Сервис для приложения, на которое будем переключаться - green (v2)apiVersion: v1kind: Servicemetadata:  name: green-app-servicespec:  selector:    app: demo-app    version: v2 # Добавляя этот лейбл, мы маршрутизируем трафик на сборку green (v2)  ports:    - protocol: TCP      port: 80      targetPort: 80  type: ClusterIP # Внутренний сервис для доступа изнутри кластера\n```\n5. Чтобы создать ресурсы Kubernetes, выполните команды:\n```\nkubectl apply -f deploy-myapp-green-v2.yamlkubectl apply -f svc-myapp-green.yaml\n```\n6. Проверьте создание ресурсов:\n```\nkubectl get svc,pods\n```\n7. Чтобы переключить трафик с версии приложения Blue (v1) на версию приложения Green (v2), внесите изменения в манифест ingress-myapp.yaml:\n```\n# Этот Ingress будет направлять трафик на основной сервис blue (v1) и в дальнейшем на green (v2) после обновленияapiVersion: networking.k8s.io/v1kind: Ingressmetadata:  name: demo-app-ingress  annotations:    nginx.ingress.kubernetes.io/rewrite-target: /spec:  ingressClassName: nginx  rules:    - http:        paths:          - path: /            pathType: Prefix            backend:              service:                name: green-app-service # Тут мы меняем имя сервиса и теперь трафик будет идти на сборку приложения green (v2)                port:                  number: 80\n```\n8. Примените внесенные изменения в манифесте:\n```\nkubectl apply -f ingress-myapp.yaml\n```\n\nТеперь трафик идет на сборку приложения Green (v2).\n9. Чтобы проверить изменения, обновите окно браузера, где раньше отображалось приложение с синим квадратом.\nТеперь отображается зеленый квадрат.\nТаким образом, мы осуществили переключение с одной версии приложения Blue (v1) на другую Green (v2).\nВ этом и заключается стратегия развертывания Blue-Green.\n\n## 8. Реализуйте стратегию Canary\n1. На ВМ в каталоге deploy-lab создайте файл deploy-canary.yaml с тем же образом, что и версия Green v2 — blue-green-canary-registry.cr.cloud.ru/green-app:2.0:\n```\ncd ~/deploy-labnano deploy-canary.yaml\n```\n2. Скопируйте в deploy-canary.yaml код манифеста:\n```\n# Версия canary - сюда будет постепенно перенаправляться весь трафикapiVersion: apps/v1kind: Deploymentmetadata:  name: demo-app-canaryspec:  replicas: 1 # Одна реплика для canary  selector:    matchLabels:      app: demo-app  template:    metadata:      labels:        app: demo-app        version: canary-v2 # Уникальная версия для canary    spec:      containers:        - name: web          image: blue-green-canary-registry.cr.cloud.ru/green-app:2.0 # оставляем тот же образ green-app 2.0          ports:            - containerPort: 80\n```\n3. В каталоге deploy-lab создайте файл svc-canary.yaml:\n```\nnano svc-canary.yaml\n```\n4. Скопируйте в svc-canary.yaml код манифеста:\n```\napiVersion: v1kind: Servicemetadata:  name: canary-servicespec:  selector:    app: demo-app    version: canary-v2 # добавляя этот лейбл мы маршрутизируем трафик только на деплоймент canary  ports:    - protocol: TCP      port: 80      targetPort: 80  type: ClusterIP # Внутренний сервис для доступа изнутри кластера\n```\n5. В каталоге deploy-lab создайте файл ingress-canary.yaml:\n```\nnano ingress-canary.yaml\n```\n6. Скопируйте в ingress-canary.yaml код манифеста:\n```\n# Этот Ingress будет управлять распределением трафика между основным и канареечным развертываниямиapiVersion: networking.k8s.io/v1kind: Ingressmetadata:  name: ingress-canary  annotations:    nginx.ingress.kubernetes.io/rewrite-target: /    nginx.ingress.kubernetes.io/canary: \"true\"    nginx.ingress.kubernetes.io/canary-weight: \"10\" # Направляем 10% трафика на canaryspec:  ingressClassName: nginx  rules:    - http:        paths:          - path: /            pathType: Prefix            backend:              service:                name: canary-service                port:                  number: 80\n```\n7. Чтобы создать ресурсы Kubernetes, выполните команды:\n```\nkubectl apply -f deploy-canary.yamlkubectl apply -f svc-canary.yamlkubectl apply -f ingress-canary.yaml\n```\n8. Проверьте создание ресурсов:\n```\nkubectl get svc,pods,ingress\n```\n9. Чтобы убедиться, что трафик обеспечен на основное приложение Blue (v1), измените Service в ingress-myapp.yaml:\n```\n# Этот Ingress будет направлять внешний трафик к нашему сервисуapiVersion: networking.k8s.io/v1kind: Ingressmetadata:  name: demo-app-ingress  annotations:    nginx.ingress.kubernetes.io/rewrite-target: /spec:  ingressClassName: nginx  rules:    - http:        paths:          - path: /            pathType: Prefix            backend:              service:                name: blue-app-service                port:                  number: 80\n```\n10. Примените манифест:\n```\nkubectl apply -f ingress-myapp.yaml\n```\n\nБлагодаря такой архитектуре большая часть трафика по-прежнему идет на синюю версию приложения, но 10% трафика теперь идет на зеленое приложение.\nЧтобы проверить это, введите в адресную строку браузера IP-адрес Ingress и несколько раз обновите браузер.\nВы увидите, что примерно в 10% случаев отображается зеленая версия приложения, а в остальных случаях — синяя.\nТо есть через Ingress-Canary мы задали правило распределения трафика в обе версии приложения: 90% в синее и 10% в зеленое.\nМеняя настройки Ingress-Canary, можно регулировать объем трафика, идущий на Canary-приложение.\n11. Чтобы направить 50% трафика на версию приложения Canary, измените правило Ingress-Canary в ingress-canary.yaml:\n```\n# Этот Ingress будет управлять распределением трафика между основным и канареечным развертываниямиapiVersion: networking.k8s.io/v1kind: Ingressmetadata:  name: ingress-canary  annotations:    nginx.ingress.kubernetes.io/rewrite-target: /    nginx.ingress.kubernetes.io/canary: \"true\"    nginx.ingress.kubernetes.io/canary-weight: \"50\" # Направляем 50% трафика на canaryspec:  ingressClassName: nginx  rules:    - http:        paths:          - path: /            pathType: Prefix            backend:              service:                name: canary-service                port:                  number: 80\n```\n12. Примените изменение:\n```\nkubectl apply -f ingress-canary.yaml\n```\n13. Чтобы проверить перенаправление трафика, введите в адресную строку браузера IP-адрес Ingress и несколько раз обновите браузер.\nВы увидите, что теперь примерно в половине случаев отображается зеленая версия приложения и половине — синяя.\n14. Чтобы направить 100% трафика на версию приложения Canary, измените правило Ingress-Canary в ingress-canary.yaml:\n```\n# Этот Ingress будет управлять распределением трафика между основным и канареечным развертываниямиapiVersion: networking.k8s.io/v1kind: Ingressmetadata:  name: ingress-canary  annotations:    nginx.ingress.kubernetes.io/rewrite-target: /    nginx.ingress.kubernetes.io/canary: \"true\"    nginx.ingress.kubernetes.io/canary-weight: \"100\" # Направляем весь трафик на canaryspec:  ingressClassName: nginx  rules:    - http:        paths:          - path: /            pathType: Prefix            backend:              service:                name: canary-service                port:                  number: 80\n```\n15. Примените изменение:\n```\nkubectl apply -f ingress-canary.yaml\n```\nТеперь при обновлении браузера мы видим только Canary-версию приложения.\nТаким образом, мы обновили наше приложение, подавая сначала трафик одновременно на текущую версию приложения Blue и новую версию Canary.\nВ итоге мы перенесли 100% трафика на приложение Canary, тем самым реализовав стратегию развертывания Canary.\n\n## Результат\nВы научились работать с продвинутыми стратегиями развертывания контейнерных приложений Blue-Green Deployment и Canary Deployment в управляемом кластере Managed Kubernetes на платформе Cloud.ru Evolution.\nЭти методы позволяют обновлять приложения более управляемо и безопасно, сводя к минимуму простои и риски, связанные с внедрением новых версий.\n\n  [© 2025 Cloud.ru](https://cloud.ru)",
      "debug": {
        "start_page": 1,
        "end_page": 1
      }
    }
  ]
}