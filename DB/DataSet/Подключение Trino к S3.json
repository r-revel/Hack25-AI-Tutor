{
  "title": "Подключение Trino к S3",
  "chapters": [
    {
      "name": "Подключение Trino к S3",
      "content": "Практические руководства Evolution    \n\n # Подключение Trino к S3   Эта статья полезна?          \nВ этом руководстве мы рассмотрим:\n- сценарий взаимодействия между Managed Trino, Managed Metastore и Object Storage;\n- отправку запросов через DBeaver;\n- работу с управляемыми таблицами;\n- работу с внешними таблицами.\nВнимание Все сущности должны располагаться в одной VPC и подсетях одного типа.\n\n## Перед началом работы\n1. Зарегистрируйтесь в личном кабинете Cloud.ru.\nЕсли вы уже зарегистрированы, войдите под своей учетной записью.\n2. Ознакомьтесь с разделом Управляемые и внешние таблицы.\nВ следующих блоках вам будут встречаться термины «Управляемые таблицы» и «Внешние таблицы».\n3. (Опционально) Cоздайте публичный SNAT-шлюз, если необходим доступ в интернет.\n4. Создайте бакет Object Storage, в котором будут храниться таблицы и схемы.\n5. Создайте секреты в сервисе Secret Management для доступа к Object Storage.\nПонадобится сохранить идентификатор ключа доступа (access key) и секретный ключ доступа (key secret).\n6. Настройте DNS-сервер и подсеть.\n7. Создайте кластер Data Platform, в котором будет размещен инстанс.\nНазовите кластер «dp-labs».\n8. Скачайте и установите root-сертификат на устройство.\n9. Установите JDBC-клиент DBeaver.\n\n## Создайте инстанс Managed Metastore\n1. Перейдите в раздел Evolution и выберите сервис Managed Metastore.\n2. Откройте раздел Инстансы.\n3. Нажмите Создать инстанс.\n4. В блоке Общие параметры заполните поля следующими значениями:\n- Название — metastore-lab.\n- Кластер — dp-labs.\n- Лог-группа — группа логов.\n- Файловая система — S3.\n- Источник — Object Storage.\n- Бакет — созданный бакет Object Storage.\n5. Нажмите Продолжить.\n6. В блоке Сетевые настройки выберите:\n- Зона доступности — зону доступности, для которой создан SNAT-шлюз.\n- Подсеть — подсеть с DNS-сервером.\n7. Нажмите Создать.\n8. Дождитесь, когда статус инстанса изменится на «Готов».\n9. Нажмите Скопировать Thrift URL.\n\n## Создайте каталог Metastore\n1. Перейдите в раздел Evolution и выберите сервис Managed Metastore.\n2. Откройте раздел Каталоги.\n3. Нажмите Создать каталог.\n4. Заполните поля следующими значениями:\n- Название — metastore_lab;\n- Коннектор — Metastore;\n- Thrift URL — Thrift URL, скопированный с карточки Metastore;\n- Эндпоинт — https://s3.cloud.ru;\n- Идентификатор ключа доступа — access key, выбирается из Secret Management;\n- Секретный ключ доступа — secret key, выбирается из Secret Management;\n- Регион S3 — ru-central-1.\n5. Нажмите Создать.\nНа странице Managed Trino на вкладке Каталоги появится запись с названием «metastore_lab».\n\n## Создайте инстанс Trino\n1. Перейдите в раздел Evolution и выберите сервис Managed Trino.\n2. Откройте раздел Инстансы.\n3. Нажмите Создать инстанс.\n4. В блоке Общие параметры заполните поля следующими значениями:\n- Название — trino-lab-2.\n- Вычислительные ресурсы — vCPU 4, RAM 16.\n- Количество нод — 3.\n- Каталоги — выберите из списка каталог Metastore с названием «metastore_lab».\n5. Нажмите Продолжить.\n6. В блоке Сетевые настройки выберите:\n- Зона доступности — зону доступности, для которой создан SNAT-шлюз.\n- Подсеть — подсеть с DNS-сервером, в которой расположен инстанс Managed Metastore.\n- Группа безопасности — группу безопасности.\n- Пользователь — введите имя пользователя.\n- Пароль — секретный ключ.\n- Подключить публичный хост — активируйте переключатель.\n7. Нажмите Создать.\n8. Дождитесь, когда статус инстанса изменится на «Готов».\n9. Откройте карточку инстанса Trino.\nИнформация из него понадобится на следующих этапах.\n\n## Подключите Trino к DBeaver\n\n### Добавьте сертификат в Java KeyStore\n1. Запустите терминал и перейдите в директорию, где хотите сохранить JKS-файл.\n2. Введите команду:\n```\nkeytool -importcert  -alias cloudru-root  -file <PATH>/dp-cert.crt  -keystore <PATH>/cloudru-truststore.jks  -storetype JKS  -storepass <YOUR-PASSWORD>  -noprompt\n```\n\n- В строке -file вместо <PATH> укажите путь до скачанного ранее root-сертификата.\n- В строке -keystore вместо <PATH> укажите путь до места, где будет храниться JKS-файл.\nСохраните путь.\nОн понадобится при добавлении JKS-файла в DBeaver.\n- В строке -storepass вместо <YOUR-PASSWORD> задайте пароль для сертификата.\nСохраните пароль.\nОн понадобится при добавлении JKS-файла в DBeaver.\n\n### Подключите DBeaver\n1. Откройте приложение DBeaver.\n2. В панели сверху нажмите База данных → Новое соединение.\n3. В списке соединений выберите Trino.\n4. Нажмите Далее заполните поля на вкладке Главное:\n- Хост — публичный хост, указанный в карточке инстанса.\n- Порт — порт, указанный в карточке инстанса.\n- Пользователь — пользователь, указанный в карточке инстанса.\n- Пароль — пароль, указанный в карточке инстанса.\n5. На вкладке Свойства драйвера измените значение свойства SSL на true.\n6. Нажмите Тест соединения.\n7. Нажмите Готово.\nСлева в списке объектов появится база данных Metastore с названием «metastore_lab».\n\n## Работа с управляемыми таблицами\nSQL-запросы в следующих шагах мы будем отправлять через DBeaver.\nПримечание Ознакомьтесь с разделом Управляемые и внешние таблицы перед началом.\n\n### Управляемая таблица в формате .orc\n1. Создайте схему.\n```\nCREATE SCHEMA IF NOT EXISTS metastore_lab.my_company\n```\n\nВ S3 автоматически создастся каталог warehouse и каталог со схемой my_company.db.\n2. Создайте таблицу.\n```\nCREATE TABLE IF NOT EXISTS metastore_lab.my_company.employees (id_employee INT, email VARCHAR(255))\n```\n\nВ S3 создастся каталог employees.\n3. Заполните таблицу.\n```\nINSERT INTO metastore_lab.my_company.employees values (1, 'xxx@example.com'), (2, 'yyy@example.com'), (3, 'zzz@example.com')\n```\n4. Проверьте результат.\n```\nSELECT * FROM metastore_lab.my_company.employees\n```\n\nВ S3 появится файл в формате .orc.\n5. Удалите таблицу.\n```\nDROP TABLE metastore_lab.my_company.employees\n```\nВ результате таблица удалена из Metastore, в S3 все данные вместе с каталогом employees также удалены.\n\n### Управляемая таблица в текстовом формате\n1. Создайте схему.\n```\nCREATE SCHEMA IF NOT EXISTS metastore_lab.my_company\n```\n\nВ S3 автоматически создастся каталог warehouse и каталог со схемой my_company.db.\n2. Сохраните данные в текстовом формате.\n```\nCREATE TABLE IF NOT EXISTS metastore_lab.my_company.employees_csv (id_employee INT, email VARCHAR(255))WITH (format = 'TEXTFILE')\n```\n3. Заполните таблицу.\n```\nINSERT INTO metastore_lab.my_company.employees_csv values (1, 'xxx@example.com'), (2, 'yyy@example.com'), (3, 'zzz@example.com')\n```\n4. Проверьте результат.\n```\nSELECT * FROM metastore_lab.my_company.employees_csv\n```\n\nВ S3 появится файл в формате .gz.\n5. Удалите таблицу.\n```\nDROP TABLE metastore_lab.my_company.employees_csv\n```\nВ результате таблица удалена из Metastore, в S3 все данные вместе с каталогом employees_csv также удалены.\n\n## Работа с внешними таблицами\n1. Откройте бакет S3.\n2. Создайте каталог с названием data.\n3. Подготовьте файл с данными в формате .csv:\n- колонки: id, email\n- значения в колонке id: 1, 2, 3\n- значения в колонке email: xxx@example.com, yyy@example.com, zzz@example.com\n4. Добавьте файл в каталог «data» на S3.\n5. Запустите DBeaver.\n6. Через DBeaver создайте схему.\n```\nCREATE SCHEMA IF NOT EXISTS metastore_lab.my_company\n```\n7. Создайте таблицу.\n```\nCREATE TABLE IF NOT EXISTS metastore_lab.my_company.csv_external (id VARCHAR, email VARCHAR)WITH (   external_location = 's3a://bucket-4b8dce/data',   format = 'CSV',   csv_separator = ';',   skip_header_line_count = 1)\n```\n8. Проверьте результат.\n```\nSELECT * FROM metastore_lab.my_company.csv_external\n```\n9. Подготовьте новый файл с данными в формате .csv:\n- колонки: id, email\n- значения в колонке id: 4, 5, 6\n- значения в колонке email: aaa@example.com, bbb@example.com, ccc@example.com\n10. Добавьте файл в каталог «data» на S3.\nВ этом сценарии мы имитируем поступление новых данных из другой системы.\n11. Проверьте результат.\n```\nSELECT * FROM metastore_lab.my_company.csv_external\n```\n\nСистема считывает данные из двух разных файлов с одинаковой структурой и с одинаковым разрешением, как если бы это был один файл.\n12. Удалите таблицу.\n```\nDROP TABLE metastore_lab.my_company.csv_external\n```\nВ результате таблица удалена из Metastore.\nВ отличие от управляемых таблиц файлы в S3 остаются доступными.\n\n  [© 2025 Cloud.ru](https://cloud.ru)",
      "debug": {
        "start_page": 1,
        "end_page": 1
      }
    }
  ]
}