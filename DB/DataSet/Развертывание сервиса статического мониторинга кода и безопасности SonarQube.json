{
  "title": "Развертывание сервиса статического мониторинга кода и безопасности SonarQube",
  "chapters": [
    {
      "name": "Развертывание сервиса статического мониторинга кода и безопасности SonarQube",
      "content": "Практические руководства Evolution    \n\n # Развертывание сервиса статического мониторинга кода и безопасности SonarQube   Эта статья полезна?          \nС помощью этого руководства вы развернете платформу статического анализа кода SonarQube в облаке Cloud.ru для автоматической проверки качества и безопасности кода.\n \n Как SonarQube может помочь команде разработки \n \nВы создадите инфраструктуру, подключите SonarQube к управляемой базе данных Managed PostgreSQL®, опубликуете сервис через Nginx с автоматическим выпуском сертификатов Let’s Encrypt и обеспечите безопасный доступ по HTTPS.\nТакже вы подключите репозиторий из GitVerse и настроите пайплайн CI/CD, запускающий анализ кода в SonarQube при каждом commit и pull request.\nДополнительно вы интегрируете SonarQube с IDE VS Code для локального статического анализа кода во время разработки.\nВ результате вы получите готовый сервис анализа качества кода, изолированный в собственной VPC, доступный из интернета и встроенный в рабочий процесс разработки.\nВы будете использовать следующие сервисы:\n- Виртуальные машины — сервис, в рамках которого предоставляется виртуальная машина для размещения приложения.\n- Публичный IP-адрес для доступа к сервису через интернет.\n- Managed PostgreSQL — управляемая база данных PostgreSQL.\n- VPC — изолированная виртуальная сеть для создания безопасной инфраструктуры.\n- Бесплатный сервис nip.io для получения публичного доменного имени и сертификата.\nВы также можете использовать собственное зарегистрированное доменное имя и SSL-сертификат для организации доступа.\n- Nginx — веб-сервер для проксирования запросов и организации защищeнного HTTPS-доступа к приложению.\n- Let’s Encrypt — сервис для автоматического получения бесплатного SSL-сертификата.\n- GitVerse — платформа для совместной работы с исходным кодом.\n- (Опционально) SonarQube for IDE — расширение для подключения SonarQube к редактору Visual Studio Code.\nШаги:\n1. Определите необходимую инфраструктуру для вашего проекта.\n2. Разверните ресурсы в облаке.\n3. Настройте окружение виртуальной машины.\n4. Настройте защищенный доступ через Nginx.\n5. Разверните и запустите SonarQube.\n6. Отключите SSH-доступ.\n7. Подключите SonarQube к репозиторию в GitVerse.\n8. (Опционально) Подключите SonarQube к Visual Studio Code.\n\n## Перед началом работы\n1. Зарегистрируйтесь в личном кабинете Cloud.ru.\nЕсли вы уже зарегистрированы, войдите под своей учетной записью.\n2. Сгенерируйте ключевую пару и загрузите публичный ключ в Cloud.ru Evolution.\n3. Создайте учетную запись в GitVerse, если не сделали этого ранее.\nПримеры кода в практическом руководстве размещаются в GitVerse.\n4. (Опционально) Скачайте и установите Visual Studio Code для выполнения шага 8.\n\n## 1. Определите необходимую инфраструктуру для вашего проекта\nОпределите необходимые конфигурации виртуальной машины и кластера Managed PostgreSQL®, исходя из минимально рекомендованных значений.\n Размер команды Виртуальная машина Кластер Managed PostgreSQL®Небольшая команда разработки или тестовая среда:- 1–10 разработчиков;\n- 1–20 проектов;\n- кодовая база до 1 млн строк.- CPU: 2 vCPU\n- RAM: 4 ГБ\n- SSD: 30–50 ГБ- Режим: Стандарт\n- Тип: Single\n- CPU: 2 vCPU\n- RAM: 4 ГБ\n- SSD: 50–100 ГБ Средняя команда или промышленная среда:- 10–50 разработчиков;\n- 20–100 проектов;\n- кодовая база — 1–10 млн строк.- CPU: 4 vCPU\n- RAM: 8 ГБ\n- SSD: 100–200 ГБ- Режим: Бизнес\n- Тип: Single\n- CPU: 4 vCPU\n- RAM: 8 ГБ\n- SSD: 100–500 ГБ Большая команда — корпоративное решение:- 50–200 разработчиков;\n- 100–500 проектов;\n- кодовая база — 10–50 млн строк.- CPU: 8 vCPU\n- RAM: 16 ГБ\n- SSD: 200–500 ГБ- Режим: Бизнес\n- Тип: Master/Replica\n- CPU: 8 vCPU\n- RAM: 16 ГБ\n- SSD: 500–1 000 ГБ\n\n## 2. Разверните ресурсы в облаке\nНа этом шаге вы подготовите сеть, группу безопасности, виртуальную машину и кластер Managed PostgreSQL®.\nВсе ресурсы будут расположены в одной VPC, что обеспечит сетевую изоляцию.\n1. Создайте виртуальную сеть с названием sonarqube-VPC.\n2. Создайте подсеть со следующими параметрами:\n- Название — sonarqube-subnet.\n- VPC — sonarqube-VPC.\n- Адрес — 10.10.1.0/24.\n- DNS-серверы — 8.8.8.8.\n3. Создайте группу безопасности с названием sonarqube и добавьте в нее правила:\n Трафик Протокол Порт Тип источника/адресата Источник/Адресат ВходящийTCP443IP-адрес0.0.0.0/0ВходящийTCP80IP-адрес0.0.0.0/0Исходящий Любой Оставьте пустымIP-адрес0.0.0.0/0\n4. Создайте виртуальную машину со следующими параметрами:\n- Название — sonarqube.\n- Образ — публичный образ Ubuntu 22.04.\n- Сетевой интерфейс — выберите тип Подсеть с публичным IP.\n- VPC — sonarqube-VPC.\n- Подсеть — sonarqube-subnet.\n- Публичный IP — оставьте Арендовать новый или выберите IP-адрес из списка арендованных.\n- Группы безопасности — добавьте sonarqube.\n- Логин — sonarqube.\n- Метод аутентификации — Публичный ключ и Пароль.\n- Публичный ключ — укажите ключ, созданный ранее.\n- Пароль — задайте пароль пользователя.\n- Имя хоста — sonarqube.\n- Остальные параметры оставьте по умолчанию или выберите на свое усмотрение.\n5. Создайте кластер Managed PostgreSQL со следующими параметрами:\n- Имя кластера — sonarqube.\n- Название базы данных — sonarqube_db.\n- Версия PostgreSQL — 16.\n- Подсеть — sonarqube-subnet.\n- Остальные параметры оставьте по умолчанию или выберите на свое усмотрение.\nУбедитесь, что ресурсы созданы и отображаются в личном кабинете:\n1. На странице Сети → VPC отображается сеть sonarqube-VPC, а в списке ее подсетей — sonarqube-subnet.\n2. На странице Сети → Группы безопасности отображается группа безопасности sonarqube со статусом «Создана».\n3. На странице Инфраструктура → Виртуальные машины отображается виртуальная машина sonarqube со статусом «Запущена».\n4. На странице Базы данных → Managed PostgreSQL® отображается кластер sonarqube со статусом «Доступен».\n\n## 3. Настройте окружение виртуальной машины\nНа этом шаге вы установите необходимые пакеты и подготовите среду для SonarQube.\n1. Подключитесь к виртуальной машине по SSH.\n2. Обновите систему и установите утилиты:\n```\nsudo apt update && sudo apt upgrade -y\n```\n3. Установите и запустите Nginx:\n```\nsudo apt install nginx -ysudo systemctl enable nginxsudo systemctl start nginx\n```\n4. Установите Let’s Encrypt и плагин для Nginx:\n```\nsudo apt install certbot python3-certbot-nginx -y\n```\n5. Установите Docker и Docker Compose:\n```\ncurl -fsSL https://get.docker.com -o get-docker.shsudo sh get-docker.shsudo apt install docker compose -y\n```\n6. Добавьте текущего пользователя виртуальной машины в группу Docker:\n1. Выполните команду:\n```\nsudo usermod -aG docker $USERnewgrp docker\n```\n2. Перезагрузите систему.\n3. Проверьте работоспособность Docker:\n```\ndocker run hello-world\n```\n\nПоявится сообщение, подтверждающее успешность установки и настройки.\nПримечаниеВ некоторых случаях права на использование Docker без префикса sudo не сохраняются и командная строка возвращает ошибку permission denied.\nВ этом случае вы можете продолжить работу с Docker, добавляя в начало каждой команды префикс sudo.\n7. Настройте системные параметры для SonarQube.\nДля стабильной работы SonarQube требуются повышенные значения параметров ядра vm.max_map_count, fs.file-max и пользовательских лимитов на количество открытых файлов (open files) и потоков (threads).\nВ противном случае компонент Elasticsearch, используемый в SonarQube, не сможет создать необходимое количество отображений памяти (memory mappings) и файловых дескрипторов, что приведет к ошибкам при запуске и аварийному завершению анализа.\nНастройка этих параметров с помощью sysctl и limits.conf обеспечивает их сохранение на уровне ядра и пользовательских лимитов.\nЭто гарантирует, что при каждой загрузке операционной системы SonarQube будет автоматически получать требуемые ресурсы.\n1. Настройте параметры ядра:\n```\nsudo sysctl -w vm.max_map_count=262144sudo sysctl -w fs.file-max=65536\n```\n2. Задайте постоянное применение этих параметров:\n```\necho 'vm.max_map_count=262144' | sudo tee -a /etc/sysctl.confecho 'fs.file-max=65536' | sudo tee -a /etc/sysctl.conf\n```\n3. Укажите лимиты:\n```\necho 'sonarqube - nofile 65536' | sudo tee -a /etc/security/limits.confecho 'sonarqube - nproc 4096' | sudo tee -a /etc/security/limits.conf\nulimit -n 65536ulimit -u 4096\n```\n\n## 4. Настройте защищенный доступ через Nginx\nНа этом шаге вы зарегистрируете доменное имя, настроите Nginx в качестве защищенного прокси, получите SSL-сертификат и ограничите доступ через межсетевой экран.\n1. Создайте конфигурационный файл Nginx:\n```\nsudo nano /etc/nginx/sites-available/sonarqube.conf\n```\n2. Вставьте код, заменив <ip_address> на значение публичного IP-адреса виртуальной машины:\n```\nserver {    listen 80;    server_name sonar.<ip_address>.nip.io www.sonar.<ip_address>.nip.io;\nlocation / {   proxy_pass http://127.0.0.1:9000;   proxy_set_header Host $host;   proxy_set_header X-Real-IP $remote_addr;   proxy_set_header X-Forwarded-Proto $scheme;}}\n```\n3. Сконфигурируйте межсетевой экран:\n```\nsudo ufw allow OpenSSHsudo ufw allow 'Nginx Full'sudo ufw enable\n```\n4. Активируйте конфигурацию и перезапустите Nginx:\n```\nsudo ln -sf /etc/nginx/sites-available/sonarqube.conf /etc/nginx/sites-enabled/sonarqube.confsudo rm -f /etc/nginx/sites-enabled/defaultsudo nginx -tsudo systemctl reload nginx\n```\n5. Выпустите SSL-сертификат:\n```\nsudo certbot --nginx -d sonar.<ip_address>.nip.io --redirect --agree-tos -m <email>\n```\n\nГде:\n- <ip_address> — публичный IP-адрес виртуальной машины.\n- <email> — email для регистрации сертификата.\n6. Перейдите по адресу https://sonar.<ip_address>.nip.io и убедитесь, что браузер отмечает соединение как безопасное.\n\n## 5. Установите и запустите SonarQube\nНа этом шаге вы установите SonarQube, настроите подключение к базе данных и запустите сервис через Docker Compose.\n1. Создайте директорию проекта и перейдите в нее:\n```\nmkdir sonarqube-deploymentcd sonarqube-deployment\n```\n2. Создайте файл docker-compose.yml:\n```\nnano docker-compose.yml\n```\n3. Добавьте следующую конфигурацию:\n```\nservices:   sonarqube:      image: sonarqube:25.8.0.112029-community      container_name: sonarqube      restart: unless-stopped      ports:         - \"9000:9000\"      environment:         - SONAR_JDBC_URL=jdbc:postgresql://<postgres_ip>:5432/sonarqube_db         - SONAR_JDBC_USERNAME=<postgres_admin_user>         - SONAR_JDBC_PASSWORD=<postgres_admin_password>         - SONAR_ES_BOOTSTRAP_CHECKS_DISABLE=true      volumes:         - sonarqube_data:/opt/sonarqube/data         - sonarqube_extensions:/opt/sonarqube/extensions         - sonarqube_logs:/opt/sonarqube/logs      ulimits:         nproc: 131072         nofile:            soft: 8192            hard: 131072\nvolumes:   sonarqube_data:   sonarqube_extensions:   sonarqube_logs:\n```\n\nГде:\n- <postgres_admin_user> — имя пользователя кластера Managed PostgreSQL®.\n- <postgres_admin_password> — пароль указанного пользователя.\n- <postgres_ip> — приватный IP-адрес кластера.\n4. Запустите контейнеры:\n```\ndocker compose up -d\n```\n5. Проверьте статус контейнеров:\n```\ndocker compose psdocker compose logs -f sonarqube\n```\n6. Перейдите по адресу https://sonar.<ip_address>.nip.io и войдите в панель администратора, используя временные логин и пароль admin.\n7. Смените пароль администратора.\n\n## 6. Отключите SSH-доступ\nКогда вы развернули и настроили сервис, закройте доступ по SSH для повышения безопасности.\n1. В личном кабинете на верхней панели слева нажмите  и выберите Инфраструктура → Виртуальные машины.\n2. В списке виртуальных машин выберите sonarqube.\n3. Перейдите на вкладку Сетевые параметры.\n4. В блоке сетевого интерфейса нажмите  и выберите Изменить группы безопасности.\n5. Удалите группу SSH-access_ru и сохраните изменения.\n6. Убедитесь, что доступа нет — попробуйте подключиться к виртуальной машине по SSH.\nПосле отключения доступа по SSH, администрирование сервиса будет доступно через серийную консоль виртуальной машины.\n\n## 7. Подключите SonarQube к репозиторию в GitVerse\nНа этом шаге вы подключите SonarQube к проекту, размещенному в GitVerse, через CI/CD процесс.\n1. Склонируйте репозиторий с приложением в GitVerse.\n2. Перейдите в SonarQube по адресу https://sonar.<ip_address>.nip.io/projects.\n3. Нажмите Create Project → Local.\n4. Создайте проект со следующими значениями:\n- Project display name — evo-virtual-machine-sonarqube-lab.\n- Project key — evo-virtual-machine-sonarqube-lab.\n- Main branch name — master.\n5. Нажмите Next.\n6. Выберите значение Use the global setting.\n7. Нажмите Create project.\n8. В параметре Analysis Method выберите With GitHub Actions.\n9. Нажмите Generate a token и скопируйте сгенерированный токен.\n10. Добавьте секреты в GitVerse репозиторий:\n- SONAR_TOKEN;\n- SONAR_HOST_URL.\n11. Убедитесь, что сборка CI/CD прошла успешно.\nЕсли сборка неуспешная, нажмите Перезапустить все джобы.\n12. Перейдите в SonarQube по адресу https://sonar.<ip_address>.nip.io/projects и откройте проект evo-virtual-machine-sonar-qube-lab.\n13. Посмотрите на отчет, проанализируйте найденные проблемы.\n\n## 8. Подключите SonarQube к Visual Studio Code\nНа этом шаге вы подключите сервер SonarQube к проекту в IDE Visual Studio Code для получения подсказок в коде.\n1. Откройте Visual Studio Code.\n2. Склонируйте репозиторий с примером в GitVerse.\n3. Откройте репозиторий с кодом примера evo-virtual-machine-sonarqube-lab в Visual Studio Code.\n4. Установите расширение SonarQube for IDE для подключения SonarQube к редактору Visual Studio Code.\n5. В левом меню Visual Studio Code нажмите на расширение SonarQube Setup.\n6. Нажмите Connect to SonarQube Server.\n7. В параметре Server URL введите значение https://sonar.<ip_address>.nip.io.\n8. Нажмите Generate Token.\n9. В открывшемся окне браузера подтвердите соединение и скопируйте токен.\n10. Вставьте скопированное значение в User Token.\n11. Нажмите Save connection.\n12. Нажмите кнопку + в меню SonarQube Setup.\n13. Выберите проект evo-virtual-machine-sonarqube-lab в выпадающем меню.\n14. Откройте файл health-check.service.ts в Visual Studio Code и проверьте, что в строке 23 подсвечена ошибка.\nТакая же ошибка отображается в результатах анализа проекта в SonarQube.\n\n## Результат\nВы развернули изолированную облачную инфраструктуру с SonarQube, подключенной к управляемой базе Managed PostgreSQL®, опубликовали сервис через Nginx с автоматическим выпуском TLS-сертификатов Let’s Encrypt и обеспечили доступ по HTTPS.\nВы подключили репозиторий из Git, настроили CI/CD-пайплайн для автоматического анализа кода при каждом commit и интегрировали SonarQube с VS Code для локального статического анализа.\nТаким образом, вы освоили ключевые практики DevSecOps и получили защищенный, полностью автоматизированный сервис контроля качества и безопасности кода.\n\n  [© 2025 Cloud.ru](https://cloud.ru)",
      "debug": {
        "start_page": 1,
        "end_page": 1
      }
    }
  ]
}