{
  "title": "Развертывание Identity Provider Keycloak на виртуальной машине и Managed PostgreSQL®",
  "chapters": [
    {
      "name": "Развертывание Identity Provider Keycloak на виртуальной машине и Managed PostgreSQL®",
      "content": "Практические руководства Evolution    \n\n # Развертывание Identity Provider Keycloak на виртуальной машине и Managed PostgreSQL®   Эта статья полезна?          \nС помощью этого руководства вы развернете Identity Provider Keycloak в облаке для централизованной аутентификации пользователей.\nВы создадите инфраструктуру, настроите подключение к управляемой базе данных Managed PostgreSQL®, опубликуете сервис через Nginx и обеспечите безопасный доступ по HTTPS.\nВ результате вы получите готовый сервис аутентификации, полностью изолированный в собственной VPC и доступный из интернета.\nВы будете использовать следующие сервисы:\n- Виртуальные машины — сервис, в рамках которого предоставляется виртуальная машина для размещения приложения.\n- Публичный IP-адрес для доступа к сервису через интернет.\n- Managed PostgreSQL — управляемая база данных PostgreSQL.\n- VPC — изолированная виртуальная сеть для создания безопасной инфраструктуры.\n- Бесплатный сервис nip.io для получения публичного доменного имени и сертификата.\nВы также можете использовать собственное зарегистрированное доменное имя и SSL-сертификат для организации доступа.\n- Nginx — веб-сервер для проксирования запросов и организации защищeнного HTTPS-доступа к приложению.\n- Let’s Encrypt — сервис для автоматического получения бесплатного SSL-сертификата.\nШаги:\n1. Разверните ресурсы в облаке.\n2. Настройте окружение виртуальной машины.\n3. Настройте защищенный доступ через Nginx.\n4. Разверните и запустите Keycloak.\n5. Отключите SSH-доступ.\n\n## Перед началом работы\n1. Зарегистрируйтесь в личном кабинете Cloud.ru.\nЕсли вы уже зарегистрированы, войдите под своей учетной записью.\n2. Сгенерируйте ключевую пару и загрузите публичный ключ в Cloud.ru Evolution.\n\n## 1. Разверните ресурсы в облаке\nНа этом шаге вы подготовите сеть, группу безопасности, виртуальную машину и кластер Managed PostgreSQL®.\nВсе ресурсы будут расположены в одной VPC, что обеспечит сетевую изоляцию.\n1. Создайте виртуальную сеть с названием identity-provider-VPC.\n2. Создайте подсеть со следующими параметрами:\n- Название — identity-provider-subnet.\n- VPC — identity-provider-VPC.\n- Адрес — 10.10.1.0/24.\n- DNS-серверы — 8.8.8.8.\n3. Создайте новую группу безопасности со следующими параметрами:\n1. Укажите Название группы безопасности, например identity-provider-sg.\n2. Добавьте правила входящего и исходящего трафика.\n Трафик Протокол Порт Тип источника/адресата Источник/Адресат ВходящийTCP443IP-адрес0.0.0.0/0ВходящийTCP80IP-адрес0.0.0.0/0Исходящий Любой Оставьте пустымIP-адрес0.0.0.0/0\n4. Создайте виртуальную машину со следующими параметрами:\n- Название — identity-provider.\n- Образ — публичный образ Ubuntu 22.04.\n- Сетевой интерфейс — выберите тип Подсеть с публичным IP.\n- VPC — identity-provider-VPC.\n- Подсеть — identity-provider-subnet.\n- Публичный IP — оставьте Арендовать новый или выберите IP-адрес из списка арендованных.\n- Группы безопасности — добавьте группу identity-provider-sg.\n- Логин — keycloak.\n- Метод аутентификации — Публичный ключ и Пароль.\n- Публичный ключ — укажите ключ, созданный ранее.\n- Пароль — задайте пароль пользователя.\n5. Создайте кластер Managed PostgreSQL со следующими параметрами:\n- В поле Имя кластера укажите identity-provider.\n- В поле Название базы данных укажите identity_provider_database.\n- В поле Версия PostgreSQL выберите 16.\n- Выберите Режим — Стандарт.\n- Выберите Тип — Single.\n- Выберите Подсеть — identity-provider-subnet.\nУбедитесь, что ресурсы созданы и отображаются в личном кабинете:\n1. На странице Сети → VPC отображается сеть identity-provider-VPC, а в списке ее подсетей — identity-provider-subnet.\n2. На странице Сети → Группы безопасности отображается группа безопасности identity-provider-sg со статусом «Создана».\n3. На странице Инфраструктура → Виртуальные машины отображается виртуальная машина identity-provider со статусом «Запущена».\n4. На странице Базы данных → Managed PostgreSQL® отображается кластер identity-provider со статусом «Доступен».\n\n## 2. Настройте окружение виртуальной машины\nНа этом шаге вы установите необходимые пакеты и подготовите среду для Keycloak.\n1. Подключитесь к виртуальной машине по SSH.\n2. Обновите систему и установите утилиты:\n```\nsudo apt update && sudo apt upgrade -y\n```\n3. Установите и запустите Nginx:\n```\nsudo apt install nginx -ysudo systemctl enable nginxsudo systemctl start nginx\n```\n4. Установите Java 17:\n```\nsudo apt install openjdk-17-jdk -yexport JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64echo 'export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64' >> ~/.bashrc\n```\n5. Установите Let’s Encrypt и плагин для Nginx:\n```\nsudo apt install certbot python3-certbot-nginx -y\n```\n\n## 3. Настройте защищенный доступ через Nginx\nНа этом шаге вы зарегистрируете доменное имя, настроите Nginx в качестве защищенного прокси, получите SSL-сертификат и ограничите доступ через межсетевой экран.\n1. Создайте конфигурационный файл Nginx:\n```\nsudo nano /etc/nginx/sites-available/identity-provider.conf\n```\n2. Вставьте код, заменив <ip_address> на значение публичного IP-адреса виртуальной машины:\n```\nserver {    listen 80;    server_name <ip_address>.nip.io www.<ip_address>.nip.io;\n    location / {        proxy_pass http://127.0.0.1:8080;        proxy_set_header Host $host;        proxy_set_header X-Real-IP $remote_addr;        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;        proxy_set_header X-Forwarded-Proto https;        proxy_set_header X-Forwarded-Host $host;        proxy_set_header X-Forwarded-Port 443;\n        proxy_http_version 1.1;        proxy_set_header Upgrade $http_upgrade;        proxy_set_header Connection \"upgrade\";\n        proxy_buffer_size 128k;        proxy_buffers 4 256k;        proxy_busy_buffers_size 256k;\n        proxy_connect_timeout 60s;        proxy_send_timeout 60s;        proxy_read_timeout 60s;    }}\n```\n3. Сконфигурируйте межсетевой экран:\n```\nsudo ufw allow OpenSSHsudo ufw allow 'Nginx Full'sudo ufw enable\n```\n4. Активируйте конфигурацию и перезапустите Nginx:\n```\nsudo ln -sf /etc/nginx/sites-available/identity-provider.conf /etc/nginx/sites-enabled/identity-provider.confsudo rm -f /etc/nginx/sites-enabled/defaultsudo nginx -tsudo systemctl reload nginx\n```\n5. Выпустите SSL-сертификат:\n```\nsudo certbot --nginx -d <ip_address>.nip.io --redirect --agree-tos -m <email>\n```\n\nГде:\n- <ip_address> — публичный IP-адрес виртуальной машины.\n- <email> — email для регистрации сертификата.\n6. Перейдите по адресу https://<ip_address>.nip.io и убедитесь, что браузер отмечает соединение как безопасное.\n\n## 4. Установите и запустите Keycloak\nНа этом шаге вы установите Keycloak, настроите подключение к базе данных и запустите сервис как systemd-службу.\n1. Загрузите и распакуйте Keycloak:\n```\ncd /optsudo wget https://github.com/keycloak/keycloak/releases/download/26.0.2/keycloak-26.0.2.tar.gzsudo tar -xzf keycloak-26.0.2.tar.gzsudo mv keycloak-26.0.2 keycloaksudo chown -R keycloak:keycloak /opt/keycloaksudo chmod o+x /opt/keycloak/bin/\n```\n2. Создайте файл конфигурации Keycloak:\n```\nsudo nano /opt/keycloak/conf/keycloak.conf\n```\n3. Вставьте код, заменив значения параметров ниже на свои:\n```\ndb=postgresdb-username=<postgres_admin_user>db-password=<postgres_admin_password>db-url=jdbc:postgresql://<postgres_ip>:5432/identity_provider_database\nproxy=edgehostname=https://<ip_address>.nip.iohttp-enabled=trueproxy-headers=xforwardedhostname-strict=falsehostname-admin=https://<ip_address>.nip.io\nhealth-enabled=truemetrics-enabled=true\n```\n\nГде:\n- <postgres_admin_user> — имя пользователя кластера Managed PostgreSQL®.\n- <postgres_admin_password> — пароль указанного пользователя.\n- <postgres_ip> — приватный IP-адрес кластера.\n- <ip_address> — публичный IP-адрес виртуальной машины.\n4. Соберите приложение:\n```\nsudo -u keycloak /opt/keycloak/bin/kc.sh build\n```\n5. Создайте файл службы systemd:\n```\nsudo nano /etc/systemd/system/keycloak.service\n```\n6. Содержимое файла:\n```\n[Unit]Description=Keycloak Identity ProviderAfter=network.targetWants=network.target\n[Service]Type=simpleUser=keycloakGroup=keycloakEnvironment=JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64Environment=KC_LOG_LEVEL=INFOWorkingDirectory=/opt/keycloakExecStart=/opt/keycloak/bin/kc.sh startExecReload=/bin/kill -s HUP $MAINPIDKillMode=mixedKillSignal=SIGINTTimeoutStopSec=30Restart=alwaysRestartSec=10\n[Install]WantedBy=multi-user.target\n```\n7. Создайте временного администратора:\n```\nsudo -u keycloak /opt/keycloak/bin/kc.sh bootstrap-admin user\n```\n8. Запустите сервис:\n```\nsudo systemctl daemon-reloadsudo systemctl enable keycloaksudo systemctl start keycloak\n```\n9. Перейдите по адресу https://<ip_address>.nip.io и войдите в администраторскую консоль Keycloak, используя созданные учетные данные.\n\n## 5. Отключите SSH-доступ\nКогда вы развернули и настроили сервис, закройте доступ по SSH для повышения безопасности.\n1. В личном кабинете на верхней панели слева нажмите  и выберите Инфраструктура → Виртуальные машины.\n2. В списке виртуальных машин выберите identity-provider.\n3. Перейдите на вкладку Сетевые параметры.\n4. В блоке сетевого интерфейса нажмите  и выберите Изменить группы безопасности.\n5. Удалите группу SSH-access_ru и сохраните изменения.\n6. Убедитесь, что доступа нет — попробуйте подключиться к виртуальной машине по SSH.\nПосле отключения доступа по SSH, администрирование сервиса будет доступно через серийную консоль виртуальной машины.\n\n## Результат\nВы развернули Keycloak, настроили его взаимодействие с Managed PostgreSQL®, обеспечили безопасный доступ через Nginx и отключили неиспользуемый SSH-доступ.\n\n  [© 2025 Cloud.ru](https://cloud.ru)",
      "debug": {
        "start_page": 1,
        "end_page": 1
      }
    }
  ]
}