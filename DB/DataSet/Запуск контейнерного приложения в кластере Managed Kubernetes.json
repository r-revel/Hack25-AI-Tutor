{
  "title": "Запуск контейнерного приложения в кластере Managed Kubernetes",
  "chapters": [
    {
      "name": "Запуск контейнерного приложения в кластере Managed Kubernetes",
      "content": "Практические руководства Evolution    \n\n # Запуск контейнерного приложения в кластере Managed Kubernetes   Эта статья полезна?          \nС помощью этого руководства вы соберете и загрузите демонстрационный образ контейнерного приложения в Artifact Registry, создадите кластер Managed Kubernetes и развернете приложение из загруженного образа в кластере Managed Kubernetes.\nДля развертывания вы будете использовать следующие сервисы:\n- Artifact Registry — сервис для хранения, совместного использования и управления Docker-образами и Helm-чартами.\n- Managed Kubernetes — сервис управления кластерами Kubernetes на вычислительных ресурсах облачной архитектуры Cloud.ru.\n- sNAT-шлюзы — сервис управления сетевыми шлюзами облака.\n- Публичный IP-адрес для доступа к виртуальной машине и кластеру Managed Kubernetes с локального устройства.\nДля выполнения сценария потребуется создать два публичных IP-адреса.\nШаги:\n1. Сгенерируйте SSH-ключ и загрузите его публичную часть в облако Cloud.ru Evolution\n2. Создайте виртуальную машину\n3. Создайте sNAT-шлюз\n4. Создайте кластер Managed Kubernetes\n5. Создайте приватный репозиторий в Artifact Registry и загрузите в него образ контейнера\n6. Подключитесь с созданной ВМ к кластеру Managed Kubernetes\n7. Разверните приложение в Managed Kubernetes\n\n## Перед началом работы\nЗарегистрируйтесь в личном кабинете Cloud.ru.\nЕсли вы уже зарегистрированы, войдите под своей учетной записью.\n\n## 1. Сгенерируйте SSH-ключ и загрузите его публичную часть в облако Cloud.ru Evolution\n1. Сгенерируйте ключевую пару.\n2. Загрузите публичную часть SSH-ключа в облако Cloud.ru Evolution.\n\n## 2. Создайте виртуальную машину\n1. Выполните шаги инструкции по созданию виртуальной машины в облаке Cloud.ru Evolution до шага 4 раздела «Порядок работы».\n2. Подключите виртуальную машину к подсети: в разделе Сетевые настройки нажмите Подключить к сети.\n3. В открывшемся боковом меню оставьте значения по умолчанию для полей VPC, Подсети и Группы безопасности.\n4. Нажмите Подключить.\nПо умолчанию значение группы безопасности — SSH-access_ru.AZ-<availability-zone-number>.\nТакая настройка позволит подключаться к ВМ по протоколу SSH на TCP-порт 22.\n5. Чтобы у виртуальной машины был доступ в интернет, оставьте активной опцию Назначить публичный IP.\n6. Выберите тип публичного IP-адреса: Плавающий.\n7. В разделе Авторизация пользователя выберите оба метода аутентификации пользователя — Публичный ключ и Пароль.\n8. В выпадающем меню Публичный ключ выберите загруженный ранее публичный SSH-ключ.\n9. Придумайте пароль и введите в поле Пароль.\n10. Нажмите Создать.\nНа главном экране сервиса «Виртуальные машины» в списке появится новая ВМ.\nПримерно через минуту ее статус должен измениться на «Запущена».\n\n## 3. Создайте sNAT-шлюз\nРабочие узлы кластера Managed Kubernetes используют sNAT-шлюз для выхода в интернет.\nСоздайте его:\n1. Перейдите в личный кабинет.\n2. На верхней панели слева нажмите , выберите Сеть → sNAT-шлюз и нажмите Создать шлюз.\n3. Выберите зону доступности и заполните описание.\n4. Нажмите Создать.\nДля sNAT-шлюза потребуется публичный IP-адрес.\nВ случае необходимости вы можете расширить квоту по запросу .\n\n## 4. Создайте кластер Managed Kubernetes\n1. На верхней панели слева нажмите , выберите Контейнеры → Managed Kubernetes и нажмите Подключить.\nПодключение сервиса занимает примерно пять минут.\n2. На странице сервиса Managed Kubernetes нажмите Создать кластер.\n3. На шаге Общие параметры оставьте все значения по умолчанию и нажмите Продолжить.\n4. На шаге Сеть включите опцию Публичный IP-адрес, остальные параметры оставьте по умолчанию и нажмите Продолжить.\nПубличный IP — опциональный параметр для кластера Managed Kubernetes.\nОн необходим, чтобы подключаться к кластеру с локального устройства, а не через виртуальную машину.\n5. На шаге Группы узлов нажмите Добавить группу узлов, в появившемся меню настройки создаваемой группы узлов, оставьте значения по умолчанию и нажмите Продолжить.\n6. На шаге Интеграция оставьте все значения по умолчанию и нажмите Создать.\nСоздание кластера занимает примерно пять минут.\n\n## 5. Создайте приватный репозиторий в Artifact Registry и загрузите в него образ контейнера\n1. Создайте приватный реестр Artifact Registry.\n2. Пройдите аутентификацию.\n3. Соберите и загрузите образ в репозиторий Artifact Registry.\nИспользуйте наше демонстрационное приложение react-hello-world.\n1. Для сборки и тегирования образа на локальном компьютере выполните команду в Docker CLI или любом удобном терминале:\n```\ndocker build --tag <registry_name>.cr.cloud.ru/react-hello-world https://gitverse.ru/cloudru/evo-containerapp-react-sample.git#master --platform linux/amd64\n```\n2. Для загрузки образа выполните команду:\n```\ndocker push <registry_name>.cr.cloud.ru/react-hello-world:latest\n```\n\nУбедитесь, что в реестре появился репозиторий react-hello-world с артефактами образа.\n\n## 6. Подключитесь с созданной ВМ к кластеру Managed Kubernetes\n1. Подключитесь к ВМ по SSH.\n2. На ВМ установите kubectl.\n3. На ВМ установите cloudlogin.\n4. Подключитесь с ВМ к кластеру Managed Kubernetes.\n\n## 7. Разверните приложение в Managed Kubernetes\n1. Создайте containerapp-deployment.yaml и откройте его для редактирования:\n```\nnano containerapp-deployment.yaml\n```\n2. Вставьте содержимое манифеста:\n```\napiVersion: apps/v1kind: Deploymentmetadata:  name: containerappspec:  replicas: 1  selector:    matchLabels:      app: lab-app  template:    metadata:      labels:        app: lab-app    spec:      containers:        - name: containerapp          image: <registry_name>.cr.cloud.ru/react-hello-world:latest          ports:            - containerPort: 80          imagePullPolicy: Always\n```\n3. Примените манифест при помощи команды:\n```\nkubectl apply -f containerapp-deployment.yaml\n```\n4. Чтобы создать внешний балансировщик нагрузки для доступа к приложению из интернета, создайте containerapp-lb.yaml и откройте его для редактирования:\n```\nnano containerapp-lb.yaml\n```\n5. Вставьте содержимое манифеста:\n```\napiVersion: v1kind: Servicemetadata:  name: containerapp-lb  annotations:    loadbalancer.mk8s.cloud.ru/type: \"external\"    loadbalancer.mk8s.cloud.ru/health-check-timeout-seconds: \"5\"    loadbalancer.mk8s.cloud.ru/health-check-interval-seconds: \"5\"    loadbalancer.mk8s.cloud.ru/health-check-unhealthy-threshold-count: \"4\"    loadbalancer.mk8s.cloud.ru/health-check-healthy-threshold-count: \"4\"spec:  type: LoadBalancer  selector:    app: lab-app  ports:    - port: 80      name: cloudru-port\n```\n6. Создайте балансировщик нагрузки при помощи команды:\n```\nkubectl apply -f containerapp-lb.yaml\n```\n7. Посмотрите созданные сервисы в кластере при помощи команды:\n```\nkubectl get svc\n```\nПосле создания внешнего балансировщика нагрузки платформа начнет создание объекта LoadBalancer.\nПосле того как балансировщик будет создан и получит публичный IP, IP-адрес отобразится в поле EXTERNAL-IP.\nПодождите примерно 5–10 минут и проверьте, получил ли балансировщик нагрузки публичный IP.\nПосле получения IP-адреса проверьте доступность приложения — введите в адресную строку браузера: http://<EXTERNAL-IP>.\n\n## Результат\nВы развернули кластер Managed Kubernetes и запустили в нем приложение из приватного реестра Artifact Registry.\n\n  [© 2025 Cloud.ru](https://cloud.ru)",
      "debug": {
        "start_page": 1,
        "end_page": 1
      }
    }
  ]
}