{
  "title": "Подключение Trino к Iceberg",
  "chapters": [
    {
      "name": "Подключение Trino к Iceberg",
      "content": "Практические руководства Evolution    \n\n # Подключение Trino к Iceberg   Эта статья полезна?          \nС помощью этого руководства вы подготовите инстанс Trino для работы с форматом данных Iceberg.\n\n## Постановка задачи\n1. Создать и заполнить таблицу с данными сотрудников.\n2. Прочитать данные таблицы в определенной точке времени, используя формат данных Iceberg.\n\n## Перед началом работы\n1. Зарегистрируйтесь в личном кабинете Cloud.ru.\nЕсли вы уже зарегистрированы, войдите под своей учетной записью.\n2. Создайте публичный SNAT-шлюз, чтобы обеспечить инстансу доступ в интернет и связь с внешними источниками.\n3. Создайте бакет Object Storage, в котором будут храниться таблицы и схемы.\n4. Создайте секреты в сервисе Secret Management для доступа к Object Storage.\nПонадобится сохранить идентификатор ключа доступа (access key) и секретный ключ доступа (key secret).\n5. Настройте DNS-сервер и подсеть.\n6. Создайте кластер Data Platform, в котором будет размещен инстанс.\nНазовите кластер «dp-labs».\n7. Скачайте и установите root-сертификат на устройство.\n8. Установите JDBC-клиент DBeaver.\nВнимание Все сущности должны располагаться в одной VPC и подсетях одного типа.\n\n## Создайте инстанс Managed Metastore\n1. Перейдите в раздел Evolution и выберите сервис Managed Metastore.\n2. Нажмите Создать инстанс.\n3. В блоке Общие параметры заполните поля следующими значениями:\n- Название — iceberg-metastore-lab.\n- Кластер — dp-labs.\n- Лог-группа — группа, в которой будут храниться логи инстанса.\n- Файловая система — S3 и выберите Object Storage.\n- Бакет — созданный бакет Object Storage.\n4. Нажмите Продолжить.\n5. В блоке Сетевые настройки выберите:\n- Зона доступности — зону доступности, для которой создан SNAT-шлюз.\n- Подсеть — подсеть с DNS-сервером.\n6. Нажмите Создать.\n7. Дождитесь, когда статус инстанса изменится на «Готов».\n8. Откройте карточку инстанса.\nИнформация об инстансе понадобится при создании каталога Trino.\n\n## Создайте каталог\n1. Перейдите в раздел Evolution и выберите сервис  Managed Trino.\n2. Откройте раздел Каталог.\n3. Нажмите Создать каталог.\n4. Заполните поля следующими значениями:\n- Название — metastore_iceberg_lab.\n- Коннектор — Iceberg.\n- Каталог — Metastore.\n- Thrift URL — Thrift URL, скопированный с карточки Metastore.\n- Эндпоинт — https://s3.cloud.ru.\n- Идентификатор ключа доступа — access key, выбирается из Secret Management.\n- Секретный ключ доступа — secret key, выбирается из Secret Management.\n- Регион S3 — ru-central-1.\n5. Нажмите Создать.\nНа странице Managed Trino в разделе Каталог появится запись с названием «metastore_iceberg_lab».\n\n## Создайте инстанс Trino\n1. Перейдите в раздел Evolution и выберите сервис  Managed Trino.\n2. Откройте раздел Инстансы.\n3. Нажмите Создать инстанс.\n4. В блоке Общие параметры заполните поля следующими значениями:\n- Название — trino-iceberg-lab.\n- Кластер — dp-labs.\n- Вычислительные ресурсы — vCPU 4, RAM 16.\n- Количество node — 3.\n5. Нажмите Продолжить.\n6. В блоке Каталог выберите каталог Metastore с названием «metastore_iceberg_lab».\n7. Нажмите Продолжить.\n8. В блоке Сетевые настройки выберите:\n- Зона доступности — зону доступности, для которой создан SNAT-шлюз.\n- Подсеть — подсеть, в которой расположен инстанс Managed Metastore.\n- Подключить публичный хост — активируйте опцию.\n- Пользователь — имя пользователя.\n- Пароль — секретный ключ.\n9. Нажмите Создать.\n10. Дождитесь, когда статус инстанса изменится на «Готов».\n11. Откройте карточку инстанса Trino.\nИнформация из нее понадобится при подключении к DBeaver.\n\n## Подключите Trino к DBeaver\n\n### Добавьте сертификат в Java KeyStore\n1. Запустите терминал и перейдите в директорию, где хотите сохранить JKS-файл.\n2. Введите команду:\n```\nkeytool -importcert  -alias cloudru-root  -file <PATH>/dp-cert.crt  -keystore <PATH>/cloudru-truststore.jks  -storetype JKS  -storepass <YOUR-PASSWORD>  -noprompt\n```\n\n- В строке -file вместо <PATH> укажите путь до скачанного ранее root-сертификата.\n- В строке -keystore вместо <PATH> укажите путь до места, где будет храниться JKS-файл.\nСохраните путь.\nОн понадобится при добавлении JKS-файла в DBeaver.\n- В строке -storepass вместо <YOUR-PASSWORD> задайте пароль для сертификата.\nСохраните пароль.\nОн понадобится при добавлении JKS-файла в DBeaver.\n\n### Подключите DBeaver\n1. Откройте приложение DBeaver.\n2. В панели сверху нажмите База данных → Новое соединение.\n3. В списке соединений выберите Trino.\n4. Нажмите Далее и на вкладке Главное заполните поля информацией из карточки инстанса:\n- Хост\n- Порт\n- Пользователь\n- Пароль\n5. На вкладке Свойства драйвера измените значение свойства SSL на true.\n6. Нажмите Тест соединения.\n7. Нажмите Готово.\nСлева в списке объектов появится база данных Metastore с названием «iceberg-metastore-lab».\n\n## Отправьте SQL-запросы\n1. Запустите DBeaver.\n2. Создайте новый редактор SQL и введите команду:\n```\nSHOW CATALOGS;\n```\n\nВ списке должен появиться коннектор «metastore_iceberg_lab».\n3. Создайте схему:\n```\nCREATE SCHEMA IF NOT EXISTS metastore_iceberg_lab.my_company_iceberg;\n```\n4. Создайте таблицу в каталоге Iceberg:\n```\nCREATE TABLE IF NOT EXISTS metastore_iceberg_lab.my_company_iceberg.employees(    id_employee INT,    email VARCHAR(255))WITH (    format = 'PARQUET'\n);\n```\n5. Вставьте данные в таблицу:\n```\nINSERT INTO metastore_iceberg_lab.my_company_iceberg.employeesvalues (1, 'xxx@example.com'), (2, 'yyy@example.com'), (3, 'zzz@example.com');\n```\n6. Прочитайте данные из таблицы, чтобы убедиться, что данные записаны:\n```\nSELECT *FROM metastore_iceberg_lab.my_company_iceberg.employees;\n```\n7. Вставьте данные в таблицу:\n```\nINSERT INTO metastore_iceberg_lab.my_company_iceberg.employeesvalues (4, 'ttt@example.com'), (5, 'ggg@example.com'), (6, 'iii@example.com');\n```\n8. Прочитайте данные из таблицы, чтобы убедиться, что данные записаны:\n```\nSELECT *FROM metastore_iceberg_lab.my_company_iceberg.employees;\n```\n9. Прочитайте историю таблицы:\n```\nSELECT *FROM metastore_iceberg_lab.my_company_iceberg.\"employees$history\"ORDER BY made_current_at;\n```\n\nВ результате выполнения запроса будет выведена история изменений таблицы, содержащая записи о создании таблицы и добавлении в нее новых строк.\n10. Добавьте данные в таблицу:\n```\nINSERT INTO metastore_iceberg_lab.my_company_iceberg.employeesvalues (7, 'qqq@example.com'), (8, 'www@example.com'), (9, 'eee@example.com');\n```\n11. Прочитайте данные из таблицы, чтобы проверить, что появилась еще одна запись:\n```\nSELECT *FROM metastore_iceberg_lab.my_company_iceberg.\"employees$history\"ORDER BY made_current_at;\n```\n12. Чтобы понаблюдать, как таблица менялась со временем, прочитайте данные из таблицы, подставляя в запрос различные значения из столбца made_current_at.\n```\nSELECT *FROM metastore_iceberg_lab.my_company_iceberg.employeesFOR TIMESTAMP AS OF TIMESTAMP 'YYYY-MM-DD HH:MM:SS.000 +0300';\n```\n\nГде YYYY-MM-DD HH:MM:SS.000 — скопированное время создания таблицы.\n\n  [© 2025 Cloud.ru](https://cloud.ru)",
      "debug": {
        "start_page": 1,
        "end_page": 1
      }
    }
  ]
}