{
  "title": "Запуск приложения на виртуальной машине в качестве службы",
  "chapters": [
    {
      "name": "Запуск приложения на виртуальной машине в качестве службы",
      "content": "Практические руководства Evolution    \n\n # Запуск приложения на виртуальной машине в качестве службы   Эта статья полезна?          \nС помощью этого руководства вы развернете сервис для автоматического создания резервных копий выбранной директории на  виртуальной машине.\nВы создадите служебный NodeJS-сервис, научитесь работать с дополнительным виртуальным диском, а также настроите запуск сервиса как systemd-службы для автоматизации процессов.\nВы будете использовать следующие сервисы:\n- Виртуальная машина free tier — сервис, в рамках которого предоставляется бесплатная виртуальная машина с готовой конфигурацией.\n- Systemd — системный менеджер служб в Linux.\n- NodeJS и TypeScript — стек для разработки серверных приложений на языке JavaScript.\nШаги:\n1. Создайте виртуальную машину.\n2. Настройте группу безопасности.\n3. Подключите и настройте дополнительный диск.\n4. Подготовьте диск к работе.\n5. Установите NodeJS и зависимости.\n6. Создайте и соберите сервис резервного копирования.\n7. Настройте запуск сервиса как systemd-службы.\n\n## Перед началом работы\nЗарегистрируйтесь в личном кабинете Cloud.ru.\nЕсли вы уже зарегистрированы, войдите под своей учетной записью.\n\n## 1. Создайте виртуальную машину\nНа виртуальной машине будет запущена служба резервного копирования данных.\nСоздайте бесплатную виртуальную машину со следующими параметрами:\n1. В поле Название укажите название виртуальной машины, например backup-service.\n2. На вкладке Публичные выберите образ Ubuntu 22.04.\n3. Назначьте публичный IP-адрес виртуальной машине — оставьте включенной опцию Подключить публичный IP. Для виртуальной машины будет арендован и назначен прямой публичный IP.\n4. В поле Логин укажите логин пользователя виртуальной машины, например user1.\n5. Выберите метод аутентификации — пароль.\nУбедитесь, что в личном кабинете на странице сервиса «Виртуальные машины»:\n- отображается виртуальная машина backup-service;\n- статус виртуальной машины — «Запущена»;\n- виртуальной машине назначен публичный IP-адрес.\n\n## 2. Настройте группу безопасности\nГруппы безопасности в облаке Evolution позволяют контролировать входящий и исходящий трафик для создаваемых ресурсов.\nВы настроите правила фильтрации трафика — разрешите весь исходящий трафик виртуальной машины.\nСоздайте новую группу безопасности со следующими параметрами:\n1. Выберите Зону доступности, в которой необходимо разместить группу безопасности. Укажите ту же зону доступности, что выбрана для виртуальной машины backup-service.\n2. Укажите Название группы безопасности, например allow-outbound-traffic.\n3. Добавьте правило исходящего трафика:\n- Протокол — Любой.\n- Порт — оставьте пустым.\n- Тип адресата — IP-адрес.\n- Адресат — 0.0.0.0/0.\n4. Назначьте созданную группу безопасности виртуальной машине backup-service.\nУбедитесь, что на странице виртуальной машины в разделе Сетевые параметры для сетевого интерфейса с публичным IP отображается группа безопасности allow-outbound-traffic.\n\n## 3. Подключите и настройте дополнительный диск\nРезервные копии рекомендуется хранить отдельно от основного системного диска.\n1. Создайте диск со следующими параметрами:\n1. В поле Зона доступности укажите ту же зону, что выбрана для виртуальной машины.\n2. Укажите название диска — backup-disk.\n3. Укажите размер диска — 10 ГБ.\n2. Подключите диск к виртуальной машине:\n1. В строке созданного диска нажмите  и выберите Подключить.\n2. Выберите виртуальную машину backup-service в списке и нажмите Подключить.\nУбедитесь, что в личном кабинете на странице сервиса «Диски»:\n- отображается диск backup-disk;\n- статус диска — «Используется»;\n- в столбце Ресурс указана виртуальная машина backup-service.\n\n## 4. Подготовьте диск к работе\nПосле подключения отформатируйте диск, смонтируйте его и настройте права доступа.\n1. Подключитесь к виртуальной машине через серийную консоль.\n2. Отформатируйте диск:\n1. Получите список дисков виртуальной машины.\nВ терминале выполните команду:\n```\nlsblk\n```\n\nПодключенный диск отображается в конце списка с именем vdb.\n2. Отформатируйте диск и создайте файловую систему:\n```\nsudo mkfs -t xfs /dev/vdb\n```\n3. Смонтируйте диск с именем backup-disk:\n1. Создайте каталог для точки монтирования диска:\n```\nsudo mkdir /backup-disk\n```\n2. Выполните монтирование в созданный каталог:\n```\nsudo mount /dev/vdb /backup-disk\n```\n4. Выдайте всем пользователям вашего проекта права на чтение и запись данных диска:\n```\nsudo chmod a+rw /backup-disk\n```\n5. Проверьте с помощью команды lsblk, что диск backup-disk смонтирован и доступен.\n\n## 5. Установите NodeJS и зависимости\nНа этом этапе установите NodeJS (через NVM), а также необходимые инструменты для работы сервиса резервного копирования.\n1. В серийной консоли виртуальной машины последовательно выполните команды:\n```\nsudo apt-get update -ysudo apt-get install -y curlcurl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.1/install.sh | bashsource ~/.bashrcnvm install 20nvm use 20\n```\n2. Проверьте, что NodeJS и npm установлены:\n```\nnode -vnpm -v\n```\n\nВ результате отобразятся установленные версии.\n\n## 6. Создайте и соберите сервис резервного копирования\nРазверните проект резервного копирования, настройте параметры TypeScript, создайте конфигурационные и исходные файлы.\n1. Создайте директорию для файлов, которые будут копироваться:\n```\nmkdir files\n```\n2. Создайте директорию проекта:\n```\nmkdir backup-service\n```\n3. Перейдите в директорию проекта:\n```\ncd backup-service\n```\n4. Проинициализируйте проект NodeJS:\n```\nnpm init -y\n```\n5. Установите зависимости:\n```\nnpm install typescript ts-node @types/node --save-devnpm install node-cron fs-extranpm install @types/fs-extra --save-dev\n```\n6. Сгенерируйте файл tsconfig.json:\n```\nnpx tsc --init --module commonjs\n```\n7. Откройте файл tsconfig.json для редактирования:\n```\nnano tsconfig.json\n```\n8. Вставьте в файл конфигурацию:\n```\n{  \"compilerOptions\": {    \"target\": \"es2016\",    \"module\": \"commonjs\",    \"outDir\": \"./dist\",    \"rootDir\": \"./src\",    \"strict\": true,    \"esModuleInterop\": true,    \"skipLibCheck\": true,    \"forceConsistentCasingInFileNames\": true,    \"sourceMap\": true  },  \"include\": [\"src/**/*\"],  \"exclude\": [\"node_modules\", \"dist\"]}\n```\n9. Создайте директорию src и файл config.json:\n```\nmkdir srctouch config.jsonnano config.json\n```\n10. Вставьте в файл конфигурацию:\n```\n{  \"inputDir\": \"/home/user1/files\",  \"outputDir\": \"/backup-disk/backups\",  \"backupInterval\": \"*/10 * * * *\",  \"logLevel\": \"info\"}\n```\n11. Создайте основной скрипт резервного копирования:\n```\ncd srctouch backup-service.tsnano backup-service.ts\n```\n12. Вставьте код скрипта:\n```\nimport * as fs from 'fs-extra';import * as path from 'path';import * as cron from 'node-cron';\ninterface BackupConfig {  inputDir: string;  outputDir: string;  backupInterval: string;  logLevel: string;}\nclass BackupService {  private config: BackupConfig;\n  constructor(configPath: string) {    this.config = this.loadConfig(configPath);  }\n  private loadConfig(configPath: string): BackupConfig {    try {      const configData = fs.readFileSync(configPath, 'utf8');      return JSON.parse(configData);    } catch (error) {      console.error('Error loading configuration:', error);      process.exit(1);    }  }\n  private async performBackup(): Promise<void> {    try {      const timestamp = new Date().toISOString().replace(/[:.]/g, '-');      const backupDir = path.join(this.config.outputDir, `backup-${timestamp}`);\n      console.log(`Starting backup from ${this.config.inputDir} to ${backupDir}`);\n      // Ensure output directory exists      await fs.ensureDir(this.config.outputDir);\n      // Copy directory recursively      await fs.copy(this.config.inputDir, backupDir);\n      console.log(`Backup completed successfully at ${new Date().toISOString()}`);    } catch (error) {      console.error('Backup failed:', error);    }  }\n  public start(): void {    console.log(`Backup service started with interval: ${this.config.backupInterval}`);\n    // Schedule backup job    cron.schedule(this.config.backupInterval, () => {      this.performBackup();    });\n    // Perform initial backup    this.performBackup();  }}\n// Start the serviceconst configPath = process.env.CONFIG_PATH || '../config.json';const backupService = new BackupService(configPath);backupService.start();\n// Keep the process runningprocess.on('SIGINT', () => {  console.log('Backup service shutting down...');  process.exit(0);});\nprocess.on('SIGTERM', () => {  console.log('Backup service shutting down...');  process.exit(0);});\n```\n13. Откройте файл package.json для редактирования:\n```\ncd ..nano package.json\n```\n14. Отредактируйте скрипты запуска в секции scripts:\n```\n{  \"scripts\": {    \"build\": \"tsc\",    \"start\": \"node dist/backup-service.js\",    \"dev\": \"ts-node src/backup-service.ts\"  },}\n```\n15. Соберите проект:\n```\nnpm run build\n```\n16. Проверьте, что сборка успешно завершена — файл dist/backup-service.js создан:\n```\ncat dist/backup-service.js\n```\n\n## 7. Настройте запуск сервиса как systemd-службы\nНа заключительном этапе настройте автоматический запуск сервиса резервного копирования через systemd.\n1. Создайте конфигурацию службы:\n```\nsudo nano /etc/systemd/system/backup-service.service\n```\n2. Вставьте следующее содержимое:\n```\n[Unit]Description=Directory Backup ServiceAfter=network.target\n[Service]Type=simpleUser=user1Group=user1WorkingDirectory=/home/user1/backup-serviceExecStart=/home/user1/.nvm/versions/node/v20.19.3/bin/node /home/user1/backup-service/dist/backup-service.jsEnvironment=NODE_ENV=productionEnvironment=CONFIG_PATH=/home/user1/backup-service/config.jsonRestart=alwaysRestartSec=10StandardOutput=syslogStandardError=syslogSyslogIdentifier=backup-service\n[Install]WantedBy=multi-user.target\n```\n3. Перезапустите менеджер systemd и активируйте службу:\n```\nsudo systemctl daemon-reloadsudo systemctl enable backup-servicesudo systemctl start backup-service\n```\n\nПосле запуска службы копирование файлов будет автоматически запускаться каждые 10 минут.\n4. Проверьте работоспособность службы:\n```\nsudo systemctl status backup-service\n```\n\nРезультат:\n```\nbackup-service.service - Directory Backup Service   Loaded: loaded (/etc/systemd/system/backup-service.service; enabled; vendor preset: enabled)   Active: active (running) since Tue 2025-07-15 13:35:55 MSK; 1h 3min ago Main PID: 2977 (node)    Tasks: 11 (limit: 1016)   Memory: 17.9M      CPU: 213ms   CGroup: /system.slice/backup-service.service           └─2977 /home/user1/.nvm/versions/node/v20.19.3/bin/node /home/user1/backup-service/dist/backup-service.js\n```\n\nУ работающей службы в поле «Active» отображается значение «active (running)».\n5. Создайте несколько файлов в директории files:\n```\ncd ../filestouch 1.txttouch 2.txt\n```\n6. Проверьте, что резервные копии директории files появляются в директории /backup-disk/backups.\n```\ncd ../../../backup-disk/backups\n```\n\nКаждая копия хранится в отдельной директории внутри /backup-disk/backups.\n7. Перезагрузите виртуальную машину и убедитесь, что служба автоматически запустилась.\n\n## Результат\nВы развернули надежный сервис резервного копирования на NodeJS и systemd в облаке Cloud.ru, освоили управление дополнительным диском и автоматизацию обслуживающих процессов Linux.\n\n  [© 2025 Cloud.ru](https://cloud.ru)",
      "debug": {
        "start_page": 1,
        "end_page": 1
      }
    }
  ]
}