{
  "title": "Настройка site-to-site VPN с помощью strongSwan",
  "chapters": [
    {
      "name": "Настройка site-to-site VPN с помощью strongSwan",
      "content": "Практические руководства Evolution    \n\n # Настройка site-to-site VPN с помощью strongSwan   Эта статья полезна?          \nС помощью этого руководства вы настроите сетевую связность между инфраструктурой в облаке Cloud.ru Evolution и некоторой удаленной стороной.\nНа практике в качестве удаленной стороны может выступать, например, сетевая инфраструктура в офисе или в другом облаке.\nДля организации защищенного соединения вы настроите IPsec-туннель с помощью ПО strongSwan, где в качестве одной из сторон выступает инфраструктура в облаке Cloud.ru Evolution.\nВиртуальная машина в облаке используется как VPN-шлюз, через который другие машины из этого облака отправляют трафик в удаленную подсеть.\nТакой туннель позволяет безопасно передавать трафик между приватными сетями через интернет.\nВ качестве удаленной вы развернете аналогичную инфраструктуру на платформе Cloud.ru Advanced.\nВы будете использовать следующие сервисы:\n- Виртуальные машины — сервис, в рамках которого предоставляется виртуальная машина.\n- Публичный IP-адрес.\n- VPC — изолированная виртуальная сеть для создания безопасной инфраструктуры.\n- strongSwan — программное решение с открытым исходным кодом для создания защищенных VPN-соединений по протоколу IPsec.\nШаги:\n1. Разверните инфраструктуру на стороне Evolution.\n2. Разверните инфраструктуру на стороне Advanced.\n3. Добавьте правила в группу безопасности облачного VPN-шлюза.\n4. Настройте VPN-шлюзы.\n5. Настройте маршрутизацию.\n6. Проверьте сетевую связность.\n\n## Перед началом работы\n1. Зарегистрируйтесь в личном кабинете Cloud.ru.\nЕсли вы уже зарегистрированы, войдите под своей учетной записью.\n2. Убедитесь, что для вашей учетной записи достаточно прав на проект.\nПри необходимости настройте права или запросите их у администратора.\n\n## 1. Разверните инфраструктуру на стороне Evolution\nНа этом шаге в облаке Evolution вы создадите и подготовите виртуальную сеть, подсеть, группу безопасности и две виртуальные машины.\n1. Создайте виртуальную сеть с названием cloud-vpc.\n2. Создайте подсеть со следующими параметрами:\n- Название — cloud-subnet.\n- VPC — cloud-vpc.\n- Зона доступности — ru.AZ-1.\n- Адрес — 172.16.0.0/24.\nСкопируйте и сохраните адрес подсети: он потребуется для дальнейшей настройки.\n3. Создайте группу безопасности с названием cloud-sg в зоне доступности ru.AZ-1 и добавьте в нее правило исходящего трафика:\n Протокол Порт Тип адресата Адресат Любой Оставьте пустымIP-адрес0.0.0.0/0\nПосле создания удаленного VPN-шлюза на платформе Advanced в эту группу необходимо добавить правила для входящего трафика.\n4. Создайте виртуальную машину со следующими параметрами:\n- Название — cloud-gateway.\n- Зона доступности — ru.AZ-1\n- Образ — на вкладке Маркетплейс выберите образ «strongSwan».\n- Сетевой интерфейс — выберите тип Подсеть с публичным IP.\n- VPC — cloud-vpc.\n- Подсеть — cloud-subnet.\n- Публичный IP — оставьте Арендовать новый или выберите IP-адрес из списка арендованных.\n- Группы безопасности — добавьте группу cloud-sg.\n- Имя пользователя — cloud-user.\n- Метод аутентификации — Пароль.\n- Пароль — задайте пароль пользователя.\nВиртуальная машина будет выполнять роль облачного VPN-шлюза, который принимает трафик от клиентских ВМ и направляет его в удаленную подсеть.\n5. В строке ВМ cloud-gateway скопируйте и сохраните адреса из столбцов Внутренний IP и Публичный IP: они потребуются для дальнейшей настройки.\n6. Создайте виртуальную машину со следующими параметрами:\n- Название — cloud-vm.\n- Зона доступности — ru.AZ-1\n- Образ — на вкладке Публичные выберите Ubuntu 22.04.\n- Сетевой интерфейс — выберите тип Подсеть.\n- VPC — cloud-vpc.\n- Подсеть — cloud-subnet.\n- Группы безопасности — добавьте группу cloud-sg.\n- Логин — client.\n- Метод аутентификации — Пароль.\n- Пароль — задайте пароль пользователя.\nВиртуальная машина будет выполнять роль клиента, который отправляет трафик в удаленную подсеть через облачный VPN-шлюз.\n7. В строке ВМ cloud-vm скопируйте и сохраните адрес из столбца Внутренний IP: он потребуется для дальнейшей настройки.\n8. На сетевом интерфейсе облачного VPN-шлюза отключите проверку адресов источника и назначения.\n1. На странице сервиса «Виртуальные машины» выберите виртуальную машину cloud-gateway.\n2. Перейдите на вкладку Сетевые параметры.\n3. В правом верхнем углу блока нужного сетевого интерфейса нажмите  и выберите Свойства.\n4. Отключите опцию Проверка адреса источника/назначения.\n5. Подтвердите отключение.\n\n## 2. Разверните инфраструктуру на стороне Advanced\nНа этом шаге в облаке Advanced вы создадите и подготовите виртуальную сеть, подсеть, группу безопасности и две виртуальные машины.\n1. Создайте сеть VPC и подсеть со следующими параметрами:\n- В блоке Basic Information:\n- Name — remote-vpc.\n- IPv4 CIDR Block — 10.0.0.0/8-24.\n- Enterprise Project — выберите существующий проект из списка или нажмите Create Enterprise Project, чтобы создать новый.\n- В блоке Subnet Setting:\n- Subnet Name — remote-subnet.\n- IPv4 CIDR Block — 10.0.0.0/24.\nСохраните адрес подсети — он потребуется для дальнейшей настройки.\n2. Создайте группу безопасности со следующими параметрами:\n- Name — remote-sg.\n- Enterprise Project — выберите существующий проект из списка или нажмите Create Enterprise Project, чтобы создать новый.\n- Template — Fast-add rule.\n3. Добавьте правила в группу безопасности согласно таблице:\n PriorityActionTypeProtocol & PortSource1AllowIPv4UDP: 500<cloud_gateway_public_ip>1AllowIPv4UDP: 4500<cloud_gateway_public_ip>1AllowIPv4ICMP: All<cloud_subnet_ip>\nГде:\n- <cloud_gateway_public_ip> — публичный IP-адрес ВМ cloud-gateway на платформе Evolution.\n- <cloud_subnet_ip> — адрес подсети cloud-subnet на платформе Evolution.\n4. Создайте виртуальную машину со следующими параметрами:\n1. На этапе Configure Basic Settings:\n- AZ — AZ1.\n- Specifications — выберите спецификацию General-Purpose и флейвор s6.small.1.\n- Image — Ubuntu 22.04.\n2. На этапе Configure Network:\n- Network — выберите облачную сеть remote-vpc и подсеть remote-subnet.\n- Source/Destination Check — отключите опцию.\n- Security Group — remote-sg.\n- EIP — Auto assign.\n- Billed By — By Traffic.\n3. На этапе Configure Advanced Settings:\n- ECS Name — remote-gateway.\n- Login Mode —  Password.\n- Password — введите пароль пользователя.\n- Confirm Password — повторите введенный ранее пароль.\n4. На этапе Confirm проверьте настройки виртуальной машины и в поле Enterprise Project выберите проект, в котором она будет создана.\nВиртуальная машина будет выполнять роль удаленного VPN-шлюза, который принимает трафик от клиентских ВМ и направляет его в подсеть на стороне Evolution.\n5. Сохраните IP-адреса виртуальной машины remote-gateway из столбца IP Address: публичный (EIP) и внутренний (Private IP).\nОни потребуются для дальнейшей настройки.\n6. Создайте виртуальную машину со следующими параметрами:\n1. На этапе Configure Basic Settings:\n- AZ — AZ1.\n- Specifications — выберите спецификацию General-Purpose и флейвор s6.small.1.\n- Image — Ubuntu 22.04.\n2. На этапе Configure Network:\n- Network — выберите облачную сеть remote-vpc и подсеть remote-subnet.\n- Security Group — remote-sg.\n- EIP — Do not use.\n3. На этапе Configure Advanced Settings:\n- ECS Name — remote-vm.\n- Login Mode —  Password.\n- Password — введите пароль пользователя.\n- Confirm Password — повторите введенный ранее пароль.\n4. На этапе Confirm проверьте настройки виртуальной машины и в поле Enterprise Project выберите проект, в котором она будет создана.\nВиртуальная машина будет выполнять роль клиента, который отправляет трафик в подсеть на стороне Evolution через удаленный VPN-шлюз.\n7. Сохраните внутренний IP-адрес виртуальной машины remote-vm из столбца IP Address: он потребуется для дальнейшей настройки.\n\n## 3. Добавьте правила в группу безопасности облачного VPN-шлюза\nДля работы strongSwan и проверки доступности виртуальных машин необходимо:\n- разрешить входящий трафик со стороны удаленного VPN-шлюза через порты UDP 500 и 4500;\n- разрешить входящий трафик из удаленной подсети по протоколу ICMP.\nДобавьте правила входящего трафика в группу безопасности cloud-sg согласно таблице:\n Протокол Порт Тип источника ИсточникUDP500IP-адрес<remote_gateway_public_ip>UDP4500IP-адрес<remote_gateway_public_ip>ICMP ЛюбойIP-адрес<remote_subnet_ip>\nГде:\n- <remote_gateway_public_ip> — публичный IP-адрес ВМ remote-gateway на платформе Advanced.\n- <remote_subnet_ip> — адрес подсети remote-subnet на платформе Advanced.\n\n## 4. Настройте VPN-шлюзы\nДля установления IPsec-туннеля необходимо настроить VPN-шлюзы на стороне Evolution и Advanced.\n\n### Настройте облачный VPN-шлюз\n1. Перейдите в личный кабинет платформы Evolution.\n2. На верхней панели слева нажмите  и выберите Инфраструктура → Виртуальные машины.\n3. Выберите виртуальную машину cloud-gateway в списке.\n4. Перейдите на вкладку Серийная консоль.\n5. Введите логин и пароль, указанные при создании виртуальной машины.\n6. Включите маршрутизацию пакетов и отключите функциональность ICMP Redirects:\n1. Откройте файл /etc/sysctl.conf для редактирования.\nВ терминале выполните команду:\n```\nsudo nano /etc/sysctl.conf\n```\n2. Добавьте в файл параметры:\n```\nnet.ipv4.ip_forward = 1net.ipv4.conf.all.accept_redirects = 0net.ipv4.conf.all.send_redirects = 0net.ipv4.conf.enp3s0.accept_redirects = 0net.ipv4.conf.enp3s0.send_redirects = 0\n```\n3. Примените изменения:\n```\nsudo sysctl -p /etc/sysctl.conf\n```\n7. Заполните файл конфигурации IPsec-туннеля:\n1. Откройте файл /etc/ipsec.conf для редактирования:\n```\nsudo nano /etc/ipsec.conf\n```\n2. Вставьте конфигурацию в файл:\n```\nconfig setup    strictcrlpolicy=yes    uniqueids=yes\nconn evo-to-advanced    type=tunnel    auto=start    keyexchange=ikev2    authby=secret    left=<left_internal_ip>    leftid=<left_public_ip>    leftsubnet=<left_subnet>    right=<right_public_ip>    rightsubnet=<right_subnet>    ike=aes256-sha2_256-modp1024!    esp=aes256-sha2_256!\n```\n\nГде:\n- <left_internal_ip> — внутренний IP-адрес ВМ cloud-gateway.\n- <left_public_ip> — публичный IP-адрес ВМ cloud-gateway.\n- <left_subnet> — адрес подсети cloud-subnet.\n- <right_public_ip> — публичный IP-адрес ВМ remote-gateway на платформе Advanced.\n- <right_subnet> — адрес подсети remote-subnet на платформе Advanced.\nПодробное описание параметров файла /etc/ipsec.conf смотрите в документации strongSwan.\n8. Заполните файл секретов:\n1. Откройте файл /etc/ipsec.secrets для редактирования:\n```\nsudo nano /etc/ipsec.secrets\n```\n2. Вставьте в файл ключевую фразу (PSK, Pre-Shared Key) туннеля:\n```\n<left_public_ip> <right_public_ip> : PSK \"<secret_phrase>\"\n```\n\nГде:\n- <left_public_ip> — публичный IP-адрес ВМ cloud-gateway.\n- <right_public_ip> — публичный IP-адрес ВМ remote-gateway на платформе Advanced.\n- <secret_phrase> — ключ для установки IPsec-соединения.\nЗначение ключа необходимо придумать самостоятельно.\n9. Перезапустите strongSwan:\n```\nsudo systemctl restart strongswan-starter.service\n```\n10. Проверьте, что VPN-шлюз на стороне Evolution поднят и находится в ожидании установления IPsec-туннеля c удаленной стороной:\n```\nsudo ipsec status\n```\n\nРезультат:\n```\nSecurity Associations (0 up, 1 connecting):evo-to-advanced[1]: CONNECTING, 172.31.***.***[%any]...37.18.***.***[%any]\n```\n\n### Настройте удаленный VPN-шлюз\n1. Войдите в консоль управления Advanced:\n- через личный кабинет Cloud.ru;\n- как IAM-пользователь.\n2. В списке сервисов выберите Elastic Cloud Server.\n3. Напротив виртуальной машины remote-gateway нажмите Remote Login.\n4. Введите логин и пароль, указанные при создании виртуальной машины.\n5. Обновите версии пакетов.\nВ терминале выполните команду:\n```\nsudo apt update\n```\n6. Установите strongSwan:\n```\nsudo apt install -y strongswan\n```\n7. Включите маршрутизацию пакетов и отключите функциональность ICMP Redirects:\n1. Откройте файл /etc/sysctl.conf для редактирования:\n```\nsudo nano /etc/sysctl.conf\n```\n2. Добавьте в файл параметры:\n```\nnet.ipv4.ip_forward = 1net.ipv4.conf.all.accept_redirects = 0net.ipv4.conf.all.send_redirects = 0net.ipv4.conf.eth0.accept_redirects = 0net.ipv4.conf.eth0.send_redirects = 0\n```\n\nПримечание На практике имена локальных интерфейсов на удаленной стороне могут отличаться.\n3. Примените изменения:\n```\nsudo sysctl -p /etc/sysctl.conf\n```\n8. Заполните файл конфигурации IPsec-туннеля:\n1. Откройте файл /etc/ipsec.conf для редактирования.\n```\nsudo nano /etc/ipsec.conf\n```\n2. Вставьте конфигурацию в файл:\n```\nconfig setup    strictcrlpolicy=yes    uniqueids=yes\nconn advanced-to-evo    type=tunnel    auto=start    keyexchange=ikev2    authby=secret    right=<right_public_ip>    rightsubnet=<right_subnet>    left=<left_internal_ip>    leftid=<left_public_ip>    leftsubnet=<left_subnet>    ike=aes256-sha2_256-modp1024!    esp=aes256-sha2_256!\n```\n\nГде:\n- <right_public_ip> — публичный IP-адрес ВМ cloud-gateway на платформе Evolution.\n- <right_subnet> — адрес подсети cloud-subnet на платформе Evolution.\n- <left_internal_ip> — внутренний IP-адрес ВМ remote-gateway.\n- <left_public_ip> — публичный IP-адрес ВМ remote-gateway.\n- <left_subnet> — адрес подсети remote-subnet.\nПри настройке удаленной стороны она становится левой стороной туннеля, а сторона облака Evolution становится правой стороной.\nПодробное описание параметров файла /etc/ipsec.conf смотрите в документации strongSwan.\n9. Заполните файл секретов:\n1. Откройте файл /etc/ipsec.secrets для редактирования:\n```\nsudo nano /etc/ipsec.secrets\n```\n2. Вставьте в файл ключевую фразу (PSK, Pre-Shared Key) туннеля:\n```\n<left_public_ip> <right_public_ip> : PSK \"<secret_phrase>\"\n```\n\nГде:\n- <left_public_ip> — публичный IP-адрес ВМ cloud-gateway на платформе Evolution.\n- <right_public_ip> — публичный IP-адрес ВМ remote-gateway.\n- <secret_phrase> — ключ для установки IPsec-соединения.\nУкажите такое же значение, как и в настройках облачного VPN-шлюза.\n10. Перезапустите strongSwan:\n```\nsudo systemctl restart strongswan-starter.service\n```\n11. Проверьте, что VPN-шлюз на стороне Advanced поднят, а IPsec-туннель установлен:\n```\nsudo ipsec status\n```\n\nРезультат:\n```\nSecurity Associations (1 up, 0 connecting):advanced-to-evo[2]: ESTABLISHED 110 seconds ago, 10.0.***.***[37.18.***.***]...176.108.***.***[176.108.***.***]advanced-to-evo{1}:  INSTALLED, TUNNEL, reqid 1, ESP in UDP SPIs: c9c35ad9_i c0c7b197_oadvanced-to-evo{1}:   10.0.***.***/24 === 172.31.***.***/24\n```\n\n### Проверьте работу шлюзов\nПроверьте, что на обоих VPN-шлюзах появилась возможность пинговать внутренний IP-адрес шлюза с противоположной стороны.\n1. На стороне платформы Evolution на ВМ cloud-gateway выполните команду:\n```\nping -c4 <remote_gateway_internal_ip>\n```\n\nГде <remote_gateway_internal_ip> — внутренний IP-адрес ВМ remote-gateway на платформе Advanced.\n2. На стороне платформы Advanced на ВМ remote-gateway выполните команду:\n```\nping -c4 <cloud_gateway_internal_ip>\n```\n\nГде <cloud_gateway_internal_ip> — внутренний IP-адрес ВМ cloud-gateway на платформе Evolution.\n\n## 5. Настройте маршрутизацию\nВ виртуальных сетях на обеих сторонах необходимо добавить статические маршруты.\nЭто позволит перенаправлять трафик с клиентских ВМ на противоположную сторону туннеля через внутренний интерфейс VPN-шлюза.\n\n### Настройте маршрутизацию в Evolution\n1. Перейдите в личный кабинет платформы Evolution.\n2. На верхней панели слева нажмите  и выберите Сеть → VPC.\n3. Выберите сеть cloud-vpc.\n4. Перейдите на вкладку Маршруты.\n5. Нажмите Создать маршрут.\n6. Укажите параметры маршрута:\n- Адрес назначения — адрес подсети remote-subnet на платформе Advanced.\n- Next Hop Type — Виртуальная машина.\n- Виртуальная машина — cloud-gateway.\n- Интерфейс — выберите интерфейс ВМ cloud-gateway, который подключен к подсети cloud-subnet.\n7. Нажмите Создать.\nДождитесь, когда статус маршрута сменится на «Активен».\n\n### Настройте маршрутизацию в Advanced\n1. Войдите в консоль управления Advanced:\n- через личный кабинет Cloud.ru;\n- как IAM-пользователь.\n2. В списке сервисов выберите Virtual Private Cloud.\n3. В меню слева выберите Route Tables.\n4. Нажмите Create Route Table.\n5. Укажите параметры таблицы маршрутизации:\n- Name — rtb-remote-vpc.\n- VPC — remote-vpc.\n6. Добавьте маршрут в таблицу:\n1. В блоке Route Settings нажмите Add Route.\n2. Укажите параметры маршрута:\n- Destination Type — IP address.\n- Destination — адрес подсети cloud-subnet на платформе Evolution.\n- Next Hop Type — Server.\n- Next Hop — remote-gateway.\n7. Нажмите OK.\n8. Во всплывающем окне нажмите Associate Subnet.\n9. На вкладке Associated Subnets нажмите Associate Subnet.\n10. Отметьте подсеть remote-subnet и нажмите OK.\n\n## 6. Проверьте сетевую связность\n1. Проверьте, что удаленный VPN-шлюз и удаленная клиентская ВМ доступны с облачной клиентской ВМ:\n1. Перейдите в личный кабинет платформы Evolution.\n2. На верхней панели слева нажмите  и выберите Инфраструктура → Виртуальные машины.\n3. Выберите виртуальную машину cloud-vm в списке.\n4. Перейдите на вкладку Серийная консоль.\n5. Введите логин и пароль, указанные при создании виртуальной машины.\n6. В терминале поочередно выполните команды:\n```\nping -c4 <remote_gateway_internal_ip>ping -c4 <remote_vm_internal_ip>\n```\n\nГде:\n- <remote_gateway_internal_ip> — внутренний IP-адрес ВМ remote-gateway на платформе Advanced.\n- <remote_vm_internal_ip> — внутренний IP-адрес ВМ remote-vm на платформе Advanced.\n2. Проверьте, что облачный VPN-шлюз и облачная ВМ доступны с удаленной клиентской ВМ:\n1. Войдите в консоль управления Advanced:\n- через личный кабинет Cloud.ru;\n- как IAM-пользователь.\n2. В списке сервисов выберите Elastic Cloud Server.\n3. Напротив виртуальной машины remote-vm нажмите Remote Login.\n4. Введите логин и пароль, указанные при создании виртуальной машины.\n5. В терминале поочередно выполните команды:\n```\nping -c4 <cloud_gateway_internal_ip>ping -c4 <cloud_vm_internal_ip>\n```\n\nГде:\n- <cloud_gateway_internal_ip> — внутренний IP-адрес ВМ cloud-gateway на платформе Evolution.\n- <cloud_vm_internal_ip> — внутренний IP-адрес ВМ cloud-vm на платформе Evolution.\nТеперь клиентские ВМ могут обмениваться трафиком с помощью настроенного IPsec-туннеля.\n\n## Результат\nВы научились настраивать защищенное соединение между инфраструктурой в облаке Cloud.ru Evolution и удаленной стороной.\n\n  [© 2025 Cloud.ru](https://cloud.ru)",
      "debug": {
        "start_page": 1,
        "end_page": 1
      }
    }
  ]
}