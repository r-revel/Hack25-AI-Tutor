{
  "title": "Подключение Managed Redis® к сервисам в кластере Managed Kubernetes",
  "chapters": [
    {
      "name": "Подключение Managed Redis® к сервисам в кластере Managed Kubernetes",
      "content": "Практические руководства Evolution    \n\n # Подключение Managed Redis® к сервисам в кластере Managed Kubernetes   Эта статья полезна?          \nС помощью этого руководства вы сконфигурируете Managed Redis® для хранения пользовательских сессий в сервисе, работающем в кластере Managed Kubernetes на платформе Cloud.ru Evolution.\nДля организации взаимодействия между Managed Kubernetes и сервисом Managed Redis® будет использована виртуальная сеть VPC и подсети.\nВы будете использовать следующие сервисы:\n- Artifact Registry для хранения, совместного использования и управления Docker-образами и Helm-чартами.\n- Managed Kubernetes — сервис управления кластерами Kubernetes на вычислительных ресурсах облака.\n- Managed Redis — хранилище данных в оперативной памяти.\n- sNAT-шлюзы — сервис управления сетевыми шлюзами облака.\n- Публичный IP-адрес — для доступа к сервису через интернет.\n- VPC — изолированная виртуальная сеть для создания безопасной инфраструктуры.\nШаги:\n1. Разверните необходимые ресурсы в облаке.\n2. Создайте приватный репозиторий в Artifact Registry и загрузите в него образ контейнера.\n3. Подключитесь с созданной ВМ к кластеру Managed Kubernetes.\n4. Разверните приложение в Managed Kubernetes.\n\n## Перед началом работы\n1. Зарегистрируйтесь в личном кабинете Cloud.ru.\nЕсли вы уже зарегистрированы, войдите под своей учетной записью.\n2. Создайте и загрузите SSH-ключ в облако.\n\n## 1. Разверните необходимые ресурсы в облаке\n1. Создайте VPC с названием redis-kubernetes-lab-vpc.\n2. Создайте подсеть:\n- Название: redis-kubernetes-lab-subnet.\n- VPC: redis-kubernetes-lab-vpc.\n- Адрес: 10.10.1.0/24.\nУбедитесь, что в личном кабинете на странице сервиса VPC:\n- отображается сеть redis-kubernetes-lab-vpc;\n- количество подсетей — 1;\n- подсеть redis-kubernetes-lab-subnet доступна.\n3. Создайте виртуальную машину со следующими параметрами:\n- Название: redis-kubernetes-lab-jump-server.\n- Публичные → Образ: Ubuntu 22.04.\n- Гарантированная доля vCPU: 10%.\n- vCPU: 1.\n- RAM: 1.\n- Подсеть с публичным IP.\n- VPC: redis-kubernetes-lab-vpc.\n- Подсеть: redis-kubernetes-lab-subnet.\n- Группы безопасности: SSH-access_ru.AZ-1.\nЕсли такой группы безопасности нет, создайте ее и разрешите подключение по SSH.\n- Метод аутентификации: публичный ключ и пароль.\n- Публичный ключ: публичная часть вашего SSH-ключа из сервиса «SSH-ключи».\n- Пароль: ваш пароль.\n- Имя хоста: redis-kubernetes-lab-jump-server.\nУбедитесь, что в личном кабинете на странице сервиса «Виртуальные машины» отображается виртуальная машина redis-kubernetes-lab-jump-server в статусе «Запущена».\n4. Создайте кластер Managed Redis со следующими параметрами:\n- Название кластера: redis-kubernetes-lab.\n- Версия Redis: v7.2.11.\n- vCPU: 2.\n- RAM: 4.\n- Сохранять данные на диске: включено.\n- Подсеть: redis-kubernetes-lab-subnet.\nУбедитесь, что в личном кабинете на странице сервиса «Managed Redis» отображается кластер redis-kubernetes-lab в статусе «Доступен».\n5. Создайте sNAT-шлюз со следующими параметрами:\n- Название: redis-kubernetes-lab.\n- VPC: redis-kubernetes-lab-vpc.\nУбедитесь, что в личном кабинете на странице сервиса «sNAT-шлюзы» отображается шлюз redis-kubernetes-lab в статусе «Создан».\n6. Создайте кластер Managed Kubernetes со следующими параметрами:\n- Название: redis-kubernetes-lab.\n- Зона доступности: совпадает с зоной доступности остальных сервисов.\n- Адрес подсети мастер-узлов: redis-kubernetes-lab-subnet.\n- Публичный IP-адрес: включено.\n- Группы узлов –> Адрес подсети узлов: redis-kubernetes-lab-subnet.\nУбедитесь, что в личном кабинете на странице сервиса «Managed Kubernetes» отображается кластер redis-kubernetes-lab в статусе «Запущено».\n\n## 2. Создайте приватный реестр в Artifact Registry и загрузите в него образ контейнера\n1. Создайте приватный реестр Artifact Registry.\n2. Пройдите аутентификацию.\n3. Соберите и загрузите образ в реестр Artifact Registry:\nИспользуйте наше демонстрационное приложение evo-managed-redis-sessions-management-lab.\n1. Для сборки и тегирования образа на локальном компьютере в Docker CLI или любом удобном терминале выполните команду:\n```\ndocker build --tag <registry_name>.cr.cloud.ru/evo-managed-redis-sessions-management-lab https://github.com/cloud-ru/evo-managed-redis-sessions-management-lab.git#main --platform linux/amd64\n```\n2. Для загрузки образа выполните команду:\n```\ndocker push <registry_name>.cr.cloud.ru/evo-managed-redis-sessions-management-lab:latest\n```\n\nУбедитесь, что в реестре появился репозиторий evo-managed-redis-sessions-management-lab с артефактами образа.\n\n## 3. Подключитесь с созданной ВМ к кластеру Managed Kubernetes\n1. Подключитесь к ВМ через серийную консоль.\n2. Активируйте сетевой интерфейс.\n3. Подключитесь к ВМ по SSH.\n4. На ВМ установите kubectl.\n5. На ВМ установите cloudlogin.\n6. Подключитесь с ВМ к кластеру Managed Kubernetes.\n\n## 4. Разверните приложение в Managed Kubernetes\n1. Создайте .env и откройте его для редактирования:\n```\nnano .env\n```\n2. Добавьте содержимое файла конфигурации:\n```\nREDIS_URL=redis://:<REDIS_PASSWORD>@<REDIS_IP>:6379\n```\n\nГде:\n- <REDIS_IP> — IP-адрес сервиса Managed Redis®.\n- <REDIS_PASSWORD> — пароль от кластера Managed Redis®.\n3. Создайте объект из файла конфигурации:\n```\nkubectl create secret generic containerapp-secret --from-env-file=.env\n```\n4. Создайте containerapp-deployment.yaml и откройте его для редактирования:\n```\nnano containerapp-deployment.yaml\n```\n5. Добавьте содержимое манифеста:\n```\napiVersion: apps/v1kind: Deploymentmetadata:  name: containerappspec:  replicas: 1  selector:    matchLabels:      app: lab-app  template:    metadata:      labels:      app: lab-app    spec:      containers:      - name: containerapp        image: <registry_name>.cr.cloud.ru/evo-managed-redis-sessions-management-lab:latest        ports:          - containerPort: 3000         imagePullPolicy: Always\n        envFrom:           - secretRef:                name: containerapp-secret\n```\n\nГде <registry_name> — название реестра Artifact Registry.\n6. Примените манифест при помощи команды:\n```\nkubectl apply -f containerapp-deployment.yaml\n```\n7. Чтобы создать внешний балансировщик нагрузки для доступа к приложению из интернета, создайте containerapp-lb.yaml и откройте его для редактирования:\n```\nnano containerapp-lb.yaml\n```\n8. Добавьте содержимое манифеста:\n```\napiVersion: v1kind: Servicemetadata:  name: containerapp-lb  annotations:    loadbalancer.mk8s.cloud.ru/type: \"external\"    loadbalancer.mk8s.cloud.ru/health-check-timeout-seconds: \"5\"    loadbalancer.mk8s.cloud.ru/health-check-interval-seconds: \"5\"    loadbalancer.mk8s.cloud.ru/health-check-unhealthy-threshold-count: \"4\"    loadbalancer.mk8s.cloud.ru/health-check-healthy-threshold-count: \"4\"spec:  type: LoadBalancer  selector:    app: lab-app  ports:    - port: 80      name: http      targetPort: 3000\n```\n9. Создайте балансировщик нагрузки при помощи команды:\n```\nkubectl apply -f containerapp-lb.yaml\n```\n10. Посмотрите созданные сервисы в кластере при помощи команды:\n```\nkubectl get svc\n```\nПосле создания внешнего балансировщика нагрузки платформа начнет создание объекта LoadBalancer.\nПосле того как балансировщик будет создан и получит публичный IP, IP-адрес отобразится в поле EXTERNAL-IP.\nЭто займет 5–10 минут.\nПосле получения IP-адреса проверьте доступность приложения — введите в адресную строку браузера: http://<EXTERNAL-IP>.\nПопробуйте зарегистрироваться в приложении и войти с вашим email и паролем.\n\n## Результат\nВы сконфигурировали Managed Redis® как хранилище сессий и связали его с сервисом, развернутом в кластере Managed Kubernetes.\n\n  [© 2025 Cloud.ru](https://cloud.ru)",
      "debug": {
        "start_page": 1,
        "end_page": 1
      }
    }
  ]
}