{
  "title": "Использование Managed Redis® как брокера сообщений",
  "chapters": [
    {
      "name": "Использование Managed Redis® как брокера сообщений",
      "content": "Практические руководства Evolution    \n\n # Использование Managed Redis® как брокера сообщений   Эта статья полезна?          \nС помощью этого руководства вы сконфигурируете Managed Redis® как брокер сообщений, связав его с сервисами publisher и subscriber, работающими на виртуальной машине Ubuntu 22.04.\nВы будете использовать виртуальную сеть VPC и подсети для связи виртуальной машины и сервиса Managed Redis®.\nВы будете использовать следующие сервисы:\n- Виртуальные машины — сервис, в рамках которого предоставляется виртуальная машина.\n- Managed Redis — хранилище данных в оперативной памяти.\n- Публичный IP-адрес — для доступа к сервису через интернет.\n- VPC — изолированная виртуальная сеть для создания безопасной инфраструктуры.\nШаги:\n1. Разверните необходимые ресурсы в облаке.\n2. Настройте окружение на виртуальной машине.\n3. Разработайте сервисы publisher и subscriber.\n4. Протестируйте работу очереди сообщений с Managed Redis.\n5. Удалите доступ по SSH для виртуальной машины.\n\n## Перед началом работы\n1. Зарегистрируйтесь в личном кабинете Cloud.ru.\nЕсли вы уже зарегистрированы, войдите под своей учетной записью.\n2. Создайте и загрузите SSH-ключ в облако.\n\n## 1. Разверните необходимые ресурсы в облаке\n1. Создайте виртуальную сеть с названием pub-sub-VPC.\n2. Создайте подсеть со следующими параметрами:\n- Название: pub-sub-subnet.\n- Адрес: 10.10.1.0/24.\n- VPC: pub-sub-VPC.\n- DNS-серверы :  8.8.8.8.\nУбедитесь, что в личном кабинете на странице сервиса VPC:\n- отображается сеть pub-sub-VPC;\n- количество подсетей — 1;\n- подсеть pub-sub-subnet доступна.\n3. Создайте виртуальную машину со следующими параметрами:\n- Название: pub-sub.\n- Образ: Публичные → Ubuntu 22.04.\n- Метод аутентификации: SSH-ключ и пароль.\n- SSH-ключ: ваш SSH-ключ.\n- Пароль: ваш пароль.\n- Имя хоста: pub-sub.\n- Подключить публичный IP: включено.\n- Тип IP-адреса: Прямой.\n- Группы безопасности: SSH-access_ru.AZ-1.\n- Подсеть: pub-sub-subnet.\n- Гарантированная доля vCPU: 10%.\n- vCPU: 1.\n- RAM: 1.\nУбедитесь, что в личном кабинете на странице сервиса «Виртуальные машины» отображается виртуальная машина pub-sub в статуса «Запущена».\n4. Создайте кластер Managed Redis со следующими параметрами:\n- Название кластера: pub-sub.\n- Версия Redis: v7.2.11.\n- vCPU: 2.\n- RAM: 4.\n- Подсеть: pub-sub-subnet.\nУбедитесь, что в личном кабинете на странице сервиса Managed Redis отображается кластер pub-sub в статусе «Доступен».\n\n## 2. Настройте окружение на виртуальной машине\n1. Подключитесь к виртуальной машине pub-sub через серийную консоль.\n2. Активируйте сетевой интерфейс:\n```\nsudo cloud-init cleansudo cloud-init init\n```\n3. Подключитесь к виртуальной машине pub-sub по SSH.\n4. Обновите систему и установите необходимые пакеты:\n```\nsudo apt update && sudo apt upgrade -ysudo apt install -y python3 python3-venv python3-pip\n```\n\n## 3. Разработайте сервисы publisher и subscriber\n1. Создайте директорию pubsub и перейдите в неё:\n```\nmkdir pubsubcd pubsub\n```\n2. Создайте файл publisher.py и вставьте в него следующий код:\n```\nnano publisher.py\n```\n\nСодержимое файла:\n```\nimport argparseimport jsonimport osimport sysimport uuidfrom datetime import datetime, timezone\nimport redisfrom dotenv import load_dotenv\ndef build_payload(message: str) -> str:   \"\"\"Return JSON-encoded message with id and timestamp.\"\"\"   return json.dumps(      {            \"id\": str(uuid.uuid4()),            \"timestamp\": datetime.now(timezone.utc).isoformat(),            \"message\": message,      }   )\ndef main() -> None:   load_dotenv()\n   parser = argparse.ArgumentParser(description=\"Publish a message to Redis.\")   parser.add_argument(      \"message\",      nargs=\"?\",      help=\"Message text; if omitted you will be prompted.\",   )   parser.add_argument(      \"--channel\",      default=os.getenv(\"CHANNEL\", \"messages\"),      help=\"Redis Pub/Sub channel name (default: messages)\",   )   args = parser.parse_args()\n   msg_text = args.message or input(\"Enter your message: \")\n   redis_url = os.getenv(\"REDIS_URL\", \"redis://localhost:6379/0\")   try:      r = redis.from_url(redis_url)      sent = r.publish(args.channel, build_payload(msg_text))   except redis.ConnectionError as exc:      print(f\"Redis connection failed: {exc}\", file=sys.stderr)      sys.exit(1)\n   print(      f\"Published to channel '{args.channel}' \"      f\"(delivered to {sent} subscriber[s]).\"   )\nif __name__ == \"__main__\":   main()\n```\n3. Создайте файл subscriber.py и вставьте в него следующий код:\n```\nnano subscriber.py\n```\n\nСодержимое файла:\n```\nimport argparseimport jsonimport osimport sys\nimport redisfrom dotenv import load_dotenv\ndef pretty_print(raw: bytes) -> None:   \"\"\"Attempt to pretty-print a JSON message; fall back to raw bytes.\"\"\"   try:      obj = json.loads(raw)      print(json.dumps(obj, indent=2))   except json.JSONDecodeError:      print(f\"[non-JSON] {raw!r}\")\ndef main() -> None:   load_dotenv()\n   parser = argparse.ArgumentParser(description=\"Subscribe to a Redis channel.\")   parser.add_argument(      \"--channel\",      default=os.getenv(\"CHANNEL\", \"messages\"),      help=\"Redis Pub/Sub channel name (default: messages)\",   )   args = parser.parse_args()\n   redis_url = os.getenv(\"REDIS_URL\", \"redis://localhost:6379/0\")   try:      r = redis.from_url(redis_url)      pubsub = r.pubsub(ignore_subscribe_messages=True)      pubsub.subscribe(args.channel)   except redis.ConnectionError as exc:      print(f\"Redis connection failed: {exc}\", file=sys.stderr)      sys.exit(1)\n   print(f\"Subscribed to '{args.channel}'. Waiting for messages…  (Ctrl+C to quit)\")   try:      for message in pubsub.listen():            if message and message.get(\"type\") == \"message\":               pretty_print(message[\"data\"])   except KeyboardInterrupt:      print(\"\\nExiting subscriber.\")\nif __name__ == \"__main__\":   main()\n```\n4. Создайте файл requirements.txt и вставьте следующее содержимое:\n```\nnano requirements.txt\n```\n\nСодержимое файла:\n```\nredis==6.2.0python-dotenv==1.0.1\n```\n5. Создайте файл .env и вставьте следующее содержимое:\n```\nnano .env\n```\n\nСодержимое файла:\n```\nREDIS_URL=redis://:<REDIS_PASSWORD>@<REDIS_IP>:6379\n```\n\nГде:\n- <REDIS_IP> — IP-адрес сервиса Managed Redis®.\n- <REDIS_PASSWORD> — пароль от кластера Managed Redis®.\nIP-адрес и пароль можно найти на странице информации о кластере в блоке Данные для подключения.\n6. Создайте и активируйте виртуальное окружение:\n```\npython3 -m venv venvsource venv/bin/activate\n```\n7. Установите зависимости:\n```\npip install -r requirements.txt\n```\n\n## 4. Протестируйте работу очереди сообщений с Managed Redis®\n1. Запустите сервис subscriber:\n```\npython subscriber.py\n```\n2. Откройте новое окно терминала, не закрывая текущий терминал.\n3. Подключитесь к виртуальной машине pub-sub по SSH.\n4. Перейдите в директорию с сервисами:\n```\ncd pubsub\n```\n5. Активируйте виртуальное окружение:\n```\nsource venv/bin/activate\n```\n6. Отправьте сообщение в очередь:\n```\npython publisher.py \"Hello from Ubuntu!\"\n```\n7. Переключитесь обратно на терминал 1 и проверьте, что сообщение успешно получено.\n\n## 5. Удалите доступ по SSH для виртуальной машины\nТак как для настроенного сервиса больше не требуется доступ по SSH, удалите доступ для повышения безопасности.\n1. В личном кабинете перейдите в сервис «Виртуальные машины» и выберите машину pub-sub, созданную на первом шаге.\n2. Перейдите в раздел Сетевые параметры.\n3. Нажмите на Изменить группы безопасности для публичного IP-адреса.\n4. Удалите группу «SSH-access_ru».\n5. Нажмите Сохранить.\n6. Попробуйте подключиться к виртуальной машине по SSH и убедитесь, что доступ отсутствует.\n\n## Результат\nВы сконфигурировали Managed Redis® как брокер сообщений, связали его с сервисами publisher и subscriber, работающими на виртуальной машине.\nВы получили опыт работы с очередями сообщений и безопасным доступом.\n\n  [© 2025 Cloud.ru](https://cloud.ru)",
      "debug": {
        "start_page": 1,
        "end_page": 1
      }
    }
  ]
}