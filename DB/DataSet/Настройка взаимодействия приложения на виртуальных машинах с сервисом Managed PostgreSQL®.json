{
  "title": "Настройка взаимодействия приложения на виртуальных машинах с сервисом Managed PostgreSQL®",
  "chapters": [
    {
      "name": "Настройка взаимодействия приложения на виртуальных машинах с сервисом Managed PostgreSQL®",
      "content": "Практические руководства Evolution    \n\n # Настройка взаимодействия приложения на виртуальных машинах с сервисом Managed PostgreSQL®   Эта статья полезна?          \nС помощью этого руководства вы развернете сервис сокращенных ссылок и настроите защищенную схему взаимодействия FastAPI-приложения с сервисом Managed PostgreSQL.\nВы выполните развертывание виртуальной машины Ubuntu 22.04, настройку сетей и групп безопасности, создание кластера PostgreSQL, установку и конфигурирование приложения и публикацию API за nginx с поддержкой Let’s Encrypt.\nВ результате вы получите надежную архитектуру: база данных доступна только по закрытому адресу, а доступ к приложению осуществляется по HTTPS.\nВы будете использовать следующие сервисы:\n- Виртуальная машина free tier — сервис, в рамках которого предоставляется бесплатная виртуальная машина с готовой конфигурацией.\n- Публичный IP-адрес для доступа к сервису через интернет.\n- Managed PostgreSQL — управляемая база данных PostgreSQL.\n- VPC — изолированная виртуальная сеть для создания безопасной инфраструктуры.\n- Бесплатный сервис nip.io для получения публичного доменного имени и сертификата.\nВы также можете использовать собственное зарегистрированное доменное имя и SSL-сертификат для организации доступа.\n- Nginx — веб-сервер для проксирования запросов и организации защищeнного HTTPS-доступа к приложению.\n- Let’s Encrypt — сервис для автоматического получения бесплатного SSL-сертификата.\nШаги:\n1. Разверните ресурсы в облаке.\n2. Настройте окружение на виртуальной машине.\n3. Разверните приложение.\n4. Настройте сервис, nginx и HTTPS.\n\n## Перед началом работы\nЗарегистрируйтесь в личном кабинете Cloud.ru.\nЕсли вы уже зарегистрированы, войдите под своей учетной записью.\n\n## 1. Разверните ресурсы в облаке\nСоздайте виртуальную сеть со следующими параметрами:\n1. В поле Название укажите название сети, например short-links-service-VPC.\n2. Создайте подсеть:\n1. В поле Название укажите short-link-service-subnet.\n2. В поле Адрес укажите 10.10.1.0/24.\n3. В поле VPC выберите short-links-service-VPC.\n4. В поле DNS-серверы укажите 8.8.8.8.\nСоздайте новую группу безопасности со следующими параметрами:\n1. Выберите Зону доступности, в которой необходимо разместить группу безопасности.\nУкажите ту же зону доступности, что выбрана для сети.\n2. Укажите Название группы безопасности, например short-links-service.\n3. Добавьте правила входящего и исходящего трафика.\nПравила входящего трафика:\n\n1. Протокол: TCP\n2. Порт: 443\n3. Тип источника: IP-адрес\n4. Источник: 0.0.0.0/0\n5. Протокол: TCP\n6. Порт: 80\n7. Тип источника: IP-адрес\n8. Источник: 0.0.0.0/0\n\nПравила исходящего трафика:\n\n1. Протокол: Любой\n2. Тип адресата: IP-адрес\n3. Адресат: 0.0.0.0/0\nСоздайте виртуальную машину со следующими параметрами:\n1. В поле Название укажите название виртуальной машины, например short-links-service.\n2. На вкладке Публичные выберите образ Ubuntu 22.04.\n3. Назначьте публичный IP-адрес виртуальной машине — оставьте включенной опцию Подключить публичный IP. Для виртуальной машины будет арендован и назначен прямой публичный IP.\n4. В поле Группы безопасности выберите группу безопасности short-link-service.\n5. В поле Логин укажите логин пользователя виртуальной машины, например user1.\n6. Выберите метод аутентификации — пароль.\n7. В поле Сетевые настройки выберите подсеть short-link-service-subnet.\n8. В поле Имя хоста укажите уникальное имя устройства, по которому можно идентифицировать виртуальную машину в сети, например short-links-service.\nСоздайте кластер Managed PostgreSQL со следующими параметрами:\n1. В поле Имя кластера укажите short-links-service.\n2. В поле Название базы данных укажите default.\n3. В поле Версия PostgreSQL выберите 16.\n4. В поле Режим выберите Стандарт.\n5. В поле Тип выберите Single.\n6. В поле Подсеть выберите short-link-service-subnet.\n7. Создайте пользователя:\n1. В поле Имя пользователя укажите short_links.\n2. Укажите пароль.\n8. Создайте базу данных:\n1. В поле Владелец выберите short_links.\n2. Название базы данных: shortener_db.\nУбедитесь, что в личном кабинете:\n1. На странице сервиса «VPC»:\n- отображается сеть short-links-service-VPC;\n- в списке подсетей отображается short-link-service-subnet.\n2. На странице сервиса «Группы безопасности»:\n- отображается группа безопасности short-links-service;\n- статус группы безопасности — «Создана».\n3. На странице сервиса «Виртуальные машины»:\n- отображается виртуальная машина short-links-service;\n- статус виртуальной машины — «Запущена».\n4. На странице сервиса «Managed PostgreSQL»:\n- отображается кластер short-links-service;\n- статус кластера — «Доступен».\n\n## 2. Настройте окружение на виртуальной машине\nНа этом шаге вы настроите систему и основные сетевые параметры виртуальной машины, установите необходимые пакеты и подготовите ее к запуску FastAPI-приложения.\n1. В личном кабинете перейдите к сервису «Виртуальные машины» и выберите машину short-links-service.\n2. Подключитесь к виртуальной машине через серийную консоль.\n3. Активируйте сетевой интерфейс по инструкции:\n```\nsudo cloud-init cleansudo cloud-init init\n```\n4. Обновите систему:\n```\nsudo apt update && sudo apt upgrade -y\n```\n5. Установите Python и базовые пакеты:\n```\nsudo apt install -y python3-venv build-essential nginx snapd ufw postgresql-clientsudo snap install core; sudo snap refresh coresudo snap install --classic certbotsudo ln -s /snap/bin/certbot /usr/bin/certbot\n```\n6. Настройте файрвол:\n```\nsudo ufw allow OpenSSHsudo ufw allow 'Nginx Full'sudo ufw enable\n```\n7. Проверьте установку Python, nginx, postgresql-client, ufw:\n```\npython3 --versionnginx -vsudo ufw status\n```\n\n## 3. Разверните приложение\nНа этом шаге вы развернете FastAPI-приложение, подготовите файлы и подключите приложение к кластеру Managed PostgreSQL.\n1. Подключитесь к виртуальной машине.\n2. Создайте директорию для приложения:\n```\ncd /home/user1mkdir short-links-servicecd short-links-service\n```\n3. Создайте файл сервера:\n```\nnano server.py\n```\n\nВставьте следующий код:\n```\nfrom fastapi import FastAPI, HTTPException, Dependsfrom fastapi.responses import RedirectResponsefrom sqlalchemy import create_engine, Column, String, DateTime, Integerfrom sqlalchemy.orm import declarative_basefrom sqlalchemy.orm import sessionmaker, Sessionfrom pydantic import BaseModel, HttpUrlfrom datetime import datetimeimport osimport secretsimport stringfrom typing import Optionalfrom dotenv import load_dotenv\nload_dotenv()\n# Конфигурация базы данныхDATABASE_URL = os.getenv(\"DATABASE_URL\", \"postgresql://user:password@localhost:5432/shortener_db\")\nengine = create_engine(DATABASE_URL)SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)Base = declarative_base()\n# Модель базы данныхclass URLModel(Base):    __tablename__ = \"urls\"\n    id = Column(Integer, primary_key=True, index=True)    original_url = Column(String, nullable=False)    short_code = Column(String, unique=True, index=True, nullable=False)    created_at = Column(DateTime, default=datetime.utcnow)    clicks = Column(Integer, default=0)\n# Создание таблицBase.metadata.create_all(bind=engine)\n# Pydantic моделиclass URLCreate(BaseModel):    original_url: HttpUrl\nclass URLResponse(BaseModel):    original_url: str    short_code: str    short_url: str    created_at: datetime    clicks: int\n    class Config:        from_attributes = True\n# FastAPI приложениеapp = FastAPI(    title=\"URL Shortener API\",    description=\"API для создания коротких ссылок\",    version=\"1.0.0\")\n# Dependency для получения сессии БДdef get_db():    db = SessionLocal()    try:        yield db    finally:        db.close()\n# Функция для генерации короткого кодаdef generate_short_code(length: int = 6) -> str:    \"\"\"Генерирует случайный короткий код из букв и цифр\"\"\"    characters = string.ascii_letters + string.digits    return ''.join(secrets.choice(characters) for _ in range(length))\n# Эндпоинты@app.get(\"/health\")async def health_check():    \"\"\"Проверка здоровья приложения\"\"\"    return {\"status\": \"healthy\", \"timestamp\": datetime.utcnow()}\n@app.get(\"/\")async def root():    return {        \"message\": \"URL Shortener API\",        \"version\": \"1.0.0\",        \"endpoints\": {            \"create\": \"POST /shorten\",            \"redirect\": \"GET /{short_code}\",            \"stats\": \"GET /stats/{short_code}\"        }    }\n@app.post(\"/shorten\", response_model=URLResponse)async def create_short_url(url_data: URLCreate, db: Session = Depends(get_db)):    \"\"\"Создание короткой ссылки\"\"\"\n    # Проверяем, не существует ли уже такой URL    existing_url = db.query(URLModel).filter(URLModel.original_url == str(url_data.original_url)).first()    if existing_url:        base_url = os.getenv(\"BASE_URL\", \"https://yourdomain.com\")        return URLResponse(            original_url=existing_url.original_url,            short_code=existing_url.short_code,            short_url=f\"{base_url}/{existing_url.short_code}\",            created_at=existing_url.created_at,            clicks=existing_url.clicks        )\n    # Генерируем уникальный короткий код    while True:        short_code = generate_short_code()        if not db.query(URLModel).filter(URLModel.short_code == short_code).first():            break\n    # Создаем запись в БД    db_url = URLModel(        original_url=str(url_data.original_url),        short_code=short_code    )    db.add(db_url)    db.commit()    db.refresh(db_url)\n    base_url = os.getenv(\"BASE_URL\", \"https://yourdomain.com\")    return URLResponse(        original_url=db_url.original_url,        short_code=db_url.short_code,        short_url=f\"{base_url}/{db_url.short_code}\",        created_at=db_url.created_at,        clicks=db_url.clicks    )\n@app.get(\"/{short_code}\")async def redirect_to_url(short_code: str, db: Session = Depends(get_db)):    \"\"\"Перенаправление на оригинальный URL\"\"\"\n    url_record = db.query(URLModel).filter(URLModel.short_code == short_code).first()    if not url_record:        raise HTTPException(status_code=404, detail=\"Ссылка не найдена\")\n    # Увеличиваем счетчик кликов    url_record.clicks += 1    db.commit()\n    return RedirectResponse(url=url_record.original_url, status_code=302)\n@app.get(\"/stats/{short_code}\", response_model=URLResponse)async def get_url_stats(short_code: str, db: Session = Depends(get_db)):    \"\"\"Получение статистики по короткой ссылке\"\"\"\n    url_record = db.query(URLModel).filter(URLModel.short_code == short_code).first()    if not url_record:        raise HTTPException(status_code=404, detail=\"Ссылка не найдена\")\n    base_url = os.getenv(\"BASE_URL\", \"https://yourdomain.com\")    return URLResponse(        original_url=url_record.original_url,        short_code=url_record.short_code,        short_url=f\"{base_url}/{url_record.short_code}\",        created_at=url_record.created_at,        clicks=url_record.clicks    )\nif __name__ == \"__main__\":    import uvicorn    uvicorn.run(app, host=\"0.0.0.0\", port=8000)\n```\n4. Создайте файл зависимостей:\n```\nnano requirements.txt\n```\n\nСодержимое файла:\n```\nfastapi==0.104.1uvicorn[standard]==0.24.0sqlalchemy==2.0.23psycopg2-binary==2.9.9python-dotenv==1.0.0pydantic==2.5.0\n```\n5. Создайте и активируйте виртуальное окружение:\n```\npython3 -m venv venvsource venv/bin/activate\n```\n6. Установите зависимости:\n```\npip install -r requirements.txt\n```\n7. Добавьте переменные среды:\n```\nnano .env\n```\n\nВставьте содержимое в файл .env:\n```\nDATABASE_URL=postgresql://short_links:<PASSWORD>@<DB_PRIVATE_IP>:5432/shortener_dbBASE_URL=<IP-адрес>.nip.io\n```\n\nГде:\n- <PASSWORD> — пароль, который вы задали при создании пользователя базы данных.\n- <DB_PRIVATE_IP> — IP-адрес сервиса Managed PostgreSQL.\n- <IP-адрес> — публичный IP-адрес виртуальной машины.\n8. Запустите сервис:\n```\npython3 server.py\n```\n\n## 4. Настройте сервис, nginx и HTTPS\nВ этом шаге вы автоматически опубликуете API-приложение через системный сервис, настроите обратный прокси через nginx и выпустите бесплатный SSL-сертификат с помощью Let’s Encrypt.\n\n### Настройте сервис\n1. Подключитесь к виртуальной машине.\n2. Создайте спецификацию сервиса:\n```\nsudo nano /etc/systemd/system/short-links.service\n```\n\nВставьте в спецификацию следующее содержимое:\n```\n[Unit]Description=Short Links ServiceAfter=network.target\n[Service]User=user1Group=user1WorkingDirectory=/home/user1/short-links-serviceEnvironment=\"PATH=/home/user1/short-links-service/venv/bin\"EnvironmentFile=/home/user1/short-links-service/.envExecStart=/home/user1/short-links-service/venv/bin/uvicorn server:app --host 127.0.0.1 --port 8000Restart=always\n[Install]WantedBy=multi-user.target\n```\n\nПри необходимости замените user1 на имя своего пользователя.\n3. Запустите сервис:\n```\nsudo systemctl daemon-reloadsudo systemctl enable short-linkssudo systemctl start short-links\n```\n4. Проверьте статус сервиса:\n```\nsudo systemctl status short-links\n```\n5. Убедитесь, что сервис находится в статусе «active (running)».\n\n### Зарегистрируйте бесплатный домен\n1. В сервисе виртуальных машин скопируйте публичный IP-адрес вашей виртуальной машины.\n2. Сформируйте доменное имя по шаблону <IP-адрес>.nip.io (например, 1.2.3.4.nip.io).\n3. Проверьте, что в браузере по адресу http://<IP-адрес>.nip.io загружается страница Welcome to nginx.\n\n### Настройте nginx\n1. Подключитесь к виртуальной машине.\n2. Создайте конфигурационный файл:\n```\nsudo nano /etc/nginx/sites-available/short-links-service.conf\n```\n3. Вставьте конфигурацию, заменив <IP-адрес> на IP-адрес вашей виртуальной машины.\n```\nserver {   listen 80;   server_name <IP-адрес>.nip.io www.<IP-адрес>.nip.io;\n   # Проксирование запросов к FastAPI   location / {      proxy_pass http://127.0.0.1:8000;      proxy_set_header Host $host;      proxy_set_header X-Real-IP $remote_addr;      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;      proxy_set_header X-Forwarded-Proto $scheme;      proxy_redirect off;   }\n   # Логи   access_log /var/log/nginx/short_links.log;   error_log /var/log/nginx/short_links_error.log;}\n```\n4. Примените конфигурацию и перезапустите nginx:\n```\nsudo ln -sf /etc/nginx/sites-available/short-links-service.conf /etc/nginx/sites-enabled/short-links-service.confsudo rm -f /etc/nginx/sites-enabled/defaultsudo nginx -tsudo systemctl reload nginx\n```\n5. Проверьте, что nginx работает:\n```\nsudo systemctl status nginx\n```\n\nCервис nginx должен быть в статусе «active (running)».\n6. Перейдите по адресу http://<IP-адрес>.nip.io/docs.\nОткроется документация API FastAPI по незащищенному протоколу HTTP.\n\n### Выпустите SSL сертификат и настройте HTTPS\n1. Подключитесь к виртуальной машине.\n2. Запустите команду для выпуска SSL-сертификата.\n```\nsudo certbot --nginx -d <DOMAIN> --redirect --agree-tos -m <EMAIL>\n```\n\nГде:\n- <DOMAIN> — ваш домен из nip.io.\n- <EMAIL> — ваш email.\n3. После успешного выпуска сертификата, перейдите по адресу https://<IP-адрес>.nip.io/docs.\nОткроется документация API FastAPI. В свойствах сайта браузер отметит соединение как безопасное.\n4. Проверьте работу API:\n1. В документации вызовите POST-запрос:\n```\n{   \"original_url\": \"https://console.cloud.ru/\"}\n```\n2. Вернется короткая ссылка.\n3. Перейдите по ссылке — должен открыться сайт https://console.cloud.ru/.\n\n## Результат\nВы реализовали инфраструктуру и приложение для сервиса сокращения ссылок в облаке с управляемой базой данных, надежной сетевой изоляцией и публикацией API по HTTPS.\nПолученные навыки помогут создавать сервисы с использованием управляемых баз данных и создавать безопасные облачные среды для приложений разного типа.\n\n  [© 2025 Cloud.ru](https://cloud.ru)",
      "debug": {
        "start_page": 1,
        "end_page": 1
      }
    }
  ]
}