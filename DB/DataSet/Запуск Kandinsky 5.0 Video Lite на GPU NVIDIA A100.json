{
  "title": "Запуск Kandinsky 5.0 Video Lite на GPU NVIDIA A100",
  "chapters": [
    {
      "name": "Запуск Kandinsky 5.0 Video Lite на GPU NVIDIA A100",
      "content": "Практические руководства Evolution    \n\n # Запуск Kandinsky 5.0 Video Lite на GPU NVIDIA A100   Эта статья полезна?          \nС помощью этого руководства вы развернете ComfyUI с поддержкой модели Kandinsky 5.0 Video Lite на виртуальной машине с GPU NVIDIA A100 в облаке Cloud.ru Evolution.\nМодель Kandinsky 5.0 Video Lite — это компактная, но мощная модель для генерации видео с открытым исходным кодом.\nОна позволяет генерировать видео длиной до 10 секунд в разрешении 768×512.\nТакже у модели есть оптимизированные версии (distilled), позволяющие ускорить инференс в 6 раз.\nВы научитесь:\n- развертывать виртуальную машину с графическим процессором NVIDIA A100;\n- устанавливать CUDA, Docker и ComfyUI;\n- загружать и настраивать Kandinsky 5.0 Video Lite в ComfyUI;\n- генерировать видео с помощью визуального интерфейса;\n- обеспечивать безопасный доступ к сервису через HTTPS.\nВы будете использовать следующие сервисы:\n- Виртуальные машины — сервис, в рамках которого предоставляется виртуальная машина с GPU.\n- Публичный IP-адрес для доступа к сервису через интернет.\n- Docker — система контейнеризации.\n- Docker Compose — инструмент для запуска и управления Docker-контейнерами.\n- Бесплатный сервис nip.io для получения публичного доменного имени и сертификата.\nВы также можете использовать собственное зарегистрированное доменное имя и SSL-сертификат для организации доступа.\n- Nginx — веб-сервер для проксирования запросов и организации защищeнного HTTPS-доступа к приложению.\n- Let’s Encrypt — сервис для автоматического получения бесплатного SSL-сертификата.\n- ComfyUI — визуальный интерфейс с открытым исходным кодом для запуска и управления диффузионными моделями генерации изображений и видео.\nПозволяет строить сложные рабочие процессы (workflows) в виде узлов и соединений, обеспечивая гибкость и контроль над генерацией.\nШаги:\n1. Разверните ресурсы в облаке.\n2. Настройте окружение на виртуальной машине.\n3. Настройте Nginx и HTTPS для ComfyUI.\n4. Разверните ComfyUI с моделью Kandinsky 5.\n5. Сгенерируйте видео в ComfyUI.\n6. Отключите доступ по SSH для виртуальной машины.\n\n## Перед началом работы\n1. Зарегистрируйтесь в личном кабинете Cloud.ru.\nЕсли вы уже зарегистрированы, войдите под своей учетной записью.\n2. Сгенерируйте ключевую пару и загрузите публичный ключ в Cloud.ru Evolution.\n\n## 1. Разверните ресурсы в облаке\nНа этом шаге вы создадите группу безопасности, подсеть и виртуальную машину.\n1. Создайте группу безопасности с названием vm-gpu-sg в зоне доступности ru.AZ-2 и добавьте в нее правила:\n Трафик Протокол Порт Тип источника/адресат Источник/Адресат ВходящийTCP443IP-адрес0.0.0.0/0ВходящийTCP80IP-адрес0.0.0.0/0Исходящий Любой Оставьте пустымIP-адрес0.0.0.0/0\n2. Создайте подсеть со следующими параметрами:\n- Название — vm-gpu-subnet.\n- VPC — Default.\n- Адрес — 10.10.1.0/24.\n- DNS-серверы — 8.8.8.8.\n3. Создайте виртуальную машину со следующими параметрами:\n- Название — vm-gpu.\n- Зона доступности — ru.AZ-2.\n- Графический процессор (GPU) — включите опцию.\n- Образ — публичный образ Ubuntu 22.04 with GPU.\n- Модель GPU — NVIDIA A100.\n- Загрузочный диск — укажите размер 350 ГБ.\n- Сетевой интерфейс — выберите тип Подсеть с публичным IP.\n- Подсеть — vm-gpu-subnet.\n- Публичный IP — оставьте Арендовать новый или выберите IP-адрес из списка арендованных.\n- Группы безопасности — добавьте vm-gpu-sg.\n- Метод аутентификации — Публичный ключ и Пароль.\n- Публичный ключ — укажите ключ, созданный ранее.\n- Пароль — задайте пароль пользователя.\nУбедитесь, что ресурсы созданы и отображаются в личном кабинете:\n1. На странице Инфраструктура → Виртуальные машины отображается виртуальная машина vm-gpu со статусом «Запущена».\n2. На странице Сети → Группы безопасности отображается группа безопасности vm-gpu-sg со статусом «Создана».\n\n## 2. Настройте окружение на виртуальной машине\nНа этом шаге вы установите необходимые пакеты и настроите систему на ВМ.\n1. Подключитесь к виртуальной машине vm-gpu через серийную консоль или по SSH.\n2. Обновите систему и установите необходимые зависимости:\n```\nsudo apt update && sudo apt upgrade -y &&\\sudo apt install -y curl apt-transport-https\\                   ca-certificates\\                   software-properties-common\\                   gnupg2\\                   lsb-release\n```\n3. Перезагрузите ВМ:\n```\nsudo reboot\n```\n4. Установите Docker:\n```\ncurl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpgecho \"deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable\" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/nullsudo apt updatesudo apt install docker-ce docker-ce-cli containerd.io -y\n```\n5. Дайте текущему пользователю права на запуск Docker:\n```\nsudo usermod -aG docker $USERnewgrp docker\n```\n6. Установите Docker Compose:\n```\nsudo apt-get install docker-compose -y\n```\n7. Проверьте, что Docker и Docker Compose установлены корректно:\n```\ndocker --versiondocker-compose version\n```\n8. Установите и запустите Nginx:\n```\nsudo apt install nginx -ysudo systemctl enable nginxsudo systemctl start nginx\n```\n9. Установите Let’s Encrypt и плагин для Nginx:\n```\nsudo apt install certbot python3-certbot-nginx -y\n```\n10. Установите NVIDIA Container Toolkit:\n```\ndistribution=$(. /etc/os-release;echo $ID$VERSION_ID)curl -s -L https://nvidia.github.io/nvidia-docker/gpgkey | sudo apt-key add -curl -s -L https://nvidia.github.io/nvidia-docker/$distribution/nvidia-docker.list | sudo tee /etc/apt/sources.list.d/nvidia-docker.listsudo apt-get updatesudo apt-get install -y nvidia-docker2sudo systemctl restart docker\n```\n\n## 3. Настройте Nginx и HTTPS для ComfyUI\nНа этом шаге вы настроите службу Nginx и обеспечите доступ по HTTPS.\n1. Подключитесь к виртуальной машине vm-gpu через серийную консоль или по SSH.\n2. Сконфигурируйте межсетевой экран:\n```\nsudo ufw allow OpenSSHsudo ufw allow 'Nginx Full'sudo ufw enable\n```\n3. Создайте конфигурационный файл Nginx:\n```\nsudo nano /etc/nginx/sites-available/comfyui.conf\n```\n4. Вставьте конфигурацию, заменив <ip_address> на значение публичного IP-адреса виртуальной машины:\n```\nserver {   listen 80;   server_name comfyui.<ip_address>.nip.io www.comfyui.<ip_address>.nip.io;\n   location / {      proxy_pass http://localhost:8080;      proxy_set_header Host $host;      proxy_set_header X-Real-IP $remote_addr;      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\nproxy_http_version 1.1;proxy_set_header Upgrade $http_upgrade;proxy_set_header Connection \"upgrade\";}}\n```\n5. Активируйте конфигурацию и перезапустите Nginx:\n```\nsudo ln -sf /etc/nginx/sites-available/comfyui.conf /etc/nginx/sites-enabled/comfyui.confsudo rm -f /etc/nginx/sites-enabled/defaultsudo nginx -tsudo systemctl reload nginx\n```\n6. Проверьте, что Nginx работает:\n```\nsudo systemctl status nginx\n```\n\nСервис Nginx должен быть в статусе «active (running)».\n7. Перейдите по адресу http://comfyui.<ip_address>.nip.io.\nОткроется страница с текстом «502 Bad Gateway».\n8. Выпустите SSL-сертификат:\n```\nsudo certbot --nginx -d comfyui.<ip_address>.nip.io --redirect --agree-tos -m <email>\n```\n\nГде:\n- <ip_address> — публичный IP-адрес виртуальной машины.\n- <email> — email для регистрации сертификата.\n9. Перейдите по адресу https://comfyui.<ip_address>.nip.io и убедитесь, что браузер отмечает соединение как безопасное.\n\n## 4. Разверните ComfyUI с моделью Kandinsky 5\nНа этом шаге вы развернете ComfyUI с помощью Docker Compose.\n1. Подключитесь к виртуальной машине vm-gpu через серийную консоль или по SSH.\n2. Создайте структуру проекта:\n```\nmkdir -p $HOME/comfyuicd $HOME/comfyui\n```\n3. Клонируйте репозиторий Kandinsky 5 и перейдите в него:\n```\ngit clone https://github.com/ai-forever/Kandinsky-5.gitcd Kandinsky-5\n```\n4. Загрузите модели Kandinsky 5 с помощью скрипта download_models.py:\n```\npip install huggingface_hubpython download_models.py\n```\n\nЧтобы не скачивать все модели, вы можете удалить ненужные внутри скрипта.\n5. Перенесите скачанные модели в директорию comfyui/models:\n```\nmkdir -p ~/comfyui/models/diffusion_modelsmkdir -p ~/comfyui/models/vaemkdir -p ~/comfyui/models/text_encodersmv weights/model ~/comfyui/models/diffusion_models/mv weights/vae ~/comfyui/models/vae/mv weights/text_encoder ~/comfyui/models/text_encoders/mv weights/text_encoder2 ~/comfyui/models/text_encoders/\n```\n6. Вернитесь в директорию comfyui:\n```\ncd ~/comfyui\n```\n7. Создайте папку output, в которую будут сохраняться сгенерированные видео:\n```\nmkdir ~/comfyui/output\n```\n8. Создайте файл docker-compose.yml:\n```\nsudo nano docker-compose.yml\n```\n9. Вставьте в созданный файл описание контейнера:\n```\nversion: '3.8'\nservices:  comfyui:    build:      context: .      dockerfile: Dockerfile    ports:      - \"8080:8188\"    volumes:      - ./models:/comfyui/models      - ./output:/comfyui/output    shm_size: '16gb'    deploy:      resources:        reservations:          devices:            - driver: nvidia              count: 1              capabilities: [gpu]    restart: unless-stopped\n```\n10. Создайте Dockerfile:\n```\nsudo nano Dockerfile\n```\n11. Вставьте содержимое:\n```\n# Используем CUDA-образ для A100FROM nvidia/cuda:12.4.1-devel-ubuntu22.04\n# Устанавливаем системные зависимостиRUN apt-get update && apt-get install -y \\    python3.10 \\    python3-pip \\    git \\    wget \\    ffmpeg \\    build-essential \\    --no-install-recommends && \\    rm -rf /var/lib/apt/lists/*\n# Добавляем символическую ссылку python → python3.10RUN ln -s /usr/bin/python3.10 /usr/bin/python\n# Устанавливаем pipRUN curl -sS https://bootstrap.pypa.io/get-pip.py | python\nWORKDIR /comfyui\n# =============== 1. Устанавливаем ComfyUI ===============RUN git clone https://github.com/comfyanonymous/ComfyUI.git .RUN pip install -r requirements.txt\n# =============== 2. Устанавливаем PyTorch с CUDA ===============RUN pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu121\n# =============== 3. Устанавливаем flash-attn ===============RUN pip install packaging && \\    pip install \"flash-attn>=2.0\" --no-build-isolation --no-use-pep517 --no-cache-dir\n# =============== 4. Клонируем kandinsky-5-inference в custom_nodes ===============RUN mkdir -p custom_nodesWORKDIR /comfyui/custom_nodes\nRUN git clone https://github.com/gen-ai-team/kandinsky-5-inference.git kandinsky\n# =============== 5. Устанавливаем зависимости плагина + omegaconf ===============WORKDIR /comfyui/custom_nodes/kandinskyRUN pip install -r requirements.txtRUN pip install omegaconf  # Требуется для nodes_kandinsky.py\n# =============== 6. Копируем workflow в ComfyUI ===============WORKDIR /comfyuiRUN mkdir -p workflowsRUN cp /comfyui/custom_nodes/kandinsky/comfyui/kandisnky5_lite_T2V.json workflows/kandisnky5_lite_T2V.json\n# =============== 7. Запускаем ComfyUI ===============EXPOSE 8188\nCMD [\"python\", \"main.py\", \"--listen\", \"0.0.0.0\", \"--port\", \"8188\", \"--gpu-only\", \"--use-flash-attention\"]\n```\n12. Создайте файл .dockerignore:\n```\nsudo nano .dockerignore\n```\n13. Вставьте содержимое:\n```\nmodels/output/.git__pycache__*.logtemp/logs/*.safetensors*.bin*.pt*.pth\n```\n14. Запустите сервис:\n```\ndocker-compose up -d\n```\n15. Проверьте, что сервис запущен:\n```\ndocker compose ps\n```\n\n## 5. Сгенерируйте видео в ComfyUI\n1. Перейдите по адресу https://comfyui.<ip_address>.nip.io.\nОткроется интерфейс ComfyUI.\n2. Скачайте файл конфигурации для моделей Kandinsky 5.\n3. Загрузите файл конфигурации: в меню ComfyUI нажмите File → Открыть.\n\nПосле этого у вас появится рабочий процесс для модели Kandinsky 5.\n4. Выберите необходимую модель для генерации из тех, что вы скачали ранее.\nНапример:\n- kandinsky5lite_t2v_sft_5s.safetensors — для лучшего качества.\n- kandinsky5lite_t2v_distilled16steps_5s.safetensors — в 6 раз быстрее, но без серьезной потери качества.\n\nПодробнее о моделях Kandinsky 5.\n5. Настройте ключевые параметры:\n- prompt — описание сцены, которую хотите увидеть.\nЧем детальнее, тем лучше: указывайте объекты, движение, стиль, освещение.\nПример:\n```\nA cat running through a sunlit forest, cinematic, 4K\n```\n- negative prompt — то, что нужно исключить: артефакты, деформации, нежелательные объекты.\nПример:\n```\nblurry, low quality, extra limbs, text\n```\n- width × height × length — размер кадра и количество кадров.\nУкажите:\n- Для 5-секундного видео: 768×512×121.\n- Для 10-секундного видео: 768×512×241.\nПримечание Для 10-секундного видео ширина и высота должны делиться на 128.\n- steps — число итераций генерации.\nУкажите 50 для SFT и Pretrain моделей, 16 — для distilled-версий.\n- cfg — параметр определяет, насколько строго модель следует промпту.\nРекомендуемое значение — 5.0.\nБолее высокие значения могут снизить качество.\n- scheduler_scale — управляет шумом и динамикой.\nДля 5-секундного видео укажите 5.0, для 10-секундного — 10.0.\n6. После введения промпта и выбора параметров нажмите кнопку Запустить.\n\nКогда генерация завершится, в ComfyUI отобразится превью, а оригинальное видео сохранится в директории /comfyui/output.\n\nПример сгенерированного видео.\n\n## 6. Отключите доступ по SSH для виртуальной машины\nКогда вы развернули и настроили сервис, закройте доступ по SSH для повышения безопасности.\n1. В личном кабинете на верхней панели слева нажмите  и выберите Инфраструктура → Виртуальные машины.\n2. В списке виртуальных машин выберите vm-gpu.\n3. Перейдите на вкладку Сетевые параметры.\n4. В блоке сетевого интерфейса нажмите  и выберите Изменить группы безопасности.\n5. Удалите группу SSH-access_ru и сохраните изменения.\n6. Убедитесь, что доступа нет — попробуйте подключиться к виртуальной машине по SSH.\nПосле отключения доступа по SSH, администрирование сервиса будет доступно через серийную консоль виртуальной машины.\n\n## Результат\nВы развернули ComfyUI с поддержкой Kandinsky 5.0 Video Lite на GPU NVIDIA A100 с доступом через HTTPS.\nВ нем вы можете:\n- Загружать workflow одним кликом.\n- Генерировать видео до 10 секунд по текстовому промпту.\n- Настраивать параметры: длину, шаги, CFG, разрешение.\n- Сохранять результаты в папку output на хосте.\nТеперь вы можете генерировать качественные короткие видео с помощью одной из самых передовых открытых видеомоделей в удобном интерфейсе ComfyUI.\n\n  [© 2025 Cloud.ru](https://cloud.ru)",
      "debug": {
        "start_page": 1,
        "end_page": 1
      }
    }
  ]
}