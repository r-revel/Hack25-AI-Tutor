{
  "title": "Развертывание Wiki-сервиса Outline на виртуальной машине",
  "chapters": [
    {
      "name": "Развертывание Wiki-сервиса Outline на виртуальной машине",
      "content": "Практические руководства Evolution    \n\n # Развертывание Wiki-сервиса Outline на виртуальной машине   Эта статья полезна?          \nС помощью этого руководства вы развернете Wiki-сервис для командной работы на бесплатной виртуальной машине.\nВы создадите виртуальную машину Ubuntu 22.04, настроите для нее публичный IP-адрес, создадите бакет в Object Storage и настроите CORS для него.\nНа виртуальной машине настроите Docker и Docker Compose, развернете сервис Outline, подключите его к Object Storage и GitLab и опубликуете на сервере nginx, выпустите SSL-сертификат в сервисе Let’s Encrypt.\nВ итоге получится надежная схема, где файлы хранятся в Object Storage, а клиентский трафик шифруется HTTPS.\nВы будете использовать следующие сервисы:\n- Виртуальная машина free tier — сервис, в рамках которого предоставляется бесплатная виртуальная машина с готовой конфигурацией.\n- Публичный IP-адрес для доступа к сервису через интернет.\n- Object Storage — объектное S3-хранилище с бесплатным хранением файлов, объемом до 15 ГБ.\n- Docker — система контейнеризации.\n- Docker Compose — инструмент для запуска и управления Docker-контейнерами.\n- Outline — open-source система вики.\n- Бесплатный сервис nip.io для получения публичного доменного имени и сертификата.\nВы также можете использовать собственное зарегистрированное доменное имя и SSL-сертификат для организации доступа.\n- Nginx — веб-сервер для проксирования запросов и организации защищeнного HTTPS-доступа к приложению.\n- Let’s Encrypt — сервис для автоматического получения бесплатного SSL-сертификата.\n- GitLab — как провайдер для авторизации.\nСписок других доступных провайдеров можно найти в документе по аутентификации Outline.\nШаги:\n1. Разверните необходимые ресурсы в облаке.\n2. Настройте окружение на виртуальной машине.\n3. Настройте nginx и HTTPS.\n4. Настройте приложение в GitLab.\n5. Разверните приложение.\n6. Настройте CORS в Object Storage.\n7. Удалите доступ по SSH для виртуальной машины.\n\n## Перед началом работы\n1. Зарегистрируйтесь в личном кабинете Cloud.ru.\nЕсли вы уже зарегистрированы, войдите под своей учетной записью.\n2. Сгенерируйте SSH-ключ по инструкции.\n3. Загрузите публичную часть SSH-ключа в облако Cloud.ru Evolution по инструкции.\n\n## 1. Разверните ресурсы в облаке\nВ этом шаге вы создадите группу безопасности, виртуальную машину и бакет в Object Storage.\nСоздайте новую группу безопасности со следующими параметрами:\n1. Укажите Название группы безопасности, например  outline-wiki.\n2. Добавьте правила входящего и исходящего трафика.\nПравила входящего трафика:\n1. Протокол: TCP\n2. Порт: 443\n3. Тип источника: IP-адрес\n4. Источник: 0.0.0.0/0\n1. Протокол: TCP\n2. Порт: 80\n3. Тип источника: IP-адрес\n4. Источник: 0.0.0.0/0\nПравила исходящего трафика:\n1. Протокол: Любой\n2. Тип адресата: IP-адрес\n3. Адресат: 0.0.0.0/0\nУбедитесь, что в личном кабинете на странице сервиса «Группы безопасности»:\n\n- отображается группа безопасности outline-wiki;\n- статус группы безопасности — «Создана».\n\nСоздайте бесплатную виртуальную машину со следующими параметрами:\n1. В поле Название укажите название виртуальной машины, например outline-wiki.\n2. На вкладке Публичные выберите образ Ubuntu 22.04.\n3. В поле Логин укажите логин пользователя виртуальной машины, например outline.\n4. В разделе Метод аутентификации выберите публичный ключ и пароль.\n5. Укажите публичный ключ и ваш пароль для создаваемого пользователя.\n6. В поле Имя хоста укажите уникальное имя устройства, по которому можно идентифицировать виртуальную машину в сети, например outline-wiki.\n7. В поле Название загрузочного диска укажите outline-wiki-disk.\n8. Включите опцию Подключить публичный IP.\n9. В группе Тип IP-адреса выберите Прямой.\n10. Выберите группы безопасности SSH-access_ru.AZ-1, outline-wiki.\nУбедитесь, что в личном кабинете на странице сервиса «Виртуальные машины»:\n\n- отображается виртуальная машина outline-wiki;\n- статус виртуальной машины — «Запущена».\n\nСоздайте бакет в Object Storage со следующими параметрами:\n1. В поле Доменное имя укажите outline-wiki (должно быть уникальным, замените на своё уникальное значение).\n2. В поле Название укажите outline-wiki (совпадает с доменным именем).\n3. В поле Глобальное название укажите outline-wiki (совпадает с доменным именем).\n4. В поле Класс хранения по умолчанию выберите стандартный.\n5. В поле Максимальный размер укажите 10 ГБ.\nПерейдите в раздел Object Storage API. Сохраните значения ID тенанта и Регион.\nУбедитесь, что в личном кабинете на странице сервиса «Object Storage» отображается бакет outline-wiki.\nСоздайте сервисный аккаунт администратора со следующими параметрами:\n1. В поле Название укажите outline-object-storage-admin.\n2. В поле Описание укажите «Аккаунт администратора Object Storage».\n3. В поле Проект выберите Пользователь сервисов.\n4. Оставьте список Сервисы пустым.\n5. В разделе Evolution Object Storage Роли выберите s3e.admin.\nСледуя аналогичной инструкции, создайте сервисный аккаунт пользователя со следующими параметрами:\n1. В поле Название укажите outline-object-storage.\n2. В поле Описание укажите «Аккаунт пользователя Object Storage».\n3. В поле Проект выберите Пользователь сервисов.\n4. Оставьте список Сервисы пустым.\n5. В поле Evolution Object Storage Роли выберите s3e.viewer, s3e.editor.\nСгенерируйте ключи доступа для обоих аккаунтов.\nСохраните Secret ID и Secret Key для обоих ключей.\n\n## 2. Настройте окружение на виртуальной машине\nНастройте систему и установите необходимые пакеты на виртуальной машине.\n1. Подключитесь к виртуальной машине outline-wiki через серийную консоль или по SSH.\n2. Обновите систему и установите необходимые зависимости:\n```\nsudo apt update && sudo apt upgrade -ysudo apt install unzip gnupg software-properties-common apt-transport-https ca-certificates python3-pip nginx snapd -ysudo snap install core; sudo snap refresh coresudo snap install --classic certbotsudo ln -s /snap/bin/certbot /usr/bin/certbot\n```\n3. Установите Docker и Docker Compose:\n```\n# Add Docker's GPG keycurl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg\n# Add Docker repositoryecho \"deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable\" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null\n# Install Dockersudo apt update && sudo apt install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin docker-compose\n# Add user to docker groupsudo usermod -aG docker $USERnewgrp docker\n```\n4. Проверьте, что Docker установлен корректно:\n```\ndocker --versiondocker compose version\n```\n\n## 3. Настройте nginx и HTTPS\nНастройте службу nginx и обеспечьте доступ по HTTPS.\n1. Подключитесь к виртуальной машине outline-wiki через серийную консоль или по SSH.\n2. Сконфигурируйте файрвол:\n```\nsudo ufw allow OpenSSHsudo ufw allow 'Nginx Full'sudo ufw enable\n```\n3. Создайте конфигурационный файл:\n```\nsudo nano /etc/nginx/sites-available/outline.conf\n```\n4. Вставьте конфигурацию, заменив <IP-адрес> на IP-адрес вашей виртуальной машины.\n```\nserver {   listen 80;   server_name wiki.<IP-адрес>.nip.io www.wiki.<IP-адрес>.nip.io;\n   location / {       proxy_pass http://localhost:3000/;       proxy_set_header Upgrade $http_upgrade;       proxy_set_header Connection \"Upgrade\";       proxy_set_header Host $host;       proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;       proxy_set_header X-Real-IP $remote_addr;       proxy_set_header X-Scheme $scheme;       proxy_set_header X-Forwarded-Proto $scheme;       proxy_redirect off;   }}\n```\n5. Примените конфигурацию и перезапустите nginx:\n```\nsudo ln -sf /etc/nginx/sites-available/outline.conf /etc/nginx/sites-enabled/outline.confsudo rm -f /etc/nginx/sites-enabled/defaultsudo nginx -tsudo systemctl reload nginx\n```\n6. Проверьте, что nginx работает:\n```\nsudo systemctl status nginx\n```\n\nCервис nginx должен быть в статусе «active (running)».\n7. Перейдите по адресу http://wiki.<IP-адрес>.nip.io.\nОткроется страница с текстом 502 Bad Gateway.\n8. Запустите команду для выпуска SSL-сертификата.\n```\nsudo certbot --nginx -d wiki.<IP-адрес>.nip.io --redirect --agree-tos -m <EMAIL>\n```\n\nГде:\n- <IP-адрес> — IP-адрес вашей виртуальной машины.\n- <EMAIL> — ваш email.\n9. После успешного выпуска сертификата, перейдите по адресу https://wiki.<IP-адрес>.nip.io.\nОткроется страница с текстом 502 Bad Gateway.\nВ свойствах сайта браузер отметит соединение как безопасное.\n\n## 4. Настройте приложение в GitLab\nСоздайте приложение в вашем GitLab-инстансе для интеграции с Outline.\n1. Перейдите в Настройки → Приложения в собственном или облачном GitLab-инстансе.\n2. Создайте новое приложение со следующими настройками:\n- Имя: Outline\n- Redirect URI: https://wiki.<IP-адрес>.nip.io/auth/oidc.callback (замените значения IP-адрес)\n- Scopes: Выберите openid, profile и email\n3. Сохраните приложение.\n4. Сохраните значения Application ID и Secret, они понадобятся в дальнейшем.\n\n## 5. Разверните приложение\nРазверните серверное приложение Outline с помощью Docker Compose.\n1. Подключитесь к виртуальной машине outline-wiki через серийную консоль или по SSH .\n2. Создайте структуру проекта:\n```\nmkdir -p $HOME/outlinecd $HOME/outline\n```\n3. Сгенерируйте уникальные ключи и сохраните их, они понадобятся в дальнейшем:\n```\n# Generate two random secrets for Outlineopenssl rand -hex 32  # Save this as SECRET_KEYopenssl rand -hex 32  # Save this as UTILS_SECRET\n# Generate database passwordopenssl rand -base64 15  # Save this as POSTGRES_PASSWORD\n```\n4. Создайте файл docker-compose.yml:\n```\nnano docker-compose.yml\n```\n5. Вставьте содержимое в файл docker-compose.yml, заменив переменные на значения:\n```\nservices:  outline:    image: flameshikari/outline-ru:0.86.0    env_file: ./docker.env    ports:      - \"3000:3000\"    volumes:      - storage-data:/var/lib/outline/data    depends_on:      - postgres      - redis    environment:      PGSSLMODE: disable\n  redis:    image: redis:7-alpine    ports:      - \"6379:6379\"    command: [\"redis-server\", \"--bind\", \"0.0.0.0\", \"--port\", \"6379\"]    healthcheck:      test: [\"CMD\", \"redis-cli\", \"ping\"]      interval: 10s      timeout: 30s      retries: 3\n  postgres:    image: postgres:15    env_file: ./docker.env    ports:      - \"5432:5432\"    volumes:      - database-data:/var/lib/postgresql/data    healthcheck:      test: [\"CMD\", \"pg_isready\", \"-d\", \"outline\", \"-U\", \"user\"]      interval: 30s      timeout: 20s      retries: 3    environment:      POSTGRES_USER: 'user'      POSTGRES_PASSWORD: <POSTGRES_PASSWORD>      POSTGRES_DB: 'outline'\nvolumes:  storage-data:  database-data:\n```\n\nГде <POSTGRES_PASSWORD> — пароль от базы данных, сгенерированный ранее.\n6. Создайте конфигурацию Redis:\n```\nnano redis.conf\n```\n7. Вставьте содержимое в файл:\n```\nbind 127.0.0.1port 6379timeout 0save 900 1save 300 10save 60 10000dbfilename dump.rdbdir ./\n```\n8. Создайте файл docker.env:\n```\nnano docker.env\n```\n9. Вставьте содержимое в файл, заменив переменные на значения:\n```\nNODE_ENV=production\n# Application URLURL=https://wiki.<IP-адрес>.nip.ioPORT=3000\n# Secrets (use the generated values from Step 6)SECRET_KEY=<SECRET_KEY>UTILS_SECRET=<UTILS_SECRET>\n# Database configurationDATABASE_URL=postgres://user:<POSTGRES_PASSWORD>@postgres:5432/outlinePGSSLMODE=disable\n# Redis configurationREDIS_URL=redis://redis:6379\n# File storage (using AWS S3)FILE_STORAGE=s3AWS_ENDPOINT_URL_S3=https://s3.cloud.ruAWS_SDK_LOAD_CONFIG=1AWS_USE_GLOBAL_ENDPOINT=falseAWS_S3_ADDRESSING_STYLE=pathAWS_ACCESS_KEY_ID=<TENANT_ID>:<SECRET_KEY_ID>AWS_SECRET_ACCESS_KEY=<SECRET_KEY>AWS_REGION=<REGION>AWS_S3_CUSTOM_DOMAIN=<BUCKET_NAME>.s3.cloud.ruAWS_S3_ENDPOINT=https://<BUCKET_NAME>.s3.cloud.ruAWS_S3_UPLOAD_BUCKET_URL=https://<BUCKET_NAME>.s3.cloud.ruAWS_S3_UPLOAD_BUCKET_NAME=<BUCKET_NAME>AWS_S3_FORCE_PATH_STYLE=falseAWS_S3_ACL=privateFILE_STORAGE_UPLOAD_MAX_SIZE=26214400AWS_S3_SIGNATURE_VERSION=v4\n# GitLab OIDC AuthenticationOIDC_CLIENT_ID=<GITLAB_APP_ID>OIDC_CLIENT_SECRET=<GITLAB_CLIENT_SECRET>OIDC_AUTH_URI=https://<GITLAB_DOMAIN>/oauth/authorizeOIDC_TOKEN_URI=https://<GITLAB_DOMAIN>/oauth/tokenOIDC_USERINFO_URI=https://<GITLAB_DOMAIN>/oauth/userinfoOIDC_USERNAME_CLAIM=usernameOIDC_DISPLAY_NAME=GitLabOIDC_SCOPES=openid email profile\n# SSL ConfigurationFORCE_HTTPS=true\n# Rate limitingRATE_LIMITER_ENABLED=trueRATE_LIMITER_REQUESTS=1000RATE_LIMITER_DURATION_WINDOW=60\n# UpdatesENABLE_UPDATES=true\n# LoggingDEBUG=httpLOG_LEVEL=info\n```\n\nГде:\n- <SECRET_KEY>, <UTILS_SECRET> — секреты, сгенерированные на шаге 5.\n- <POSTGRES_PASSWORD> — пароль от базы данных, сгенерированный ранее.\n- <TENANT_ID> — ID тенанта сервиса Object Storage.\n- <REGION> — регион Object Storage.\n- <SECRET_KEY_ID>, <SECRET_KEY> — ID ключа и секретный ключ доступа к Object Storage.\nИспользуйте ключи от аккаунта outline-object-storage.\n- <BUCKET_NAME> — название бакета Object Storage.\n- <GITLAB_APP_ID>, <GITLAB_CLIENT_SECRET> — ID и секретный ключ доступа к приложению GitLab.\n- <GITLAB_DOMAIN> — адрес сервиса GitLab.\nМожет быть собственный или https://gitlab.com/.\n10. Запустите сервис:\n```\ndocker compose up -d\n```\n11. Проверьте, что сервисы запущены:\n```\ndocker compose ps\n```\n12. Перейдите по адресу https://wiki.<IP-адрес>.nip.io.\nОткроется страница Outline, и вы будете перенаправлены в GitLab для авторизации.\n13. Авторизуйтесь в GitLab, и вы будете автоматически перенаправлены на страницу Outline.\n\n## 6. Настройте CORS в Object Storage\nНастройте CORS для бакета в Object Storage, чтобы разрешить безопасное взаимодействие с вашим приложением.\n1. Подключитесь к виртуальной машине outline-wiki через серийную консоль или по SSH .\n2. Установите зависимости командой:\n```\npip install boto3\n```\n3. Создайте файл configure_cors.py и добавьте в него код:\n```\nnano configure_cors.py\n```\n4. Вставьте содержимое в файл конфигурации:\n```\nimport sysimport boto3from botocore.client import Config\nBUCKET = sys.argv[1]ENDPOINT = sys.argv[2]AK = sys.argv[3]SK = sys.argv[4]REGION = sys.argv[5]FRONTEND_URL = sys.argv[6]\ns3 = boto3.client(    service_name='s3',    aws_access_key_id=AK,    aws_secret_access_key=SK,    endpoint_url=ENDPOINT,    region_name=REGION,    verify=False,    config=Config(s3={'addressing_style': 'virtual'}))\ncors_configuration = {    'CORSRules': [{        'AllowedMethods': ['PUT', 'POST'],        'AllowedOrigins': [FRONTEND_URL],        'ExposeHeaders': ['ETag'],        'AllowedHeaders': ['*'],        'MaxAgeSeconds': 60    }]}\ns3.put_bucket_cors(Bucket=BUCKET, CORSConfiguration=cors_configuration)\n```\n5. Запустите команду для обновления CORS правил:\n```\npython3 configure_cors.py <BUCKET_NAME> https://s3.cloud.ru <TENANT_ID>:<SECRET_KEY_ID> <SECRET_KEY> <REGION> https://wiki.<IP-адрес>.nip.io\n```\n\nГде:\n- <BUCKET_NAME> — название бакета Object Storage.\n- <TENANT_ID> — ID тенанта сервиса Object Storage.\n- <REGION> — регион Object Storage.\n- <SECRET_KEY_ID>, <SECRET_KEY> — ID ключа и секретный ключ доступа к Object Storage.\nИспользуйте ключи от аккаунта outline-object-storage-admin.\n6. Перейдите по адресу http://<IP-адрес>.nip.io.\nОткроется страница Outline.\n7. Создайте новую заметку и загрузите в нее изображение.\n\n## 7. Удалите доступ по SSH для виртуальной машины\nОбеспечьте безопасность, удалив доступ по SSH для вашей виртуальной машины, поскольку он больше не требуется.\n1. Перейдите в раздел Сетевые параметры.\n2. Нажмите изменить группы безопасности для публичного IP-адреса.\n3. Удалите группу SSH-access_ru.\n4. Нажмите Сохранить.\n5. Убедитесь, что доступа нет — попробуйте подключиться к виртуальной машине по SSH.\n\n## Результат\nВключитеы развернули Wiki-сервис для командной работы в облаке Cloud.ru с надежной сетевой изоляцией и публикацией по HTTPS.\nПолученные навыки помогут вам создавать сервисы с использованием облачного хранилища и безопасной инфраструктурой.\n\n  [© 2025 Cloud.ru](https://cloud.ru)",
      "debug": {
        "start_page": 1,
        "end_page": 1
      }
    }
  ]
}