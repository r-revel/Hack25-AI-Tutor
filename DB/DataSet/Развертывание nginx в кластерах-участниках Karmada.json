{
  "title": "Развертывание nginx в кластерах-участниках Karmada",
  "chapters": [
    {
      "name": "Развертывание nginx в кластерах-участниках Karmada",
      "content": "Практические руководства Evolution    \n\n # Развертывание nginx в кластерах-участниках Karmada   Эта статья полезна?          \nС помощью этого руководства вы развернете приложение nginx в кластерах-участниках платформы Karmada с помощью политики распространения ресурсов.\nВ результате вы получите опыт централизованного управления несколькими кластерами Kubernetes, настройки политик распределения ресурсов и проверки корректности работы приложения во всех выбранных кластерах.\nДоступ к nginx будет предоставляться только внутри кластера для целей демонстрации.\nНастройка сетевой связанности между кластерами-участниками в рамках этого сценария не выполняется.\nВы будете использовать следующие сервисы:\n- Managed Kubernetes — сервис управления кластерами Kubernetes на вычислительных ресурсах облака.\n- Виртуальные машины — сервис, в рамках которого предоставляется виртуальная машина для управления и подключения к кластерам Kubernetes.\n- Karmada — Kubernetes-совместимая платформа для централизованного управления и оркестрации приложений в мультикластерной инфраструктуре.\nШаги:\n1. Создайте манифест для развертывания nginx\n2. Настройте политику распространения ресурсов Karmada\n3. Примените манифесты через control-plane Karmada\n4. Проверьте развертывание и статус ресурсов\n5. Проверьте работу nginx в кластерах-участниках\n\n## Перед началом работы\n1. Зарегистрируйтесь в личном кабинете Cloud.ru.\nЕсли вы уже зарегистрированы, войдите под своей учетной записью.\n2. Разверните платформу Karmada по инструкции.\nУбедитесь, что k8s-кластеры evo1 и evo2 подключены как кластеры-участники в control-plane Karmada и доступны для дальнейшей работы.\n\n## 1. Создайте манифест для развертывания nginx\nСоздайте Kubernetes-манифесты для развертывания nginx и сервиса типа ClusterIP.\nЭти манифесты будут основой для дальнейшего управления их распространением через Karmada.\n1. Создайте директорию nginx-manifests в домашней директории пользователя:\n```\nmkdir $HOME/nginx-manifests\n```\n2. Создайте файл nginx-deployment.yaml со следующим содержимым:\n```\napiVersion: apps/v1kind: Deploymentmetadata:  name: nginx-deployment  namespace: default  labels:    app: nginxspec:  replicas: 1  selector:    matchLabels:      app: nginx  template:    metadata:      labels:        app: nginx    spec:      containers:      - name: nginx        image: nginx:1.25        ports:        - containerPort: 80        resources:          requests:            memory: \"64Mi\"            cpu: \"100m\"          limits:            memory: \"128Mi\"            cpu: \"200m\"---apiVersion: v1kind: Servicemetadata:  name: nginx-service  namespace: default  labels:    app: nginxspec:  type: ClusterIP  selector:    app: nginx  ports:  - name: http    port: 80    targetPort: 80    protocol: TCP\n```\n\nЭтот манифест создает в Kubernetes два ресурса:\n- Deployment с одной репликой контейнера nginx и ограничениями по ресурсам на pod.\n- Service типа ClusterIP для доступа к приложению nginx внутри кластера Kubernetes.\n3. Проверьте содержимое созданного файла:\n```\ncat $HOME/nginx-manifests/nginx-deployment.yaml\n```\n\nКоманда должна вывести YAML-манифесты Deployment и Service, которые были записаны на предыдущем шаге.\n\n## 2. Настройте политику распространения ресурсов Karmada\nНа этом этапе опишите политику распространения ресурсов (PropagationPolicy) для управления автоматическим размещением развертываемых ресурсов nginx в кластерах-участниках Karmada.\n1. В директории манифестов создайте файл nginx-propagation-policy.yaml со следующим содержимым:\n```\napiVersion: policy.karmada.io/v1alpha1kind: PropagationPolicymetadata:  name: nginx-propagation-policy  namespace: defaultspec:  resourceSelectors:    - apiVersion: apps/v1      kind: Deployment      name: nginx-deployment    - apiVersion: v1      kind: Service      name: nginx-service  placement:    clusterAffinity:      clusterNames:        - evo1        - evo2    replicaScheduling:      replicaSchedulingType: Duplicated\n```\n\nПараметры политики распространения определяют:\n- resourceSelectors — какие ресурсы (Deployment и Service nginx) распространять из control-plane Karmada;\n- clusterAffinity — список кластеров (evo1 и evo2), в которые отправлять ресурсы;\n- replicaSchedulingType: Duplicated — дублировать ресурсы во все указанные кластеры (дополнительно смотрите возможные режимы в документации Karmada: Duplicated или Weighted).\n2. Проверьте содержимое файла политики:\n```\ncat $HOME/nginx-manifests/nginx-propagation-policy.yaml\n```\n\n## 3. Примените манифесты через control-plane Karmada\nТеперь создайте ресурсы Deployment и Service в control-plane Karmada и включите их распространение в кластеры-участники с помощью PropagationPolicy.\n1. Убедитесь, что вы подключены к control-plane Karmada:\n```\nkarmadactl --karmada-context karmada-apiserver get clusters\n```\n\nКоманда должна вывести список кластеров-участников Karmada (ожидаются evo1 и evo2).\n2. Примените манифест развертывания nginx:\n```\nkarmadactl --karmada-context karmada-apiserver apply -f $HOME/nginx-manifests/nginx-deployment.yaml\n```\n\nНа этом этапе ресурсы Deployment и Service будут созданы в control-plane, но еще не распространены в кластеры-участники.\n3. Примените политику распространения PropagationPolicy:\n```\nkarmadactl --karmada-context karmada-apiserver apply -f $HOME/nginx-manifests/nginx-propagation-policy.yaml\n```\n\nПосле выполнения команды начнется процесс распространения ресурсов nginx в указанные кластеры-участники согласно правилам размещения.\n\n## 4. Проверьте развертывание и статус ресурсов\nПроверьте, что Karmada корректно распространила ресурсы nginx на все целевые кластеры, а сервисы и поды работают должным образом.\n1. Проверьте список развертываний:\n```\nkarmadactl --karmada-context karmada-apiserver get deployments\n```\n2. Проверьте статус подов nginx во всех кластерах-участниках:\n```\nkarmadactl --karmada-context karmada-apiserver get pods --operation-scope members\n```\n\nЭта команда выведет все поды во всех кластерах-участниках и позволит увидеть, как распределена нагрузка.\n3. Проверьте наличие и статусы сервисов nginx:\n```\nkarmadactl --karmada-context karmada-apiserver get services --operation-scope members\n```\n\nВ результатах должны отображаться сервисы nginx во всех кластерах-участниках.\n4. Проверьте политику распространения ресурсов:\n```\nkarmadactl --karmada-context karmada-apiserver get propagationpolicy nginx-propagation-policy -o yaml\n```\n\nЭта команда отобразит конфигурацию вашей политики распространения и текущий статус доставки ресурсов в кластеры.\n\n## 5. Проверьте работу nginx в кластерах-участниках\nТеперь проверьте, что приложение nginx корректно функционирует в каждом из кластеров evo1 и evo2, и сервис доступен на уровне кластера.\n1. Проверьте работу nginx в кластере evo1, выполнив команду:\n```\nkubectl --kubeconfig $HOME/join-clusters/evo1 run curl --rm -i --restart=Never --image=curlimages/curl -- curl http://nginx-service\n```\n\nВ ответе должна отобразиться страница приветствия nginx по умолчанию, что свидетельствует о корректном функционировании сервиса.\n2. Проверьте работу nginx в кластере evo2 аналогичной командой:\n```\nkubectl --kubeconfig $HOME/join-clusters/evo2 run curl --rm -i --restart=Never --image=curlimages/curl -- curl http://nginx-service\n```\n\n## Результат\nВы развернули приложение nginx с помощью централизованной платформы Karmada, создали политику автоматического распределения ресурсов и проверили работу развернутого сервиса в каждом из целевых кластеров.\n\n  [© 2025 Cloud.ru](https://cloud.ru)",
      "debug": {
        "start_page": 1,
        "end_page": 1
      }
    }
  ]
}