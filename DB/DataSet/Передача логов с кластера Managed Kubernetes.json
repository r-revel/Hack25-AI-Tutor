{
  "title": "Передача логов с кластера Managed Kubernetes",
  "chapters": [
    {
      "name": "Передача логов с кластера Managed Kubernetes",
      "content": "Практические руководства Evolution    \n\n # Передача логов с кластера Managed Kubernetes   Эта статья полезна?          \nС помощью инструкции подготовим и настроим передачу логов с кластера Managed Kubernetes в сервис «Клиентское логирование».\n\n## Перед началом работы\n1. Создайте и настройте лог-группу.\n2. Создайте сервисный аккаунт.\nВ блоке Доступы и роли выберите роли:\n- в блоке Проект — «Пользователь сервисов»;\n- в блоке Сервисы — «logaas.writer».\n3. Для сервисного аккаунта создайте ключи доступа.\n\n## Шаг 1. Выбор стратегии логирования\nВ инструкции рассмотрим две стратегии настройки логирования — с DaemonSet и с Sidecar.\nОтличия между ними:\n Характеристика Подход с DaemonSet Подход с Sidecar Использование ресурсов1 экземпляр на узел1 экземпляр на под Область сбора логов Логи всех подов на узле Только логи текущего пода Конфигурация Централизованная Индивидуальная для пода Оптимальный сценарий Логирование всего кластера Изоляция логов отдельных подов Масштабируемость Зависит от количества узлов Зависит от количества подов Задержка логирования Минимальная (локальный сбор)Возможна задержка из-за дополнительных шагов (сбор + передача)Надежность Высокая (отказоустойчивость на уровне узла, переживает перезапуски подов)Зависит от стабильности пода Сложность настройки Проще (единая конфигурация)Сложнее (индивидуальные настройки)Влияние на сеть Низкое (логи агрегируются на узле)Выше (каждый sidecar передает логи)Гибкость обработки Ограничена (общие правила)Высокая (возможность применять уникальные Lua-скрипты или фильтры для каждого пода)Безопасность Риск смешения логов Изоляция логов в рамках пода (меньше риск несанкционированного доступа и утечки)\nТаким образом, вам может подойти:\n- DaemonSet — для централизованного сбора логов всего кластера.\nЭто подходит для мониторинга системных компонентов или всех сервисов на узлах.\n- Sidecar — для изоляции логов отдельных подов.\nНапример, если вам нужна отдельная обработка логов для критичных микросервисов или мультитенантных сред.\n\n## Шаг 2. Определение структуры проекта\nВ процессе настройки передачи логов с кластера Managed Kubernetes вы создадите на вашем локальном компьютере или виртуальной машине следующие файлы:\n```\n├── app/                      # Ваше Python-приложение│   ├── generator.py          # Основной код приложения│   └── Dockerfile            # Dockerfile для сборки приложения├── fluent-bit-logaas/        # Кастомный образ Fluent Bit с плагином logaas│   └── Dockerfile            # Dockerfile для сборки fluent-bit-logaas│├── k8s/                      # Файлы конфигурации Kubernetes│   ├── deployment.yaml       # Основной Deployment приложения (без логирования)│   ├── service.yaml          # Конфигурация сервиса│   └── logging/              # Конфигурации для логирования│       ├── fluent-bit/│       │   ├── daemonset.yaml          # DaemonSet для Fluent Bit│       │   ├── configmap.yaml          # ConfigMap для Fluent Bit│       │   ├── fluent-bit.conf         # Основной конфиг Fluent Bit│       │   └── parsers.conf            # Дополнительные парсеры (опционально)│       ││       └── sidecar/                   # Альтернативный подход с sidecar│           └── deployment-with-sidecar.yaml # Deployment app с sidecar-контейнером\n```\n\n## Шаг 3. Подготовка окружения\nИсходные данные для развертывания можно подготовить в любой из сред: Windows, macOS, Linux на локальном устройстве, Linux на виртуальной машине.\nПО для управления развертыванием также доступно для всех сред.\n\n### Установка Docker\n- Windows/macOS: Docker Desktop (включает Docker Engine);\n- Linux: Docker Engine.\n\n### Создание Artifact Registry\n1. Создайте реестр в Artifact Registry.\nВ примере в инструкции мы назовем его your-registry.\n2. Создайте репозитории:\n\n- simple-logging-app — для приложения-генератора логов;\n- fluent-bit-logaas — для кастомизированного Fluent Bit.\nПример URL реестра: your-registry.cr.cloud.ru. Замените его на URL вашего реестра.\n\n### Настройка кластера Managed Kubernetes\n1. Создайте кластер Managed Kubernetes.\n2. Добавьте группу узлов.\n3. Подключитесь к кластеру.\n\n## Шаг 4. Создание базового приложения для генерации логов\nМодуль генератора логов app/generator.py:\n```\nimport randomimport jsonimport socketimport osfrom datetime import datetime, timezoneimport time\nLOG_LEVELS = ['DEBUG', 'INFO', 'WARN', 'ERROR', 'FATAL']MESSAGE_TEMPLATES = [    \"Data received [ID: {id}]\",    \"Processing request from user {user}\",    \"Failed to connect to database {db}\",    \"Connection timeout after {sec} seconds\",    \"File {file} not found\",    \"Authentication failed for {service}\",    \"Received {size} bytes from {ip}\",    \"Task {task} completed in {ms}ms\",    \"Cache miss for key {key}\",    \"Starting backup process {job_id}\"]\n\ndef generate_message():    template = random.choice(MESSAGE_TEMPLATES)    replacements = {        'id': lambda: random.randint(1000, 9999),        'user': lambda: f\"user_{random.randint(100, 999)}\",        'db': lambda: random.choice([\"primary\", \"replica\", \"archive\"]),        'sec': lambda: random.randint(1, 30),        'file': lambda: f\"/var/log/{random.choice(['app', 'system', 'auth'])}.log\",        'service': lambda: random.choice([\"API\", \"SSH\", \"Database\"]),        'size': lambda: random.randint(512, 4096),        'ip': lambda: \".\".join(map(str, [random.randint(1, 255) for _ in range(4)])),        'task': lambda: random.choice([\"cleanup\", \"backup\", \"sync\"]),        'ms': lambda: random.randint(100, 5000),        'key': lambda: hex(random.getrandbits(128))[2:10],        'job_id': lambda: f\"JOB-{random.randint(10000, 99999)}\"    }\n    return template.format(**{k: v() for k, v in replacements.items() if k in template})\n\ndef generate_log():    return {        \"timestamp\": datetime.now(timezone.utc).isoformat(timespec='milliseconds').replace('+00:00', 'Z'),        \"level\": random.choice(LOG_LEVELS),        \"labels\": {            \"app\": \"logger\",            \"host\": socket.gethostname(),            \"pid\": os.getpid(),            \"random\": random.randint(1, 1000)        },        \"message\": generate_message()    }\nif __name__ == \"__main__\":    while True:        log_entry = generate_log()        print(json.dumps(log_entry))        time.sleep(random.uniform(0.1, 2.0))\n```\n\nDocker-образ приложения app/Dockerfile:\n```\nFROM python:3.13-alpineWORKDIR /appCOPY log_generator.py .CMD [\"python\", \"./log_generator.py\"]\n```\n\n## Шаг 5. Сборка кастомизированного образа Fluent Bit\nDocker-образ с плагином logaas — fluent-bit-logaas/Dockerfile:\n```\nARG fluebtbit_ver=3.2.0\nFROM debian:bullseye-slim as builderRUN apt-get update && apt-get install -y --no-install-recommends \\    wget \\    ca-certificates \\ && rm -rf /var/lib/apt/lists/*\nWORKDIR /buildRUN wget https://github.com/CLOUDdotRu/fluent-bit-plugins/raw/main/logaas.so -O ./logaas.so\nFROM fluent/fluent-bit:${fluebtbit_ver} as fluentbitCOPY --from=builder /build/logaas.so /fluent-bit/bin/ENTRYPOINT [\"/fluent-bit/bin/fluent-bit\", \"-e\", \"/fluent-bit/bin/logaas.so\"]CMD [\"-c\", \"/fluent-bit/etc/fluent-bit.conf\"]\n```\n\n## Шаг 6. Публикация образов в Artifact Registry\nСборка и публикация образа приложения:\n```\ndocker build -t your-registry.cr.cloud.ru/simple-logging-app:latest -f app/Dockerfile app/docker push your-registry.cr.cloud.ru/simple-logging-app:latest\n```\n\nСборка и публикация кастомного образа Fluent Bit:\n```\ndocker build -t your-registry.cr.cloud.ru/fluent-bit-logaas:latest -f fluent-bit-logaas/Dockerfile fluent-bit-logaas/docker push your-registry.cr.cloud.ru/fluent-bit-logaas:latest\n```\n\nНе забудьте заменить URL реестра с your-registry.cr.cloud.ru на URL вашего реестра.\n\n## Шаг 7. Подготовка развертывания базового приложения в Managed Kubernetes\nСоздайте базовые файлы:\n- k8s/deployment.yaml:\n\n```\napiVersion: apps/v1kind: Deploymentmetadata:  name: python-appspec:  replicas: 2  selector:    matchLabels:      app: python-app  template:    metadata:      labels:        app: python-app    spec:      containers:      - name: main-app        image: your-registry.cr.cloud.ru/simple-logging-app:latest        ports:        - containerPort: 5000\n```\n- k8s/service.yaml:\n\n```\napiVersion: v1kind: Servicemetadata:  name: python-app-servicespec:  selector:    app: python-app  ports:    - protocol: TCP      port: 80      targetPort: 5000  type: LoadBalancer\n```\n\n## Шаг 8. Настройка развертывания логирования через Fluent Bit\nВыберите, какая стратегия настройки логирования подходит вам больше.\nМы рекомендуем подход с DaemonSet.\nПодход с DaemonSet Подход с SidecarВ этом варианте запускается один экземпляр Fluent Bit на каждом узле.\nДля этого подхода требуется доступ к логам узла: /var/log.\nЗаполните содержимое файлов:\n- k8s/logging/fluent-bit/configmap.yaml:\n```\napiVersion: v1kind: ConfigMapmetadata:  name: fluent-bit-config  labels:    k8s-app: fluent-bitdata:  fluent-bit.conf: |   [SERVICE]        Flush         5        Log_Level     info        Daemon        off        Parsers_File  /fluent-bit/etc/parsers.conf\n    [INPUT]        Name              tail        Path              /var/log/containers/*.log        Parser            docker        Tag               kube.*        Refresh_Interval  5\n    [FILTER]        Name                kubernetes        Match               kube.*        Kube_URL            https://kubernetes.default.svc:443        Kube_CA_File        /var/run/secrets/kubernetes.io/serviceaccount/ca.crt        Kube_Token_File     /var/run/secrets/kubernetes.io/serviceaccount/token        Kube_Tag_Prefix     kube.var.log.containers.        Merge_Log           On\n    [OUTPUT]        Name                    logaas        Match                   *        address                 https://console.cloud.ru/        iam_address             https://auth.iam.sbercloud.ru/        iam_client_id           REPLACE_TO_LOGGING_SA_KEY_ID        iam_client_secret       REPLACE_TO_LOGGING_SA_SECRET        default_project_id      REPLACE_TO_PROJECT_ID        default_group_id        REPLACE_TO_LOG_GROUP_ID        default_labels          {\"some_label\":\"default_value\"}\n```\n\nДобавьте в файл свои данные:\n\n- REPLACE_TO_LOGGING_SA_KEY_ID и REPLACE_TO_LOGGING_SA_SECRET — Key ID (логин) и Key Secret (пароль) сервисного аккаунта с ролью «logaas.writer» для получения токена и отправки логов.\nПроверьте, что у вас есть доступ к проекту, а для вашего сервисного аккаунта выбраны проект «Пользователь сервисов» и роль «logaas.writer».\n- REPLACE_TO_PROJECT_ID и REPLACE_TO_LOG_GROUP_ID — ID проекта и ID лог-группы, в которую будут отправлены логи.\n- default_labels — необязательный раздел. В нем вы можете указать метки, которые будут добавлены ко всем логам.\n- k8s/logging/fluent-bit/daemonset.yaml:\n```\napiVersion: apps/v1kind: DaemonSetmetadata:  name: fluent-bit  labels:    k8s-app: fluent-bitspec:  selector:    matchLabels:      k8s-app: fluent-bit  template:    metadata:      labels:        k8s-app: fluent-bit    spec:      containers:      - name: fluent-bit        image: your-registry.cr.cloud.ru/fluent-bit-logaas:latest        volumeMounts:        - name: varlog          mountPath: /var/log        - name: config          mountPath: /fluent-bit/etc/      volumes:      - name: varlog        hostPath:          path: /var/log      - name: config        configMap:          name: fluent-bit-config\n```\n\n## Шаг 9. Развертывание приложения и логирования в Managed Kubernetes\nПримечание Для PROD-стенда добавьте права RBAC для Fluent Bit.\n1. Разверните основное приложение:\n```\nkubectl apply -f k8s/deployment.yamlkubectl apply -f k8s/service.yaml\n```\n2. Разверните логирование Fluent Bit:\nПодход с DaemonSet Подход с Sidecar```\nkubectl apply -f k8s/logging/fluent-bit/configmap.yamlkubectl apply -f k8s/logging/fluent-bit/daemonset.yaml\n```\n\n## Шаг 10. Просмотр логов\nЛоги появятся в сервисе «Клиентское логирование» вскоре после успешного развертывания приложения и логирования.\nВы можете посмотреть логи в лог-группах.\nЛоги можно отфильтровать с помощью языка фильтрующих выражений и выгрузить как файл.\n\n## После окончания работы\nЕсли кластер Managed Kubernetes, реестр в Artifact Registry и его логи стали неактуальными, вы можете удалить их:\n- Удалить кластер Managed Kubernetes\n- Удалить реестр в Artifact Registry\n- Удалить лог-группу\n- Удалить проект\n\n  [© 2025 Cloud.ru](https://cloud.ru)",
      "debug": {
        "start_page": 1,
        "end_page": 1
      }
    }
  ]
}