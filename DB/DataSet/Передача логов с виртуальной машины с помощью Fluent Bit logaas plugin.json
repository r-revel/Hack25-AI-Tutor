{
  "title": "Передача логов с виртуальной машины с помощью Fluent Bit logaas plugin",
  "chapters": [
    {
      "name": "Передача логов с виртуальной машины с помощью Fluent Bit logaas plugin",
      "content": "Практические руководства Evolution    \n\n # Передача логов с виртуальной машины с помощью Fluent Bit logaas plugin   Эта статья полезна?          \nFluent Bit — кроссплатформенный инструмент с открытым исходным кодом.\nОн собирает, обрабатывает и фильтрует лог-сообщения из разных источников, а затем сохраняет их в хранилище.\nПосле этого лог-сообщения поступают в маршрутизатор, который определяет, куда они будут отправлены.\nДля работы с разными источниками и приемниками используются специализированные плагины.\n\n## Перед началом работы\n1. Создайте и настройте лог-группу.\n2. Создайте сервисный аккаунт.\nВ блоке Доступы и роли выберите роли:\n- в блоке Проект — «Пользователь сервисов»;\n- в блоке Сервисы — «logaas.writer».\n3. Для сервисного аккаунта создайте ключи доступа.\n4. Создайте виртуальную машину Ubuntu 22.04.\n5. Подключитесь к созданной виртуальной машине по SSH.\n\n## Шаг 1. Установка Fluent Bit\nУстановите Fluent Bit одним из способов:\nИз дистрибутиваAвтоматизированная установка Установка вручную Установите приложение Fluent Bit из сборки дистрибутива для вашей операционной системы.\n\nЧтобы проверить, что fluent-bit установлен корректно, нужно запустить его и убедиться, что он установлен как сервис.\nДля этого:\n1. Запустите fluent-bit как сервис:\n```\nsudo systemctl start fluent-bit\n```\n2. Проверьте статус сервиса fluent-bit — он должен быть активным:\n```\nsystemctl status fluent-bit\n```\n\nЕсли fluent-bit настроен верно, будет выведен статус в виде:\n```\n● fluent-bit.service - Fluent Bit     Loaded: loaded (/lib/systemd/system/fluent-bit.service; disabled; vendor preset: enabled)     Active: active (running) since Tue 2025-03-11 15:48:23 UTC; 3s ago       Docs: https://docs.fluentbit.io/manual/   Main PID: 34596 (fluent-bit)      Tasks: 8 (limit: 2323)     Memory: 9.4M        CPU: 70ms     CGroup: /system.slice/fluent-bit.service             └─34596 /opt/fluent-bit/bin/fluent-bit -c //etc/fluent-bit/fluent-bit.conf\n```\n3. После проверки сервиса fluent-bit остановите его, чтобы далее настроить на совместную работу с logaas:\n```\nsudo systemctl stop fluent-bit\n```\n\n## Шаг 2. Установка и настройка Fluent Bit logaas plugin\nFluent Bit logaas plugin — отдельная библиотека, которая подключается к fluent-bit и позволяет отправлять логи в сервис Клиентского логирования.\nЧтобы установить плагин:\n1. Скачайте скомпилированный плагин logaas.so и поместите его в папку настроек fluent-bit:\n```\nsudo wget https://github.com/CLOUDdotRu/fluent-bit-plugins/raw/main/logaas.so -O /etc/fluent-bit/logaas.so\n```\n2. Откройте файл с настройками плагинов /etc/fluent-bit/plugins.conf с помощью редактора nano:\n```\nsudo nano /etc/fluent-bit/plugins.conf\n```\n\nВ файл добавьте путь до плагина logaas.so:\n```\n[PLUGINS]      Path /etc/fluent-bit/logaas.so\n```\n3. Откройте файл /etc/fluent-bit/fluent-bit.conf:\n```\nsudo nano /etc/fluent-bit/fluent-bit.conf\n```\n\nДобавьте в него данные в виде:\n```\n[SERVICE]    Daemon Off    Flush 1    Log_Level info    Plugins_File plugins.conf    Parsers_File parsers.conf\n[INPUT]    Name tail    Path <path-to-log/logfile.log>    Parser docker\n[OUTPUT]    Name                    logaas    Match                   *    address                 https://console.cloud.ru/    iam_address             https://auth.iam.sbercloud.ru/    iam_client_id           REPLACE_TO_LOGGING_SA_KEY_ID    iam_client_secret       REPLACE_TO_LOGGING_SA_SECRET    default_project_id      REPLACE_TO_PROJECT_ID    default_group_id        REPLACE_TO_LOG_GROUP_ID    default_labels          {\"some_label\":\"default_value\"}\n```\n\nСекция [INPUT] указывает на источник логов, а [OUTPUT] — на сервис, в который отправятся логи.\nВ режиме tail сбор логов в fluent-bit работает по принципу отслеживания новых записей в логах.\nПри перезапуске сервиса данные, обработанные ранее, не отправляются в систему повторно.\nИзмените файл, подставив в него свои данные:\n\n- <path-to-log/logfile.log> — путь к файлу-источнику логов: fluent-bit будет сканировать этот файл и отслеживать в нем новые строки.\n- REPLACE_TO_LOGGING_SA_KEY_ID и REPLACE_TO_LOGGING_SA_SECRET — Key ID (логин) и Key Secret (пароль) сервисного аккаунта с ролью «logaas.writer» для получения токена и отправки логов.\nПроверьте, что у вас есть доступ к проекту, а для вашего сервисного аккаунта выбраны проект «Пользователь сервисов» и роль «logaas.writer».\n- REPLACE_TO_PROJECT_ID и REPLACE_TO_LOG_GROUP_ID — ID проекта и ID лог-группы, в которую будут отправлены логи.\n- default_labels — необязательный раздел. В нем вы можете указать метки, которые будут добавлены ко всем логам.\n\nВ следующем шаге инструкции настраивается тестовая отправка данных с помощью генератора логов, который записывает логи в лог-файл.\nДля тестирования с помощью генератора вместо <path-to-log/logfile.log> укажите путь к лог-файлу: /usr/local/bin/log_producer/error_log.log.\nПример изменений в файле /etc/fluent-bit/fluent-bit.conf:\n```\n[SERVICE]    Daemon Off    Flush 1    Log_Level info    Plugins_File plugins.conf    Parsers_File parsers.conf\n[INPUT]    Name tail    Path /usr/local/bin/log_producer/error_log.log    Parser docker\n[OUTPUT]    Name                    logaas    Match                   *    address                 https://console.cloud.ru/    iam_address             https://auth.iam.sbercloud.ru/    iam_client_id           30dce000000000000000000000f6b8e0    iam_client_secret       18a4f000000000000000000000098414    default_project_id      00000000-1111-2222-3333-444444444444    default_group_id        aaaaaaaa-bbbb-cccc-dddd-eeeeeeeeeeee    default_labels          {\"source\":\"vm\", \"logger\":\"fluentbit\"}\n```\n\n## Шаг 3. Проверка отправки логов\nНа этом этапе вы сможете настроить тестовую отправку логов с помощью bash-скрипта — генератора логов.\nОн будет записывать логи в лог-файл.\nЧтобы создать генератор:\n1. Создайте директорию, в которой будет находиться скрипт:\n```\nsudo mkdir /usr/local/bin/log_producer/\n```\n2. Создайте пустой файл log_producer.sh:\n```\nsudo touch /usr/local/bin/log_producer/log_producer.sh\n```\n3. Откройте созданный файл с помощью редактора nano:\n```\nsudo nano /usr/local/bin/log_producer/log_producer.sh\n```\n\nВ файл добавьте:\n```\n#!/bin/bash\nLOG_FILE=${1:-./error_log.log}\ngenerate_log() {    # Generate timestamp with timezone    timestamp=$(date \"+%Y-%m-%dT%H:%M:%S.%3N%:z\")\n    # Random log level selection    levels=(\"TRACE\" \"DEBUG\" \"INFO\" \"NOTICE\" \"WARN\" \"ERROR\" \"CRITICAL\" \"ALERT\" \"EMERGENCY\" \"FATAL\")    level=${levels[$RANDOM % ${#levels[@]}]}\n    # Create labels JSON object    labels_json=\"\\\"labels\\\":{\"    labels_json+=\"\\\"app\\\":\\\"logger\\\",\"    labels_json+=\"\\\"host\\\":\\\"$(hostname)\\\",\"    labels_json+=\"\\\"pid\\\":$$,\"    labels_json+=\"\\\"random\\\":$((RANDOM % 1000))\"    labels_json+=\"}\"\n    # Generate random message    messages=(        \"Processing request\"        \"Task completed\"        \"Operation failed\"        \"Initializing system\"        \"Checking permissions\"        \"Resource allocated\"        \"Connection timeout\"        \"Data received\"        \"Invalid input\"        \"Queue processed\"    )    message=\"${messages[$RANDOM % ${#messages[@]}]} [ID: $((RANDOM % 10000))]\"\n    # Construct single-line JSON    printf '{\"timestamp\":\"%s\",\"level\":\"%s\",%s,\"message\":\"%s\"}\\n' \\        \"$timestamp\" \\        \"$level\" \\        \"$labels_json\" \\        \"$message\"}\n# Handle Ctrl+Ctrap 'echo -e \"\\nLogging stopped. Output: $LOG_FILE\"; exit' SIGINT\necho \"Logging to $LOG_FILE - Press CTRL+C to stop\"while true; do    generate_log >> \"$LOG_FILE\"    sleep 1done\n```\n\nПоследние строки кода запускают генератор логов в бесконечном цикле — чтобы остановить генератор, нажмите CTRL + C.\nВы можете изменить это поведение генератора — например, чтобы задать генерацию логов в течение 1 минуты, замените строки:\n```\nwhile true; do    generate_log >> \"$LOG_FILE\"    sleep 1done\n```\n\nна строки:\n```\ncount=0while [ $count -lt 60 ]; do    generate_log >> \"$LOG_FILE\"    ((count++))    sleep 1done\n```\n4. Назначьте файл log_producer.sh исполняемым:\n```\nsudo chmod +x /usr/local/bin/log_producer/log_producer.sh\n```\n5. Запустите генератор логов:\n```\nsudo /usr/local/bin/log_producer/log_producer.sh\n```\n\nГенератор можно запустить в фоновом режиме, добавив к команде знак & — так вы сможете продолжать работать в этой же консоли, не открывая новую для последующих процессов.\n```\nsudo /usr/local/bin/log_producer/log_producer.sh &\n```\nПосле запуска генератор начнет создавать лог-файл /usr/local/bin/log_producer/error_log.log.\nЧтобы остановить работу log_producer.sh, нажмите CTRL + C.\n\n## Шаг 4. Запуск Fluent Bit для сбора логов\nПеред первым запуском fluent-bit в режиме сервиса нужно проверить, нет ли ошибок доступа и корректно ли заполнены файлы настроек.\nДля этого проверьте работу fluent-bit в следующем порядке:\n1. Запустите fluent-bit в консольном режиме.\n2. Запустите fluent-bit в режиме сервиса.\nВ дальнейшем вы сможете использовать любой из этих способов.\n\n### Запуск в консольном режиме\nЗапустите fluent-bit в консоли:\n```\nsudo /opt/fluent-bit/bin/fluent-bit -c /etc/fluent-bit/fluent-bit.conf\n```\n\nСообщения такого типа показывают, что данные отправляются успешно:\n```\n2025/03/11 15:56:22 send2025/03/11 15:56:22 0xc00017a0102025/03/11 15:56:22 logaas send data: {\"logs\":[{\"timestamp\":\"2025-03-12T15:56:21.975165893Z\",\"level\":\"EMERGENCY\",\"project_id\":\"21df218c-931b-4707-8e02-f0498a57e2c9\",\"log_group_id\":\"80746b7e-efb3-11ef-990d-525356cf44f3\",\"labels\":{\"app\":\"logger\",\"host\":\"myvm\",\"logger\":\"client_plugin\",\"pid\":\"61467\",\"random\":\"646\",\"source\":\"docker_compose\",\"transport\":\"log_file\"},\"message\":\"Invalid input [ID: 5930]\"}]}2025/03/11 15:56:22 received response body: { \"errors\": {}}\n```\n\nЧтобы завершить работу fluent-bit, нажмите CTRL + C.\n\n### Запуск в режиме сервиса\nЗапустите fluent-bit для сбора логов как сервис:\n```\nsudo systemctl start fluent-bit\n```\n\nЕсли сервис был запущен ранее, его можно перезапустить, чтобы применились изменения конфигурации:\n```\nsudo systemctl restart fluent-bit\n```\n\n## Шаг 5. Просмотр логов\nЧерез несколько секунд после отправки логи появятся в сервисе Клиентского логирования.\nВы можете посмотреть логи в лог-группах.\nЛоги можно отфильтровать с помощью языка фильтрующих выражений и выгрузить как файл.\nВ режиме tail сбор логов в fluent-bit работает по принципу отслеживания новых записей в логах.\nПри перезапуске сервиса данные, обработанные ранее, не отправляются в систему повторно.\nЧтобы данные непрерывно поступали в сервис, выберите подходящий сценарий:\n\n- запустите генератор логов в бесконечном цикле, чтобы поддерживать постоянное поступление данных;\n- выполняйте генерацию логов пакетами — запускайте скрипт многократно с необходимым интервалом.\n\nЭто позволяет исключить дублирование записей и поддерживать актуальность передаваемых данных.\n\n## После окончания работы\nЕсли виртуальная машина и ее логи стали неактуальными, вы можете удалить их:\n- Удалить лог-группу\n- Удалить проект\n- Удалить виртуальную машину\n\n  [© 2025 Cloud.ru](https://cloud.ru)",
      "debug": {
        "start_page": 1,
        "end_page": 1
      }
    }
  ]
}