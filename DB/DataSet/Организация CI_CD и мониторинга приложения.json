{
  "title": "Организация CI_CD и мониторинга приложения",
  "chapters": [
    {
      "name": "Организация CI_CD и мониторинга приложения",
      "content": "Практические руководства Evolution    \n\n # Организация CI/CD и мониторинга приложения   Эта статья полезна?          \nС помощью этого руководства вы научитесь настраивать полный цикл непрерывной интеграции и доставки (CI/CD) для веб-приложения на Python Flask, а также\nразвертывать систему мониторинга на основе Prometheus и Grafana для обеспечения наблюдаемости работы приложения.\nДля этого вы выполните следующие задачи:\n- Создадите автоматизированный пайплайн CI/CD в GitVerse.\n- Настроите безопасную сборку Docker-образов с автоматическим тестированием и проверкой уязвимостей.\n- Развернете Flask-приложение с промышленным WSGI-сервером Gunicorn.\n- Настроите мониторинг с помощью стека Prometheus + Grafana.\n- Реализуете сбор метрик с помощью Node Exporter и cAdvisor.\n- Создадите дашборды для визуализации метрик производительности и доступности.\nВы будете использовать следующие сервисы:\n- Виртуальные машины — сервис, в рамках которого предоставляется виртуальная машина для размещения приложения.\n- Публичный IP-адрес для доступа к виртуальным машинам через интернет.\n- Docker — система контейнеризации.\n- Docker Compose — инструмент для запуска и управления Docker-контейнерами.\n- GitVerse — платформа для совместной работы с исходным кодом.\n- Prometheus — система мониторинга, сбора и хранения метрик.\n- Grafana — платформа для визуализации, мониторинга и анализа данных.\nШаги:\n1. Разверните ресурсы в облаке.\n2. Настройте окружение виртуальных машин и установите Docker.\n3. Настройте агенты сбора метрик.\n4. Настройте Prometheus и Grafana.\n5. Настройте пайплайн CI/CD в GitVerse.\n6. Разверните Flask-приложение на ВМ.\n7. Настройте дашборды мониторинга.\n\n## Перед началом работы\nЗарегистрируйтесь в личном кабинете Cloud.ru.\nЕсли вы уже зарегистрированы, войдите под своей учетной записью.\n\n## 1. Разверните ресурсы в облаке\nНа этом шаге вы подготовите инфраструктуру проекта: создадите две виртуальные машины с публичными IP-адресами и настроите для них правила фильтрации трафика.\n- app-vm — целевая виртуальная машина для приложения, на которой будет располагаться контейнер с Flask-API и экспортеры метрик.\n- monitoring-vm — инфраструктурная виртуальная машина, на которой будут располагаться GitVerse Runner, Prometheus, Grafana.\nВнимание Все создаваемые ресурсы должны располагаться в одной зоне доступности.\n1. Сгенерируйте ключевую пару и загрузите публичный ключ в Cloud.ru Evolution.\n2. Создайте группу безопасности с названием app-vm-sg и добавьте в нее правила со следующими параметрами:\n Трафик Протокол Порт Тип источника/адресата Источник/Адресат ВходящийTCP5000IP-адрес0.0.0.0/0ВходящийTCP9100IP-адрес0.0.0.0/0ВходящийTCP8080IP-адрес0.0.0.0/0Исходящий Любой—IP-адрес0.0.0.0/0\n3. Создайте группу безопасности с названием monitoring-vm-sg и добавьте в нее правила со следующими параметрами:\n Трафик Протокол Порт Тип источника/адресата Источник/Адресат ВходящийTCP9090IP-адрес0.0.0.0/0ВходящийTCP3000IP-адрес0.0.0.0/0Исходящий Любой—IP-адрес0.0.0.0/0\n4. Создайте виртуальную машину со следующими параметрами:\n- Название — app-vm.\n- Зона доступности — та же, что у группы безопасности.\n- Образ — на вкладке Публичные выберите образ Ubuntu 22.04.\n- Гарантированная доля vCPU — 10%.\n- Сетевой интерфейс — выберите тип Публичный IP.\n- Публичный IP — оставьте Арендовать новый или выберите IP-адрес из списка арендованных.\n- Группы безопасности — app-vm-sg и группа безопасности по умолчанию.\n- Логин — оставьте значение по умолчанию или укажите новый.\n- Метод аутентификации — Публичный ключ и Пароль.\n- Пароль — задайте пароль пользователя.\n- Остальные параметры оставьте по умолчанию или выберите на свое усмотрение.\n5. Создайте виртуальную машину со следующими параметрами:\n- Название — monitoring-vm.\n- Зона доступности — та же, что у группы безопасности.\n- Образ — на вкладке Публичные выберите образ Ubuntu 22.04.\n- Гарантированная доля vCPU — 10%.\n- vCPU, шт — 4.\n- RAM, ГБ — 8.\n- Диски — SSD-диск 40 ГБ.\n- Сетевой интерфейс — выберите тип Публичный IP.\n- Публичный IP — оставьте Арендовать новый или выберите IP-адрес из списка арендованных.\n- Группы безопасности — monitoring-vm-sg и группа безопасности по умолчанию.\n- Логин — оставьте значение по умолчанию или укажите новый.\n- Метод аутентификации — Публичный ключ и Пароль.\n- Пароль — задайте пароль пользователя.\n- Остальные параметры оставьте по умолчанию или выберите на свое усмотрение.\n6. Убедитесь, что ресурсы созданы и отображаются в личном кабинете:\n1. На странице Сети → Группы безопасности отображаются группы безопасности app-vm-sg и monitoring-vm-sg со статусом «Создана».\n2. На странице Инфраструктура → Виртуальные машины отображаются виртуальные машины app-vm и monitoring-vm со статусом «Запущена».\n7. Запишите публичные IP-адреса каждой виртуальной машины.\nВ этом руководстве используются следующие IP-адреса:\n- app-vm — 176.109.105.170;\n- monitoring-vm — 176.123.164.242.\n\n## 2. Настройте окружение виртуальных машин и установите Docker\nНа этом шаге вы настроите окружение виртуальных машин и установите Docker.\nВ терминале для каждой из созданных машин выполните действия:\n1. Подключитесь к виртуальной машине по SSH с использованием публичного IP-адреса.\n2. Обновите систему и установите утилиты:\n```\nsudo apt update && sudo apt upgrade -y\n```\n3. Добавьте настройки DNS для разрешения доменных имен:\n1. Откройте файл /etc/resolv.conf для редактирования:\n```\nsudo nano /etc/resolv.conf\n```\n2. Добавьте следующие настройки и сохраните файл:\n```\nnameserver 8.8.8.8nameserver 8.8.4.4\n```\n3. Перезагрузите виртуальную машину и подключитесь к ней по SSH.\n4. Подготовьте систему к безопасной установке Docker, добавив официальный репозиторий и настроив механизмы проверки подлинности пакетов:\n```\nsudo apt-get install ca-certificates curl -ysudo install -m 0755 -d /etc/apt/keyringssudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.ascsudo chmod a+r /etc/apt/keyrings/docker.asc\n```\n5. Добавьте ключ репозитория:\n```\necho \\\"deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \\$(. /etc/os-release && echo \"${UBUNTU_CODENAME:-$VERSION_CODENAME}\") stable\" | \\sudo tee /etc/apt/sources.list.d/docker.list > /dev/nullsudo apt-get update\n```\n6. Установите Docker, Docker Compose и сопутствующее ПО:\n\n```\nsudo apt-get install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin -y\n```\n7. Добавьте текущего пользователя виртуальной машины в группу Docker:\n1. Выполните команду:\n```\nsudo usermod -aG docker $USERnewgrp docker\n```\n2. Перезагрузите систему.\n3. Проверьте работоспособность Docker:\n```\ndocker run hello-world\n```\n\nПоявится сообщение, подтверждающее успешность установки и настройки.\nПримечаниеВ некоторых случаях права на использование Docker без префикса sudo не сохраняются и командная строка возвращает ошибку permission denied.\nВ этом случае вы можете продолжить работу с Docker, добавляя в начало каждой команды префикс sudo.\n\n## 3. Настройте агенты сбора метрик\nНа этом шаге вы настроите агенты для сбора метрик приложения.\n1. Откройте сессию терминала с подключением к виртуальной машине app-vm.\n2. Создайте директорию для файлов мониторинга и установите права пользователя:\n```\nsudo mkdir -p /opt/monitoringsudo chown $USER:$USER /opt/monitoringcd /opt/monitoring\n```\n3. Скопируйте файлы конфигурации из Git-репозитория:\n```\ngit clone https://gitverse.ru/cloud.ru/lab2_cicd_monitoring.git .\n```\n4. Запустите контейнеры с агентами мониторинга в фоновом режиме:\n```\ndocker compose -f config/docker-compose.monitoring-agents.yml up -d\n```\n5. Убедитесь, что все сервисы запущены корректно:\n```\ndocker compose -f config/docker-compose.monitoring-agents.yml ps\n```\n\nВ ответе вернется список запущенных контейнеров:\n```\nNAME                       IMAGE                              COMMAND                  SERVICE         CREATED          STATUS                             PORTSmonitoring-cadvisor        gcr.io/cadvisor/cadvisor:v0.47.2   \"/usr/bin/cadvisor -…\"   cadvisor        15 seconds ago   Up 15 seconds (health: starting)   0.0.0.0:8080->8080/tcp, [::]:8080->8080/tcpmonitoring-node-exporter   prom/node-exporter:v1.6.1          \"/bin/node_exporter …\"   node-exporter   15 seconds ago   Up 15 seconds                      0.0.0.0:9100->9100/tcp, [::]:9100->9100/tcp\n```\n\nГде:\n- node_exporter — отвечает за сбор метрик операционной системы;\n- cadvisor — отвечает за сбор метрик контейнеров.\n\n## 4. Настройте Prometheus и Grafana\nНа этом шаге вы настроите Prometheus и Grafana на виртуальной машине мониторинга.\n1. Откройте сессию терминала с подключением к виртуальной машине monitoring-vm.\n2. Создайте директорию для файлов мониторинга и установите права пользователя:\n```\nsudo mkdir -p /opt/monitoringsudo chown $USER:$USER /opt/monitoringcd /opt/monitoring\n```\n3. Скопируйте файлы конфигурации из Git-репозитория:\n```\ngit clone https://gitverse.ru/cloud.ru/lab2_cicd_monitoring.git .\n```\n4. Откройте конфигурационный файл мониторинга:\n```\nnano monitoring/prometheus.yml\n```\n5. Замените в нем IP-адрес на публичный IP-адрес app-vm.\nВ этом практическом — 176.109.105.170.\n6. Запустите контейнеры с агентами мониторинга в фоновом режиме:\n```\ndocker compose -f config/docker-compose.monitoring.yml up -d\n```\n7. Убедитесь, что все сервисы запущены корректно:\n```\ndocker compose -f config/docker-compose.monitoring.yml ps\n```\n\nВ ответе вернется список запущенных контейнеров:\n```\nNAME                    IMAGE                    COMMAND                  SERVICE      CREATED          STATUS         PORTSmonitoring-grafana      grafana/grafana:latest   \"/run.sh\"                grafana      16 minutes ago   Up 9 seconds   0.0.0.0:3000->3000/tcp, [::]:3000->3000/tcpmonitoring-prometheus   prom/prometheus:latest   \"/bin/prometheus --c…\"   prometheus   17 minutes ago   Up 9 seconds   0.0.0.0:9090->9090/tcp, [::]:9090->9090/tcp\n```\n8. Проверьте доступность сервисов:\n1. Отправьте API-запрос к сервису Prometheus:\n```\ncurl http://localhost:9090/-/healthy\n```\n2. Отправьте API-запрос к сервису Grafana:\n```\ncurl http://localhost:3000/api/health\n```\n9. Проверьте, что Prometheus получает метрики с сервера приложения:\n1. В браузере откройте страницу http://<monitoring_public_ip>:9090/targets, где <monitoring_public_ip> — публичный IP-адрес виртуальной машины monitoring-vm.\nВ этом практическом — 176.123.164.242.\n2. Проверьте, что Node Exporter и cAdvisor имеют статус «UP» и передают метрики.\n10. Проверьте, что Grafana работает:\n1. В браузере откройте страницу http://<monitoring_public_ip>:3000, где <monitoring_public_ip> — публичный IP-адрес виртуальной машины monitoring-vm.\nВ этом практическом — 176.123.164.242.\n2. Авторизуйтесь в приложении.\nВ учебных целях используйте логин и пароль, который задан в файле Docker Compose:\n```\n- GF_SECURITY_ADMIN_USER=admin- GF_SECURITY_ADMIN_PASSWORD=admin123\n```\n\n## 5. Настройте пайплайн CI/CD в GitVerse\nНа этом шаге вы настроите CI/CD для развертывания Flask-приложения из репозитория GitVerse на виртуальной машине.\n1. Авторизуйтесь в GitVerse.\n2. Создайте форк учебного репозитория GitVerse.\n3. Подключите CI/CD:\n1. Перейдите в раздел Настройки.\n2. Активируйте опцию CI/CD и нажмите Обновить.\n4. Добавьте переменные окружения в проект:\n1. Перейдите в раздел Секреты и переменные.\n2. Добавьте следующие секреты в проект:\n- CI_REGISTRY — registry.gitverse.ru.\n- CI_REGISTRY_IMAGE — registry.gitverse.ru/<gitverse_login>/lab2-cicd-monitoring, где <gitverse_login> — ваш логин в GitVerse.\n- CI_REGISTRY_USER — ваш логин в GitVerse.\n- CI_REGISTRY_PASSWORD — ваш пароль в GitVerse.\n- DEPLOY_HOST — публичный IP-адрес виртуальной машины app-vm.\nВ этом практическом — 176.109.105.170.\n- DEPLOY_USER — логин пользователя виртуальной машины app-vm.\nВ этом практическом — user1.\n- DEPLOY_SSH_PRIVATE_KEY — приватная часть SSH-ключа для подключения к app-vm.\nВниманиеВ учебных целях DEPLOY_USER и DEPLOY_SSH_PRIVATE_KEY используют учетные данные подключения к виртуальной машине, которые вы добавили при ее создании.\nВ реальных задачах используйте для этого отдельный логин и публичный ключ.\n5. Добавьте раннер в CI.\n1. Откройте сессию терминала с подключением к виртуальной машине monitoring-vm.\n2. Установите менеджер пакетов и библиотеки Python:\n```\nsudo apt install -y python3-pip python3-venv python3-dev build-essential\n```\n3. Установите Node.js:\n```\ncurl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -sudo apt-get install -y nodejs\n```\n4. Создайте рабочую директорию для раннера и перейдите в нее:\n```\nmkdir -p ~/gitverse-runnercd ~/gitverse-runner\n```\n5. Установите актуальную версию раннера и добавьте права на выполнение:\n```\nwget https://gitverse.ru/api/packages/gitverse/generic/act_runner_linux_amd64/4.1.0/act_runner_linux_amd64mv act_runner_linux_amd64 act_runnerchmod +x act_runner\n```\n6. Проверьте, что раннер установлен:\n```\n./act_runner --version\n```\n6. Получите токен регистрации в GitVerse:\n1. В верхней части страницы нажмите Настройки и перейдите на вкладку Раннеры.\n2. Нажмите Добавить раннер.\n3. В открывшемся окне скопируйте сгенерированный токен.\n7. Зарегистрируйте раннер.\nВ терминале monitoring-vm выполните команду:\n```\nsudo ./act_runner register \\    --no-interactive \\    --instance https://gitverse.ru/sc \\    --token <registration_token> \\    --name \"lab2-runner\" \\    --labels \"docker,monitoring,self-hosted\"\n```\n\nГде <registration_token> — токен, полученный в GitVerse.\n8. Вернитесь на страницу настройки раннеров в GitVerse.\nПроверьте, что локальный раннер появился в настройках и его статус — «Недоступен».\nВы зарегистрировали раннер, но еще не запускали.\n9. Настройте автозапуск раннера:\n1. Откройте сессию терминала с подключением к виртуальной машине monitoring-vm.\n2. Выполните команду, которая создаст файл службы systemd:\n```\nsudo tee /etc/systemd/system/gitverse-runner.service << EOF[Unit]Description=GitVerse RunnerAfter=network.target docker.service\n[Service]Type=simpleUser=rootWorkingDirectory=/home/<vm_login>/gitverse-runnerExecStart=/home/<vm_login>/gitverse-runner/act_runner daemonRestart=alwaysRestartSec=10\n[Install]WantedBy=multi-user.targetEOF\n```\n\nГде <vm_login> — имя пользователя виртуальной машины (логин).\nВ этом практическом — user1.\n3. Включите автозапуск:\n```\nsudo systemctl enable gitverse-runnersudo systemctl start gitverse-runner\n```\n4. Проверьте статус раннера в терминале виртуальной машины:\n```\nsudo systemctl status gitverse-runner\n```\n\nПример ожидаемого ответа:\n```\n● gitverse-runner.service - GitVerse Runner     Loaded: loaded (/etc/systemd/system/gitverse-runner.service; enabled; vendor preset: enabled)     Active: active (running) since Tue 2025-11-11 14:42:45 MSK; 16s ago   Main PID: 18335 (act_runner)      Tasks: 9 (limit: 9388)     Memory: 7.3M        CPU: 49ms     CGroup: /system.slice/gitverse-runner.service             └─18335 /home/user1/gitverse-runner/act_runner daemon\n```\n5. Проверьте статус раннера в GitVerse.\nВернитесь на страницу настройки раннеров в GitVerse и проверьте, что статус локального раннера в настройках изменился на «Простаивает».\n\n## 6. Разверните Flask-приложение на ВМ\nВ учебном репозитории GitVerse содержится исходный код Flask-приложения.\nНа этом шаге вы настроите автоматическое развертывание Flask-приложения из репозитория на виртуальную машину.\n1. Откройте GitVerse и перейдите на вкладку CI/CD вашего репозитория.\n2. На вкладке может отображаться пайплайн, который автоматически запускается после создания репозитория.\nЕсли этого не произошло:\n1. В меню слева нажмите CI/CD Pipeline для Lab2 (Self-hosted GitVerse).\n2. Нажмите Запустить.\n3. В открывшемся окне оставьте ветку по умолчанию и подтвердите запуск пайплайна.\nПайплайн отобразится на странице.\nПримечание Конфигурация пайплайна содержится в файле lab2_cicd_monitoring/.gitverse/workflows/ci-cd-pipeline.yaml.\n3. Чтобы посмотреть процесс выполнения заданий, нажмите на название пайплайна.\n4. Дождитесь выполнения всех заданий.\n5. Проверьте работу приложения на виртуальной машине:\n1. Откройте сессию терминала с подключением к виртуальной машине app-vm.\n2. Выполните команду для проверки работы контейнера:\n```\ndocker ps\n```\n\nПример ожидаемого ответа:\n```\nCONTAINER ID   IMAGE                                                                                    COMMAND                  CREATED          STATUS                 PORTS                                         NAMESe52a3a8b0a44   gitverse.ru/dsdimbrilova/lab2_cicd_monitoring:86162a407c6e92a22b5ec52ddcf4a9d851e2ff26   \"gunicorn --bind 0.0…\"   22 minutes ago   Up 22 minutes          0.0.0.0:5000->5000/tcp, [::]:5000->5000/tcp   lab2-app4acb8e7bb178   prom/node-exporter:v1.6.1                                                                \"/bin/node_exporter …\"   7 hours ago      Up 7 hours             0.0.0.0:9100->9100/tcp, [::]:9100->9100/tcp   monitoring-node-exporter3520e6b03e4a   gcr.io/cadvisor/cadvisor:v0.47.2                                                         \"/usr/bin/cadvisor -…\"   7 hours ago      Up 7 hours (healthy)   0.0.0.0:8080->8080/tcp, [::]:8080->8080/tcp   monitoring-cadvisor\n```\n3. Выполните команду для просмотра логов контейнера:\n```\ndocker logs lab2-app\n```\n\nПример ожидаемого ответа:\n```\n[2025-11-11 12:48:28 +0000] [1] [INFO] Starting gunicorn 21.2.0[2025-11-11 12:48:28 +0000] [1] [INFO] Listening at: http://0.0.0.0:5000 (1)[2025-11-11 12:48:28 +0000] [1] [INFO] Using worker: sync[2025-11-11 12:48:28 +0000] [6] [INFO] Booting worker with pid: 6[2025-11-11 12:48:28 +0000] [7] [INFO] Booting worker with pid: 7[2025-11-11 12:48:28 +0000] [8] [INFO] Booting worker with pid: 8[2025-11-11 12:48:28 +0000] [9] [INFO] Booting worker with pid: 9\n```\n4. Обратитесь к API приложения:\n```\ncurl http://<ip-address>:5000/healthcurl http://<ip-address>:5000/api/time\n```\n\nГде <ip-address> — публичный IP-адрес виртуальной машины app-vm.\nВ этом практическом — 176.109.105.170.\n\n## 7. Настройте дашборды мониторинга\nНа этом шаге вы настроите дашборды мониторинга Grafana для визуализации метрик производительности и доступности приложения.\nВ этом практическом используются стандартные экспортеры метрик, поэтому вы будете использовать готовые дашборды Grafana.\n1. Скачайте готовые дашборды Node Exporter и cAdvisor с сайта Grafana.\n2. В браузере откройте страницу http://<monitoring_public_ip>:3000, где <monitoring_public_ip> — публичный IP-адрес виртуальной машины monitoring-vm.\nВ этом практическом — 176.123.164.242.\n3. Авторизуйтесь в Grafana:\n- логин — admin;\n- пароль — admin123.\n4. Добавьте дашборды в сервис.\nДля каждого скачанного JSON-файла выполните действия:\n1. Перейдите на вкладку Dashboards и нажмите New → Import.\n2. Откройте скачанный JSON-файл и нажмите Import.\nNode Exporter потребует указать источник данных.\nВыберите Prometheus.\nНа вкладке Dashboards появится список добавленных дашбордов.\n5. Выберите любой из дашбордов.\nВ сервисе отобразятся виджеты с метриками работы приложения на виртуальной машине app-vm.\nВы можете выбрать нужный временной интервал или виджет.\n\n## Результат\nВы научились:\n- Настраивать безопасную сборку Docker-образов с автоматическим тестированием и проверкой уязвимостей.\n- Автоматически разворачивать Flask-приложение из репозитория.\n- Настраивать мониторинг с помощью Prometheus и Grafana.\n- Создавать дашборды для визуализации метрик производительности и доступности.\n\n  [© 2025 Cloud.ru](https://cloud.ru)",
      "debug": {
        "start_page": 1,
        "end_page": 1
      }
    }
  ]
}