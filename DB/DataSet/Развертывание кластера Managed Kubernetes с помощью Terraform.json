{
  "title": "Развертывание кластера Managed Kubernetes с помощью Terraform",
  "chapters": [
    {
      "name": "Развертывание кластера Managed Kubernetes с помощью Terraform",
      "content": "Практические руководства Evolution    \n\n # Развертывание кластера Managed Kubernetes с помощью Terraform   Эта статья полезна?          \nС помощью этого руководства вы научитесь автоматически развертывать инфраструктуру в облаке Cloud.ru Evolution при помощи инструмента Terraform на примере создания кластера Managed Kubernetes.\nВы будете использовать следующие сервисы:\n- Виртуальные машины — сервис, в рамках которого предоставляется виртуальная машина.\n- Managed Kubernetes — сервис управления кластерами Kubernetes на вычислительных ресурсах облака.\n- Terraform — инструмент для управления IaC.\nШаги:\n1. Установите и настройте Terraform.\n2. Настройте конфигурационный файл main.tf.\n3. Создайте кластер Managed Kubernetes с помощью Terraform.\n4. Проверьте создание кластера и подключитесь к нему.\n\n## Перед началом работы\n1. Зарегистрируйтесь в личном кабинете Cloud.ru.\nЕсли вы уже зарегистрированы, войдите под своей учетной записью.\n2. Создайте ключ доступа и сохраните Key ID (логин) и Key Secret (пароль).\nЭто данные для аутентификации и подключения к сервисам Cloud.ru вашего проекта.\n3. Создайте сервисный аккаунт для интеграции с другими сервисами облака Evolution вашего проекта.\n4. Установите инструмент для работы с кодом, например Visual Studio Code, или используйте стандартный терминал, например bash, cmd или PowerShell.\n\n## 1. Установите и настройте Terraform\n1. Установите Terraform.\n2. Установите Terraform-провайдер.\nШаг с командой terraform init пока пропустите.\n3. Проверьте, что установка прошла корректно:\n```\nterraform --version\n```\n\nДолжна отобразиться версия Terraform.\n\n## 2. Настройте конфигурационный файл main.tf\n1. Создайте локальную папку для проекта.\n2. В папке проекта создайте файл main.tf и добавьте в него код:\n```\nterraform {  required_providers {    cloudru = {      source  = \"cloud.ru/cloudru/cloud\"      version = \"1.5.1\"    }  }}\nprovider \"cloudru\" {  project_id = \"<your-project-id>\"  auth_key_id = \"<your-key-id>\"  auth_secret = \"<your-key-secret>\"  iam_endpoint = \"iam.api.cloud.ru:443\"  k8s_endpoint = \"mk8s.api.cloud.ru:443\"}\n```\n\nГде:\n- <your-project-id> — идентификатор проекта.\n- <your-key-id> — логин ключа доступа, который вы создали перед началом работы.\n- <your-key-secret> — пароль ключа доступа, который вы создали перед началом работы.\n3. Сохраните файл main.tf.\nС помощью него вы задали конфигурацию для провайдера Terraform и точки обращения к сервисам Cloud.ru.\n4. В терминале перейдите в папку проекта и выполните команду:\n```\nterraform init\n```\n\nЕсли все прошло успешно, вы увидите похожий текст:\n```\nTerraform has been successfully initialized!\nYou may now begin working with Terraform. Try running \"terraform plan\" to seeany changes that are required for your infrastructure. All Terraform commandsshould now work.\nIf you ever set or change modules or backend configuration for Terraform,rerun this command to reinitialize your working directory. If you forget, othercommands will detect it and remind you to do so if necessary.\n```\n\n## 3. Создайте кластер Managed Kubernetes с помощью Terraform\nНа этом шаге вы создадите файл конфигурации и примените его.\n1. В каталоге проекта создайте файл конфигурации kuber.tf и добавьте в него код:\n```\ndata \"cloudru_k8s_zone_flavors\" \"k8s_zones\" {}\n# Creating a K8s cluster / master nodes\nresource \"cloudru_k8s_cluster\" \"kuber\" {  name = \"tf-cluster\"  control_plane = {    count = 1    type = \"MASTER_TYPE_SMALL\"    version = \"v1.32.5\"    zones = [data.cloudru_k8s_zone_flavors.k8s_zones.availability_zones[index(data.cloudru_k8s_zone_flavors.k8s_zones.availability_zones.*.name, \"ru.AZ-1\")].id]  }\n  network_configuration = {    services_subnet_cidr = \"10.0.0.0/20\"    nodes_subnet_cidr = \"192.168.20.0/24\"    pods_subnet_cidr = \"172.16.0.0/12\"    kube_api_internet = true  }}\n# Creating a pool of workers\nresource \"cloudru_k8s_nodepool\" \"kuber_nodepool\" {  cluster_id = cloudru_k8s_cluster.kuber.id  name = \"tf-worker-pool\"  zone = data.cloudru_k8s_zone_flavors.k8s_zones.availability_zones[index(data.cloudru_k8s_zone_flavors.k8s_zones.availability_zones.*.name, \"ru.AZ-1\")].id  scale_policy = {    fixed_scale = {      count = 1    }  }\n  hardware_compute = {    disk_size = 10    disk_type = \"DISK_TYPE_SSD_NVME\"    flavor_id = data.cloudru_k8s_zone_flavors.k8s_zones.flavors[index(data.cloudru_k8s_zone_flavors.k8s_zones.flavors.*.name, \"lowcost10-2-4\")].id  }\n  nodes_network_configuration = {    nodes_subnet_cidr = \"192.168.123.0/24\"  }\n  depends_on = [    cloudru_k8s_cluster.kuber  ]}\n```\n\nС помощью этой конфигурации вы создадите новые ресурсы:\n- Кластер Managed Kubernetes на базе одного мастер-узла.\n- Одну группу узлов.\n2. Сохраните файл kuber.tf.\n3. В терминале перейдите в папку проекта и выполните команду:\n```\nterraform validate\n```\n4. Если все прошло успешно, вы увидите похожий текст:\n```\nSuccess! The configuration is valid.\n```\n\nПри необходимости устраните ошибки в конфигурации.\n5. Выполните команду:\n```\nterraform apply\n```\n6. Убедитесь, что Terraform планирует добавить два ресурса, введите «yes» и нажмите Enter.\nЕсли развертывание прошло успешно, вы увидите следующее сообщение:\n```\nApply complete! Resources: 2 added, 0 changed, 0 destroyed.\n```\n\n## 3. Проверьте создание кластера и подключитесь к нему\n1. Перейдите в личный кабинет Cloud.ru Evolution и проверьте, что все созданные ресурсы отображаются.\n2. Подключитесь к кластеру и выполните команду:\n```\nkubectl cluster-info\n```\n\nКоманда выведет информацию о вашем кластере.\n\n## Результат\nВы познакомились с механизмом развертывания облачных ресурсов Terraform и научились работать с инструментами в рамках концепции Infrastructure as Code.\n\n  [© 2025 Cloud.ru](https://cloud.ru)",
      "debug": {
        "start_page": 1,
        "end_page": 1
      }
    }
  ]
}