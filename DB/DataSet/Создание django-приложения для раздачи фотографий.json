{
  "title": "Создание django-приложения для раздачи фотографий",
  "chapters": [
    {
      "name": "Создание django-приложения для раздачи фотографий",
      "content": "Практические руководства Evolution    \n\n # Создание django-приложения для раздачи фотографий   Эта статья полезна?          \nС помощью этого руководства вы научитесь сохранять данные проекта, размещенного в Container Apps, с помощью Object Storage.\nВы будете использовать репозиторий GitVerse с исходным кодом готового nginx-сервиса для раздачи фотографий и django-приложения для управления фотографиями.\nНа примере этих приложений вы научитесь создавать сервис Container Apps без потери данных, когда трафик падает до нуля.\nВы будете использовать следующие сервисы:\n- Artifact Registry для хранения, совместного использования и управления Docker-образами и Helm-чартами.\n- Container Apps — сервис для запуска контейнерных приложений в облаке. Не требует знания Kubernetes и создания виртуальных машин.\n- Object Storage — объектное S3-хранилище с бесплатным хранением файлов, объемом до 15 ГБ.\nШаги:\n1. Подготовьте среду.\n2. Клонируйте или скачайте репозиторий кода c GitVerse.\n3. Соберите образ с django-приложением и присвойте тег.\n4. Загрузите Docker-образ с django-приложением в реестр.\n5. Соберите образ с nginx-сервисом и присвойте тег.\n6. Загрузите Docker-образ с nginx-сервером в реестр.\n7. Создайте бакеты для базы данных и хранения медиафайлов.\n8. Создайте первую ревизию контейнера с django-приложением.\n9. Проверьте работоспособность django-приложения.\n10. Создайте первую ревизию контейнера с nginx-сервисом.\n11. Проверьте работоспособность nginx-сервиса.\n\n## Перед началом работы\nЗарегистрируйтесь в личном кабинете Cloud.ru.\nЕсли вы уже зарегистрированы, войдите под своей учетной записью.\n\n## 1. Подготовьте среду\nПодготовьте среду, если не сделали этого ранее.\n\n## 2. Клонируйте или скачайте репозиторий c GitVerse\nВы можете зарегистрироваться в GitVerse, если у вас еще нет аккаунта, и познакомиться с новой системой контроля версий. Этот шаг необязательный и не влияет на дальнейшее прохождение сценария.\nВ этом репозитории находится исходный код django-приложения, написанного на Python, а также nginx-сервис для публикации фотографий.\n```\ngit clone https://gitverse.ru/cloudru/evo-container-apps-django-app\n```\n\n## 3. Соберите образ с django-приложением и присвойте тег\nВнимание Убедитесь, что Docker Desktop запущен и пользователь авторизован в приложении.\nИспользуйте реестр, созданный на этапе подготовки среды.\n1. Перейдите в подкаталог с django-приложением.\n```\ncd django_app\n```\n2. Выполните команду для сборки образа:\n\n```\ndocker build . \\   --tag django-app.cr.cloud.ru/manage-photos-django-app \\   --platform linux/amd64 \\   --provenance false\n```\nДля создания контейнера Docker-образ должен быть собран под платформу linux/amd64, поэтому в команде используется флаг platform со значением linux/amd64.\n\n## 4. Загрузите Docker-образ c django-приложением в реестр\nЗагрузите образ в реестр Artifact Registry, выполнив команду:\n```\ndocker push <registry_name>.cr.cloud.ru/manage-photos-django-app\n```\n\nГде:\n- <registry_name> — название реестра, которое вы указывали при его создании в Artifact Registry.\n- manage-photos-django-app — название будущего репозитория в Artifact Registry. Название репозитория соответствует имени Docker-образа.\n\n## 5. Соберите образ с nginx-сервисом и присвойте тег\nВнимание Убедитесь, что Docker Desktop запущен и пользователь авторизован в приложении.\nИспользуйте реестр, созданный на этапе подготовки среды.\n1. В исходном коде приложения в файле nginx.conf убедитесь, что в качестве каталога для хранения файлов указан /files/media/.\n2. Перейдите в подкаталог с nginx-сервисом.\n```\ncd nginx_share_media_files\n```\n3. Выполните команду для сборки образа:\n```\ndocker build . \\   --tag django-app.cr.cloud.ru/nginx-service \\   --platform linux/amd64 \\   --provenance false\n```\nДля создания контейнера Docker-образ должен быть собран под платформу linux/amd64, поэтому в команде используется флаг platform со значением linux/amd64.\n\n## 6. Загрузите Docker-образ c nginx-сервисом в реестр\nЗагрузите образ в реестр Artifact Registry, выполнив команду:\n```\ndocker push <registry_name>.cr.cloud.ru/manage-photos-nginx\n```\n\nГде:\n- <registry_name> — название реестра, которое вы указывали при его создании в Artifact Registry.\n- manage-photos-nginx — название будущего репозитория в Artifact Registry. Название репозитория соответствует имени Docker-образа.\n\n## 7. Создайте бакеты в Object Storage\nВ сервисе Object Storage создайте бакет для базы данных и бакет для хранения медиаданных.\n\nБакет для базы данных SQLite:\nВниманиеSQLite не поддерживает одновременную многопоточную запись, особенно при размещении файла базы в Object Storage. Этот пример предназначен исключительно для демонстрационных целей и быстрого запуска приложения.Для production-среды настоятельно рекомендуется использовать полноценную СУБД, например PostgreSQL — она обеспечит надежность, масштабируемость и поддержку конкурентного доступа.\n- Название — <your_name>, например django-app-media-data.\n- Доменное имя —  не задано.\n- Класс хранения по умолчанию — Стандартный.\n- Максимальный размер — отключите или укажите на свое усмотрение.\n\nЭтот бакет используется для размещения SQLite-базы данных, в которой хранятся учетные данные пользователей и ссылки на их фотографии.\nОн будет примонтирован в приложение по пути /files/database.\nБакет для хранения медиаданных:\n- Название — <your_name>, например django-app-media-db.\n- Доменное имя —  не задано.\n- Класс хранения по умолчанию — Стандартный.\n- Максимальный размер — отключите или укажите на свое усмотрение.\n\nЭтот бакет предназначен для хранения загруженных фотографий.\nОн будет примонтирован в приложение по пути /files/media.\nУбедитесь, что в личном кабинете на странице сервиса Object Storage:\n\n- в списке бакетов отображаются созданные вами бакеты;\n- класс хранения созданных бакетов — Стандартный.\n\n## 8. Создайте и запустите контейнер c django-приложением\n1. Откройте меню загруженного образа django-app и нажмите Создать Container App.\n2. Заполните поля и активируйте опции:\n\n- Название контейнера — глобально уникальное имя, на базе которого формируется адрес вашего приложения в домене *.containers.cloud.ru.\n- Порт контейнера — порт контейнера, который должен совпадать с портом вашего приложения.\nВ этом сценарии используем порт 8000.\n- vCPU/RAM — количество vCPU и RAM, которые выделяются для каждого экземпляра контейнера при обработке вызова.\nВыберите конфигурацию 0.2 vCPU - 512 MB.\n- Минимальное и максимальное количество экземпляров при масштабировании сервиса. По умолчанию происходит масштабирование с 0, что может вызывать небольшую задержку при старте вашего приложения. Установите минимальное количество экземпляров — 0, а максимальное — 1.\n- Публичный адрес — активируйте опцию, чтобы получить URL-адрес для вызова приложения из интернета.\n- Автоматическое развертывание — активируйте опцию, чтобы каждый раз после загрузки в Artifact Registry новой версии образа на стороне Container Apps автоматически создавалась новая ревизия контейнера.\n3. Нажмите Создать.\nКонтейнер будет создан в течение нескольких секунд. Отобразится интерфейс Container Apps с информацией о созданном контейнере.\n4. Нажмите Создать ревизию на основе выбранной.\n5. Добавьте том — бакет в сервисе Object Storage для БД приложения:\n1. В разделе Тома главного контейнера выберите Добавить том.\n2. Укажите тип тома — постоянный.\n3. Введите название тома, например django-app-db.\n4. Выберите созданный на предыдущем этапе бакет для базы данных.\n5. Нажмите Добавить.\n6. В разделе Параметры монтирования в поле Путь укажите путь до папки с базой данных.\n6. Добавьте том — бакет в сервисе Object Storage для хранения медиаданных:\n1. В разделе Тома главного контейнера выберите Добавить том.\n2. Укажите тип тома — постоянный.\n3. Введите название тома, например django-media.\n4. Выберите созданный на предыдущем этапе бакет для медиаданных.\n5. Нажмите Добавить.\n6. В разделе Параметры монтирования в поле Путь укажите путь до папки с медиаданными.\n7. Перейдите на вкладку Переменные контейнера и укажите в качестве значения переменных пути к папкам с БД и с медиафайлами:\n- DB_DIR=/files/database\n- MEDIA_ROOT=/files/media\n- ADMIN_USERNAME=admin\n- ADMIN_PASSWORD=****\n8. Нажмите Создать.\nОткроется страница сервиса Container Apps.\nКонтейнер будет запущен в течение нескольких секунд.\nДождитесь, когда контейнер и ревизия перейдут в статус «Выполняется».\n\n## 9. Проверьте работоспособность развернутого django-приложения\n1. Перейдите по публичному URL-адресу контейнера с django-приложением:\n\nОтобразится окно входа в панель администратора.\n2. Укажите логин и пароль. Отобразится каталог с изображениями.\n3. Попробуйте загрузить изображение.\nДаже если страница закрыта и приложение не используется, загруженные в базу данных изображения сохранятся.\n \n Что делать, если приложение не отвечает \n \n\n## 10. Создайте и запустите контейнер c nginx-сервисом\n1. Перейдите в сервис Container Apps через меню в левом верхнем углу экрана.\n2. Выберите Container Services и нажмите Создать.\n3. Укажите название контейнера и активируйте опцию Привилегированный режим, чтобы обеспечить доступ nginx-сервиса к root-пользователю.\n4. Не меняйте конфигурацию.\nДля nginx-сервиса достаточно минимальной конфигурации, выбранной по умолчанию:    vCPU и RAM: 0.1 vCPU – 256 MB.\n5. Выберите Docker-образ, который вы загрузили в Artifact Registry, перейдя в реестр django-app.cr.cloud.ru и репозиторий nginx-service.\n6. Укажите порт контейнера — 80.\n7. Добавьте том — бакет в сервисе Object Storage для хранения медиаданных:\n1. В разделе Тома главного контейнера выберите Добавить том.\n2. Укажите тип тома — постоянный.\n3. Введите название тома, например django-app-media-data.\n4. Выберите созданный на шаге 7 бакет для медиаданных.\n5. Нажмите Добавить.\n6. В разделе Параметры монтирования в поле Путь укажите путь до папки с медиаданными /files/media.\n8. Нажмите Следующий шаг.\n9. Задайте количество ресурсов:\n- Минимальное количество экземпляров: 0.\n- Максимальное количество экземпляров: 1.\n10. Нажмите Создать.\nОткроется страница сервиса Container Apps.\nКонтейнер будет запущен в течение нескольких секунд.\nДождитесь, когда контейнер и ревизия перейдут в статус «Выполняется».\n\n## 11. Проверьте работоспособность развернутого nginx-сервиса\nПерейдите по публичному URL-адресу контейнера с nginx-сервисом.\nОтобразится каталог изображений, загруженных с помощью сервиса Django.\n \n Что делать, если приложение не отвечает \n \n\n## Результат\nВы научились:\n- добавлять постоянный том Object Storage, который позволяет сохранить ваши данные, когда запросы к приложению не поступают;\n- разворачивать приложения, которые совместно используют один и тот же бакет Object Storage.\nСмотрите обучающее видео по сервису Container Apps и узнайте о том, как сохранять данные в бакете при нулевом трафике.\n\n  [© 2025 Cloud.ru](https://cloud.ru)",
      "debug": {
        "start_page": 1,
        "end_page": 1
      }
    }
  ]
}