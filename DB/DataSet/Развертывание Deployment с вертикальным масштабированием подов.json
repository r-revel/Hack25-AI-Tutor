{
  "title": "Развертывание Deployment с вертикальным масштабированием подов",
  "chapters": [
    {
      "name": "Развертывание Deployment с вертикальным масштабированием подов",
      "content": "Практические руководства Evolution    \n\n # Развертывание Deployment с вертикальным масштабированием подов   Эта статья полезна?          \nВ сценарии развернем Deployment с тремя подами, каждый из которых запускает контейнер с nginx.\nВ Deployment укажем:\n- запросы на лимиты — 500m CPU и 1 ГиБ памяти;\n- запросы на ресурсы — 150m CPU и 100 МиБ памяти.\nДалее создадим объект VerticalPodAutoscaler с режимом Auto.\n\n## Перед началом работы\n1. Создайте кластер Managed Kubernetes и хотя бы одну группу узлов.\n2. Установите плагины Metrics Server и Vertical Pod Autoscaler.\n3. Подключитесь к кластеру Managed Kubernetes.\n\n## Шаг 1. Создайте Deployment\n1. Создайте файл cloudru-nginx.yaml и скопируйте следующую спецификацию:\n```\napiVersion: apps/v1kind: Deploymentmetadata:  name: cloudru-nginxspec:  replicas: 3  selector:    matchLabels:      app: cloudru-nginx  template:    metadata:      labels:        app: cloudru-nginx    spec:      containers:      - name: cloudru-nginx        image: mk8s.registry.smk.sbercloud.dev/nginx:latest        resources:          limits:            cpu: 500m            memory: 1Gi          requests:            cpu: 150m            memory: 100Mi        command: [\"/bin/sh\"]        args: [\"-c\", \"while true; do timeout 0.5s yes >/dev/null; sleep 0.5s; done\"]\n```\n2. Выполните команду:\n```\nkubectl create -f cloudru-nginx.yaml\n```\n\nЕсли команда выполнена успешно, появится сообщение:\n```\ndeployment.apps/cloudru-nginx created\n```\n3. Подождите несколько минут, а затем посмотрите информацию о запущенных подах:\n```\nkubectl get pods -l app=cloudru-nginx\n```\n\nРезультат должен выглядеть примерно так:\n```\nNAME                             READY   STATUS    RESTARTS   AGEcloudru-nginx-435634s132-jwr37   1/1     Running   0          6m21scloudru-nginx-435634s132-frn21   1/1     Running   0          5m09scloudru-nginx-435634s132-qsj79   1/1     Running   0          3m44s\n```\n4. Получите подробную информацию об одном из подов:\n```\nkubectl describe pod <pod_name>\n```\n\nВместо <pod_name> укажите название любого пода из результата предыдущей команды.\nРезультат должен выглядеть примерно так:\n```\n...\n cloudru-nginx:    Container ID:  containerd://...    Image:         mk8s.registry.smk.sbercloud.dev/nginx:latest    Image ID:      sha256:    Port:          <none>    Host Port:     <none>    Command:      /bin/sh    Args:      -c      while true; do timeout 0.5s yes >/dev/null; sleep 0.5s; done    State:          Running      Started:      Wed, 14 Aug 2024 10:19:12 -0400    Ready:          True    Restart Count:  0    Limits:      cpu:     500m      memory:  1Gi    Requests:      cpu:        150m      memory:     100Mi    Environment:  <none>\n...\n```\n\nУстановлены лимиты: CPU — 500m и RAM — 1 ГиБ и запросы на ресурсы: CPU — 150m и RAM — 100 МиБ.\n\n## Шаг 2. Создайте Vertical Pod Autoscaler\n1. Создайте файл cloudru-vpa.yaml и сохраните следующую спецификацию:\n```\napiVersion: autoscaling.k8s.io/v1kind: VerticalPodAutoscalermetadata:  name: cloudru-vpaspec:  targetRef:    apiVersion: \"apps/v1\"    kind: Deployment    name: cloudru-nginx  updatePolicy:    updateMode: \"Auto\"\n```\n\nГде:\n- spec.targetRef.name — название Deployment, для которого будет выполняться вертикальное автомасштабирование.\n- spec.updatePolicy.updateMode — режим обновления запросов на ресурсы.\n2. Выполните команду:\n```\nkubectl create -f cloudru-vpa.yaml\n```\n\nВ результате будет создан объект Vertical Pod Autoscaler для Deployment cloudru-nginx.\n3. Подождите несколько минут, пока cloudru-vpa пересоздаст поды.\nВы можете отслеживать создание новых подов.\nДля этого в терминале, отличном от терминала, на котором вы выполняли предыдущий шаг, выполните команду:\n```\nkubectl get --watch Pods -l app=cloudru-nginx\n```\n4. Выполните команду:\n```\nkubectl describe pod <pod_name>\n```\n\nГде <pod_name> — название нового пода.\nРезультат должен выглядеть примерно так:\n```\n...\nState:          Running   Started:      Wed, 14 Aug 2024 10:21:22 -0400Ready:          TrueRestart Count:  0Limits:   cpu:     1166m   memory:  2560MiRequests:   cpu:     350m   memory:  262144kEnvironment:  <none>...\n```\n\nМы видим, что VPA изменил:\n- лимиты: CPU — 1166m и RAM — 2560 МиБ;\n- запросы на ресурсы: CPU — 350m и RAM — 262144 КиБ.\n\n## Шаг 3. Удалите ресурсы\nЕсли вы закончили работать с VPA, удалите созданные ресурсы.\n1. Удалите cloudru-vpa:\n```\nkubectl delete vpa cloudru-vpa\n```\n\nПри удалении VPA Deployment остается c существующими запросами.\n2. Удалите Deployment:\n```\nkubectl delete deployment cloudru-nginx\n```\n\nРезультат:\n```\ndeployment.apps \"cloudru-nginx\" deleted\n```\n\nПоды удалятся вместе с Deployment.\n3. Если необходимо, удалите кластер.\nСм.также Вертикальное масштабирование подов\n\n  [© 2025 Cloud.ru](https://cloud.ru)",
      "debug": {
        "start_page": 1,
        "end_page": 1
      }
    }
  ]
}