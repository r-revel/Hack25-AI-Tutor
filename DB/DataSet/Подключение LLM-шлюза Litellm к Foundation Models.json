{
  "title": "Подключение LLM-шлюза Litellm к Foundation Models",
  "chapters": [
    {
      "name": "Подключение LLM-шлюза Litellm к Foundation Models",
      "content": "Практические руководства Evolution    \n\n # Подключение LLM-шлюза Litellm к Foundation Models   Эта статья полезна?          \nС помощью этого руководства вы развернете LLM-шлюз Litellm на бесплатной виртуальной машине в облаке Cloud.ru Evolution.\nВы создадите виртуальную машину Ubuntu 22.04, назначите ей публичный IP-адрес, установите Docker и Docker Compose, запустите Litellm и опубликуете сервис через Nginx с SSL-сертификатом, выпущенным в Let’s Encrypt.\nВ результате вы сконфигурируете Litellm для работы с Foundation Models и получите сервис, готовый к работе.\nВы будете использовать следующие сервисы:\n- Foundation Models — сервис для доступа к API популярных фундаментальных моделей машинного обучения с открытым исходным кодом.\n- Виртуальные машины — сервис, в рамках которого предоставляется виртуальная машина.\n- Публичный IP-адрес.\n- Docker — система контейнеризации.\n- Docker Compose — инструмент для запуска и управления Docker-контейнерами.\n- Бесплатный сервис nip.io для получения публичного доменного имени и сертификата.\nВы также можете использовать собственное зарегистрированное доменное имя и SSL-сертификат для организации доступа.\n- Nginx — веб-сервер для проксирования запросов и организации защищeнного HTTPS-доступа к приложению.\n- Let’s Encrypt — сервис для автоматического получения бесплатного SSL-сертификата.\n- Litellm — комплексная платформа, предназначенная для упрощения управления несколькими большими языковыми моделями (LLM) через унифицированное API.\nLiteLLM предлагает унифицированное API, балансировку нагрузки, механизмы резервирования, отслеживание расходов и обработку ошибок.\n\n## Шаги:\n1. Разверните необходимые ресурсы в облаке.\n2. Сгенерируйте API-ключ для доступа к Foundation Models.\n3. Настройте окружение на виртуальной машине.\n4. Настройте Nginx и HTTPS.\n5. Разверните приложение.\n6. Добавьте модели из Foundation Models в Litellm.\n7. Обратитесь к добавленным моделям.\n8. Отключите доступ по SSH для виртуальной машины.\n\n## Перед началом работы\n1. Зарегистрируйтесь в личном кабинете Cloud.ru.\nЕсли вы уже зарегистрированы, войдите под своей учетной записью.\n2. Сгенерируйте SSH-ключ.\n3. Загрузите публичную часть SSH-ключа в облако Cloud.ru Evolution.\n\n## 1. Разверните необходимые ресурсы в облаке\nНа этом шаге вы создадите группу безопасности и виртуальную машину.\n1. Создайте группу безопасности с названием litellm-service и добавьте в нее правила:\n- Правило входящего трафика:\n\n- Протокол: TCP\n- Порт: 443\n- Тип источника: IP-адрес\n- Источник: 0.0.0.0/0\n- Правило входящего трафика:\n\n- Протокол: TCP\n- Порт: 80\n- Тип источника: IP-адрес\n- Источник: 0.0.0.0/0\n- Правило исходящего трафика:\n\n- Протокол: Любой\n- Тип адресата: IP-адрес\n- Адресат: 0.0.0.0/0\n2. На странице Сети → Группы безопасности убедитесь, что отображается группа безопасности litellm-service со статусом «Создана».\n3. Создайте бесплатную виртуальную машину со следующими параметрами:\n\n- Название: litellm-service\n- Образ: публичный образ Ubuntu 22.04\n- Подключить публичный IP: включено\n- Тип IP: прямой IP-адрес\n- Группы безопасности: SSH-access_ru.AZ-1, litellm-service\n- Логин: litellm\n- Метод аутентификации: Публичный ключ и Пароль\n- Публичный ключ: укажите ранее созданный SSH-ключ\n- Пароль: задайте надежный пароль\n- Имя хоста: litellm-service\n4. На странице Инфраструктура → Виртуальные машины убедитесь, что отображается виртуальная машина litellm-service со статусом «Запущена».\n\n## 2. Сгенерируйте API-ключ для доступа к Foundation Models\nСледуйте инструкции по созданию API-ключа для Foundation Models.\nСохраните API-ключ, он будет использоваться для конфигурации сервиса.\n1. На верхней панели слева нажмите  и перейдите в раздел Пользователи, на вкладку Сервисные аккаунты.\n2. Нажмите на название сервисного аккаунта, который будете использовать для отправки запроса к модели.\n3. Перейдите на вкладку API-ключи.\n4. Нажмите Создать API-ключ.\n5. Введите название и описание API-ключа, которое поможет в будущем идентифицировать его среди других ключей.\n6. Заполните параметры API-ключа:\n- Сервисы — Foundation Models.\n- Время действия — срок действия API-ключа и часовой пояс.\nВы можете установить значение от одного дня до одного года с текущей даты.\nЕсли параметр не задан, срок действия ключа устанавливается на максимальное значение — один год.\nС целью повышения уровня безопасности рекомендуется выставлять средние значения, например 90 дней.\n- Интервал работы ключа — один или несколько интервалов времени, в которые можно использовать API-ключ.\n7. Нажмите Создать.\n8. Сохраните Key Secret.\nПосле закрытия окна получить его будет нельзя.\nСозданный API-ключ появится в списке ключей в статусе «Активен».\nПодробнее о работе с API-ключом.\n\n## 3. Настройте окружение на виртуальной машине\nНа этом шаге вы установите необходимые пакеты и настроите систему на виртуальной машине.\n1. Подключитесь к виртуальной машине litellm-service через серийную консоль или по SSH.\n2. Обновите систему и установите необходимые зависимости:\n```\nsudo apt update && sudo apt upgrade -y &&\\sudo apt install -y curl apt-transport-https\\                   ca-certificates\\                   software-properties-common\\                   gnupg2\\                   lsb-release\n```\n3. Установите Docker:\n```\ncurl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpgecho \"deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable\" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/nullsudo apt updatesudo apt install docker-ce docker-ce-cli containerd.io -y\n```\n4. Выдайте текущему пользователю права на запуск Docker:\n```\nsudo usermod -aG docker $USERnewgrp docker\n```\n5. Установите Docker Compose:\n```\nsudo apt-get install docker-compose-plugin -y\n```\n6. Проверьте, что Docker и Docker Compose установлены корректно:\n```\ndocker --versiondocker compose version\n```\n7. Установите Nginx сервер:\n```\nsudo apt install nginx -ysudo systemctl start nginxsudo systemctl enable nginx\n```\n8. Установите Let’s Encrypt и плагин для Nginx:\n```\nsudo apt install certbot python3-certbot-nginx -y\n```\n\n## 4. Настройте Nginx и HTTPS\nНа этом шаге вы настроите службу Nginx и обеспечите доступ по HTTPS.\n1. Подключитесь к виртуальной машине litellm-service через серийную консоль или по SSH.\n2. Настройте файервол:\n```\nsudo ufw allow OpenSSHsudo ufw allow 'Nginx Full'sudo ufw enable\n```\n3. Создайте конфигурационный файл:\n```\nsudo nano /etc/nginx/sites-available/litellm.conf\n```\n4. Вставьте конфигурацию, заменив <ip-address> на IP-адрес вашей виртуальной машины:\n```\nserver {   listen 80;   server_name litellm.<ip-address>.nip.io www.litellm.<ip-address>.nip.io;\n   location / {      proxy_pass http://localhost:4000;      proxy_set_header Host $host;      proxy_set_header X-Real-IP $remote_addr;      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;   }}\n```\n5. Примените конфигурацию и перезапустите nginx:\n```\nsudo ln -sf /etc/nginx/sites-available/litellm.conf /etc/nginx/sites-enabled/litellm.confsudo rm -f /etc/nginx/sites-enabled/defaultsudo nginx -tsudo systemctl reload nginx\n```\n6. Проверьте, что nginx работает:\n```\nsudo systemctl status nginx\n```\n\nСервис nginx должен быть в статусе «active (running)».\n7. Перейдите по адресу http://litellm.<ip-address>.nip.io.\nОткроется страница с текстом «502 Bad Gateway».\n8. Запустите команду для выпуска SSL-сертификата:\n```\nsudo certbot --nginx -d litellm.<ip-address>.nip.io --redirect --agree-tos -m <email>\n```\n\nГде:\n- <ip-address> — IP-адрес вашей виртуальной машины.\n- <email> — email-адрес для регистрации сертификата.\n9. После выпуска сертификата перейдите по адресу https://litellm.<ip-address>.nip.io.\nОткроется страница с текстом «502 Bad Gateway».\nВ свойствах сайта браузер отметит соединение как безопасное.\n\n## 5. Разверните приложение\nНа этом шаге вы развернете LiteLLM с помощью Docker Compose.\n1. Подключитесь к виртуальной машине litellm-service через серийную консоль или по SSH.\n2. Создайте структуру проекта:\n```\nmkdir -p $HOME/litellmcd $HOME/litellm\n```\n3. Создайте файл docker-compose.yml:\n```\nnano docker-compose.yml\n```\n4. Вставьте содержимое в файл docker-compose.yml:\n```\nservices:  postgres:    image: postgres:15    container_name: postgres-for-litellm    environment:      POSTGRES_USER: litellm      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}      POSTGRES_DB: litellm_db    volumes:      - postgres_data:/var/lib/postgresql/data    env_file:      - ./.env    ports:      - \"5432:5432\"    restart: unless-stopped    healthcheck:      test: [\"CMD-SHELL\", \"pg_isready -U litellm -d litellm_db\"]      interval: 10s      timeout: 5s      retries: 5\n  litellm:    image: ghcr.io/berriai/litellm:main-stable    container_name: litellm    ports:      - \"4000:4000\"    volumes:      - ./config.yaml:/app/config.yaml    env_file:      - ./.env    environment:      DATABASE_URL: \"postgresql://litellm:${POSTGRES_PASSWORD}@postgres:5432/litellm_db\"      LITELLM_MASTER_KEY: ${LITELLM_MASTER_KEY}      STORE_MODEL_IN_DB: \"true\"    depends_on:      postgres:        condition: service_healthy    restart: unless-stopped    command: [\"--config\", \"/app/config.yaml\"]volumes:  postgres_data:\n```\n5. Создайте файл конфигурации litellm config.yaml:\n```\nstore_model_in_db: truetelemetry: true\n```\n6. Создайте файл конфигурации .env, в котором LITELLM_MASTER_KEY — мастер-ключ и пароль для Litellm, POSTGRES_PASSWORD — пароль от Postgres:\n```\nLITELLM_MASTER_KEY=<your_litellm_key>POSTGRES_PASSWORD=<your_postgress_password>\n```\n\nКлючи и пароли могут быть сгенерированы с помощью команды:\n```\nopenssl rand -hex 32\n```\n7. Запустите сервис:\n```\ndocker-compose up -d\n```\n8. Проверьте, что сервисы запущены:\n```\ndocker compose ps\n```\n9. Перейдите по адресу https://litellm.<ip-address>.nip.io/ui.\nОткроется страница Litellm UI, при входе система попросит ввести данные Администратора.\nДля входа нужно указать:\n- Username — admin\n- Password — LITELLM_MASTER_KEY, созданный на шаге 6\n\n## 6. Добавьте модели из Foundation Models в Litellm\n1. Перейдите во вкладку Models → Endpoints, выберите Add Model.\n2. В поле Provider выберите OpenAI-compatible Endpoints.\n3. В поле LiteLLM Model Name(s) выберите Custom Model Name (Enter below).\n4. В поле Enter custom model name введите нужную модель из Foundation Models с дополнительным префиксом /openai, например:\n- openai/openai/gpt-oss-120b\n- openai/zai-org/GLM-4.5\n- openai/Qwen/Qwen3-Coder-480B-A35B-Instruct\n5. В поле Public Model Name вы можете задать удобное имя модели для обращения к ней через Litellm, например GLM-4.5 вместо openai/zai-org/GLM-4.5.\n6. В поле API base укажите эндпоинт для обращения к модели — https://foundation-models.api.cloud.ru/v1/.\n7. В поле OpenAI API Key введите API-ключ, полученный на шаге 2.\n8. Внизу страницы нажмите Test Connect, если все параметры указаны верно, то в ответ вы получите сообщение Connection to custom successful!.\n9. Нажмите Add Model.\nПомимо моделей из Foundation Models, вы можете добавить и модели от других провайдеров, в том числе зарубежных, чтобы в дальнейшем обращаться к ним через единый API-ключ Litellm.\n1. Создайте виртуальный ключ Litellm:\n1. Перейдите во вкладку Virtual Keys.\n2. Нажмите Create New Key.\nВы можете дополнительно настроить модели, которые будут доступны по этому ключу, лимиты на количество запросов в минуту, срок жизни ключа и другие параметры.\n3. Сохраните сгенерированный ключ.\n\n## 7. Обратитесь к добавленным моделям\nТеперь к добавленным моделям можно обращаться через единый эндпоинт litellm:\n```\nfrom openai import OpenAI\napi_key = \"litellm_api_key\" #API key generated in the previous stepurl = https://litellm.<ip-address>.nip.io/v1 #Substitute the IP address with the service\nclient = OpenAI(    api_key=api_key,    base_url=url)\nresponse = client.chat.completions.create(    model=\"GLM-4.5\",    max_tokens=5000,    temperature=0.5,    presence_penalty=0,    top_p=0.95,    messages=[        {            \"role\": \"user\",            \"content\":\"Как написать хороший код?\"        }    ])\nprint(response.choices[0].message.content)\n```\n\nДля повышения надежности можно использовать несколько разных провайдеров моделей.\nДля использования нескольких провайдеров моделей:\n1. Перейдите во вкладку Settings → Router Settings → Fallbacks.\n2. Нажмите Add Fallbacks.\n3. Выберите основную и резервную модель.\nПри недоступности основной модели запросы будут переадресованы на резервную.\n\n## 8. Отключите доступ по SSH для виртуальной машины\nДля повышения безопасности закройте доступ по SSH, после того как вы развернули и настроили сервис.\n1. В личном кабинете Cloud.ru на верхней панели слева нажмите  и выберите Инфраструктура → Виртуальные машины.\n2. В списке виртуальных машин выберите litellm-service.\n3. Перейдите на вкладку Сетевые параметры.\n4. В строке подсети нажмите  и выберите Изменить группы безопасности.\n5. Удалите группу SSH-access_ru и сохраните изменения.\n6. Убедитесь, что доступа нет — попробуйте подключиться к виртуальной машине по SSH.\nПосле отключения доступа по SSH, администрирование сервиса будет доступно через серийную консоль виртуальной машины.\n\n## Результат\nВ этой лабораторной работе вы развернули LLM-шлюз Litellm для работы в облаке Cloud.ru с возможностью использования разных LLM-провайдеров по единому API-ключу.\nПолученные навыки помогут вам создавать надежные и удобные AI-сервисы с использованием моделей Foundation Models.\n\n  [© 2025 Cloud.ru](https://cloud.ru)",
      "debug": {
        "start_page": 1,
        "end_page": 1
      }
    }
  ]
}