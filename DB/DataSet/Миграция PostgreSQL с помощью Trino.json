{
  "title": "Миграция PostgreSQL с помощью Trino",
  "chapters": [
    {
      "name": "Миграция PostgreSQL с помощью Trino",
      "content": "Практические руководства Evolution    \n\n # Миграция PostgreSQL с помощью Trino   Эта статья полезна?          \nС помощью этого руководства вы выполните миграцию таблиц между двумя источниками PostgreSQL с помощью Trino.\n\n## Постановка задачи\n1. Создать таблицу-источник и целевую таблицу.\n2. Перенести данные в целевую таблицу с помощью:\n- JDBC-клиента (DBeaver);\n- Python-скрипта.\n\n## Перед началом работы\n1. Зарегистрируйтесь в личном кабинете Cloud.ru.\nЕсли вы уже зарегистрированы, войдите под своей учетной записью.\n2. Настройте DNS-сервер и подсеть.\n3. Создайте кластер Data Platform, в котором будет размещен инстанс.\nНазовите кластер «dp-labs».\n4. Скачайте и установите root-сертификат на устройство.\n5. Установите JDBC-клиент DBeaver.\nВнимание Все сущности должны располагаться в одной VPC и подсетях одного типа.\n\n## Подготовка инфраструктуры\nПодготовьте базу данных и таблицы, которые будете переносить, а также каталоги и инстанс Trino.\n\n### Создайте Managed PostgreSQL®\n1. Создайте кластер Managed PostgreSQL.\n2. Создайте две базы данных с названиями:\n- pg_1 — это исходная база данных, которая содержит таблицы для миграции;\n- pg_2 — это целевая база данных, куда нужно перенести таблицы из pg_1.\n3. Сохраните пароль из карточки кластера в сервисе Secret Manager.\n\n### Создайте каталог Managed Trino\n1. Перейдите в раздел Evolution и выберите сервис  Managed Trino.\n2. Откройте раздел Каталоги.\n3. Нажмите Создать каталог.\n4. Заполните поля следующими значениями:\n- Название:\n- pg_1 — для исходной базы данных pg_1;\n- pg_2 — для целевой базы данных pg_2.\n- Коннектор — PostgreSQL.\n- Хост — внутренний IP, указанный в карточке кластера Managed PostgreSQL®.\n- Порт — порт, указанный в карточке кластера Managed PostgreSQL®.\n- Название базы данных:\n- pg_1\n- pg_2\n- Логин — логин, указанный в карточке кластера Managed PostgreSQL®.\n- Пароль — выберите секрет с паролем кластера Managed PostgreSQL®.\n5. Нажмите Создать.\n\n### Создайте инстанс Managed Trino\n1. Перейдите в раздел Evolution и выберите сервис  Managed Trino.\n2. Откройте раздел Инстансы.\n3. Нажмите Создать инстанс.\n4. В блоке Общие параметры заполните поля:\n- Название — trino-instance-migration.\n- Кластер — db-labs.\n- Вычислительные ресурсы — vCPU 4, RAM 16.\n- Количество node — 3.\n5. Нажмите Продолжить.\n6. На шаге Каталоги выберите каталоги «pg_1» и «pg_2».\n7. Нажмите Продолжить.\n8. В блоке Сетевые настройки заполните поля:\n- Зона доступности — выберите зону доступности, для которой создан SNAT-шлюз.\n- Подсеть — выберите подсеть с DNS-сервером.\n- Подключить публичный хост — активируйте опцию.\n- Пользователь — задайте имя пользователя для доступа к Trino.\n- Пароль — создайте пароль в сервисе Secret Manager, нажав Создать секрет, и выберите его.\n9. Нажмите Создать.\n\n### Создайте структуру данных\nВыполните команды:\n```\nCREATE SCHEMA IF NOT EXISTS pg_1.lab_migration;\nCREATE TABLE IF NOT EXISTS pg_1.lab_migration.users (id_user INT, email VARCHAR(255));\nINSERT INTO pg_1.lab_migration.users values (1, 'one@example.com'), (2, 'two@example.com'), (3, 'three@example.com');\n```\n\n## Миграция\nРассмотрим два способа миграции таблиц c помощью:\n- JDBC-клиента DBeaver;\n- Python-скрипта.\n\n### С помощью DBeaver\n1. Подключите инстанс к DBeaver.\n2. Чтобы подготовить данные, в DBeaver выполните SQL-запросы:\n```\nCREATE SCHEMA IF NOT EXISTS pg_1.lab_migration;\nCREATE TABLE IF NOT EXISTS pg_1.lab_migration.users (id_user INT, email VARCHAR(255));\nINSERT INTO pg_1.lab_migration.users values (1, 'xxx@example.com'), (2, 'yyy@example.com'), (3, 'zzz@example.com');\n```\n\nМожете создать дополнительные таблицы с данными в схеме «lab_migration» в базе данных «pg_1».\n3. Выполните:\nМиграция таблицы с данными Миграция таблицы без данных (только структура)```\nCREATE TABLE pg_2.lab_migration.users ASSELECT * FROM pg_1.lab_migration.users;\n```\n4. Автоматизируйте миграцию таблиц.\n1. Чтобы сгенерировать SQL-запросы для каждой таблицы, выполните:\n```\nSELECT   'CREATE TABLE pg_2.lab_migration.' || table_name ||   ' AS SELECT * FROM pg_1.lab_migration.' || table_name || ';'FROM pg_1.information_schema.tablesWHERE table_schema = 'lab_migration';\n```\n2. Скопируйте полученные строки.\n3. Выполните их по очереди.\n\n### С помощью скрипта\n1. В командной строке выполните:\n```\npython3 -m venv venvsource venv/bin/activatepip install trino\n```\n2. Скопируйте скрипт, введите необходимые значения и сохраните файл с названием trino_pg_migration.py:\n \n Скрипт Python\n3. Запустите скрипт:\n```\npython trino_pg_migration.py\n```\n\n## Проверка результата\nВ DBeaver выполните следующие запросы:\n- Чтобы проверить, что таблицы созданы:\n```\nSHOW TABLES IN pg_2.lab_migration;\n```\n- Чтобы проверить количество строк в каждой таблице:\n```\nSELECT COUNT(*) FROM pg_2.lab_migration.users;SELECT COUNT(*) FROM pg_2.lab_migration.products;SELECT COUNT(*) FROM pg_2.lab_migration.orders;\n```\n- Чтобы проверить содержимое (первые 10 строк):\n```\nSELECT * FROM pg_2.lab_migration.users LIMIT 10;SELECT * FROM pg_2.lab_migration.products LIMIT 10;SELECT * FROM pg_2.lab_migration.orders LIMIT 10;\n```\n\n  [© 2025 Cloud.ru](https://cloud.ru)",
      "debug": {
        "start_page": 1,
        "end_page": 1
      }
    }
  ]
}