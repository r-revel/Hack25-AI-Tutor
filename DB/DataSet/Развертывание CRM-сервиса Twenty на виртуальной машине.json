{
  "title": "Развертывание CRM-сервиса Twenty на виртуальной машине",
  "chapters": [
    {
      "name": "Развертывание CRM-сервиса Twenty на виртуальной машине",
      "content": "Практические руководства Evolution    \n\n # Развертывание CRM-сервиса Twenty на виртуальной машине   Эта статья полезна?          \nВ этой лабораторной работе вы развернете CRM‑сервис Twenty на бесплатной виртуальной машине в облаке Cloud.ru Evolution.\nВы создадите инфраструктуру, развернете сервис CRM и опубликуете его на сервере nginx, обеспечив безопасный доступ по HTTPS.\nВы создадите резервную копию виртуальной машины в сервисе «Резервное копирование» для сохранности данных.\nВ результате вы получите работающее окружение Twenty, развернутое из фиксированного тега образа и готовое к использованию.\nВы будете использовать следующие сервисы:\n- Виртуальная машина free tier — сервис, в рамках которого предоставляется бесплатная виртуальная машина с готовой конфигурацией.\n- Object Storage — объектное S3-хранилище с бесплатным хранением файлов, объемом до 15 ГБ.\n- Публичный IP-адрес — для доступа к приложению через интернет.\n- Резервное копирование — для создания резервных копий.\n- Docker  — система контейнеризации.\n- Docker Compose — инструмент для запуска и управления Docker-контейнерами.\n- Twenty CRM — CRM-сервис с открытым исходным кодом.\n- nip.io — бесплатный сервис динамического DNS для получения публичного доменного имени и сертификата.\nВы также можете использовать собственное зарегистрированное доменное имя и SSL-сертификат для организации доступа.\n- nginx — для проксирования запросов и организации защищенного HTTPS-доступа к приложению.\n- Let’s Encrypt — для автоматического получения бесплатного SSL-сертификата.\nШаги:\n1. Разверните ресурсы в облаке.\n2. Настройте окружение на виртуальной машине.\n3. Настройте nginx и HTTPS.\n4. Разверните приложение.\n5. Удалите доступ по SSH для виртуальной машины.\n6. Обеспечьте сохранность данных приложения.\n\n## Перед началом работы\n1. Зарегистрируйтесь в личном кабинете Cloud.ru.\nЕсли вы уже зарегистрированы, войдите под своей учетной записью.\n2. Сгенерируйте ключевую пару и загрузите публичный ключ в Cloud.ru Evolution.\n\n## 1. Разверните ресурсы в облаке\nВ этом шаге вы создадите группу безопасности и виртуальную машину.\n1. Создайте группу безопасности с названием crm-service и добавьте в нее правила:\n- Правило входящего трафика:\n- Протокол: TCP.\n- Порт: 443.\n- Тип источника: IP-адрес.\n- Источник: 0.0.0.0/0.\n- Правило входящего трафика:\n- Протокол: TCP.\n- Порт: 80.\n- Тип источника: IP-адрес.\n- Источник: 0.0.0.0/0.\n- Правило исходящего трафика:\n- Протокол: Любой.\n- Тип адресата: IP-адрес.\n- Адресат: 0.0.0.0/0.\nНа странице Сети → Группы безопасности убедитесь, что отображается группа безопасности crm-service со статусом «Создана».\n2. Создайте бесплатную виртуальную машину со следующими параметрами:\n- Название: crm-service.\n- Образ: публичный образ Ubuntu 22.04.\n- Подключить публичный IP: оставьте опцию включенной.\n- Тип IP: оставьте прямой IP-адрес.\n- Группы безопасности: SSH-access_ru.AZ-1 и crm-service.\n- Логин: crm.\n- Метод аутентификации: Публичный ключ и Пароль.\n- Публичный ключ: укажите ключ, созданный ранее.\n- Пароль: задайте пароль.\n- Имя хоста: crm-service.\nНа странице Инфраструктура → Виртуальные машины убедитесь, что отображается виртуальная машина crm-service со статусом «Запущена».\n3. Создайте бакет в Object Storage со следующими параметрами:\n- Название: crm-service.\n- Максимальный размер: 15 ГБ.\n- Класс хранения по умолчанию: Стандартный.\nПерейдите в раздел Object Storage API.\nСохраните значения ID тенанта и Регион.\n4. Создайте сервисный аккаунт со следующими параметрами:\n- Название: crm-service.\n- Описание: Аккаунт Object Storage.\n- Проект: Пользователь сервисов.\n- Evolution Object Storage Роли: s3e.viewer, s3e.editor.\n5. Сгенерируйте ключи доступа для сервисного аккаунта.\nСохраните Secret ID и Secret Key.\n\n## 2. Настройте окружение на виртуальной машине\nНа этом шаге вы установите необходимые пакеты и настроите систему на виртуальной машине.\n1. Подключитесь к виртуальной машине crm-service через серийную консоль или по SSH .\n2. Обновите систему и установите необходимые зависимости:\n```\nsudo apt update && sudo apt upgrade -y &&\\sudo apt install -y curl apt-transport-https\\                         ca-certificates\\                         software-properties-common\\                         gnupg2\\                         lsb-release\n```\n3. Установите Docker:\n```\ncurl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpgecho \"deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable\" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/nullsudo apt updatesudo apt install docker-ce docker-ce-cli containerd.io -y\n```\n4. Дайте текущему пользователю права на запуск Docker:\n```\nsudo usermod -aG docker $USERnewgrp docker\n```\n5. Установите Docker Compose:\n```\nsudo apt-get install docker-compose-plugin -y\n```\n6. Проверьте, что Docker и Docker Compose установлены корректно:\n```\ndocker --versiondocker compose version\n```\n7. Установите сервер nginx:\n```\nsudo apt install nginx -ysudo systemctl start nginxsudo systemctl enable nginx\n```\n8. Установите Let’s Encrypt и плагин для nginx:\n```\nsudo apt install certbot python3-certbot-nginx -y\n```\n\n## 3. Настройте nginx и HTTPS\nНа этом шаге вы настроите службу nginx и обеспечите доступ по HTTPS.\n1. Подключитесь к виртуальной машине crm-service через серийную консоль или по SSH .\n2. Настройте межсетевой экран:\n```\nsudo ufw allow OpenSSHsudo ufw allow 'Nginx Full'sudo ufw enable\n```\n3. Создайте конфигурационный файл:\n```\nsudo nano /etc/nginx/sites-available/crm.conf\n```\n4. Вставьте конфигурацию, заменив <IP-ADDRESS> на IP-адрес вашей виртуальной машины.\n```\nserver {   listen 80;   server_name crm.<IP-ADDRESS>.nip.io www.crm.<IP-ADDRESS>.nip.io;\n   # Proxy all other requests to Twenty CRM   location / {      proxy_pass http://localhost:3000;      proxy_http_version 1.1;      proxy_set_header Upgrade $http_upgrade;      proxy_set_header Connection 'upgrade';      proxy_set_header Host $host;      proxy_set_header X-Real-IP $remote_addr;      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;      proxy_set_header X-Forwarded-Proto $scheme;      proxy_cache_bypass $http_upgrade;      proxy_read_timeout 300;      proxy_connect_timeout 300;      proxy_send_timeout 300;   }}\n```\n5. Примените конфигурацию и перезапустите nginx:\n```\nsudo ln -sf /etc/nginx/sites-available/crm.conf /etc/nginx/sites-enabled/crm.confsudo rm -f /etc/nginx/sites-enabled/defaultsudo nginx -tsudo systemctl reload nginx\n```\n6. Проверьте, что nginx работает:\n```\nsudo systemctl status nginx\n```\n\nCервис nginx должен быть в статусе «active (running)».\n7. Перейдите по адресу http://crm.<IP-ADDRESS>.nip.io.\nОткроется страница с текстом «502 Bad Gateway».\n8. Запустите команду для выпуска SSL-сертификата.\n```\nsudo certbot --nginx -d crm.<IP-ADDRESS>.nip.io --redirect --agree-tos -m <EMAIL>\n```\n\nГде:\n- <IP-ADDRESS> — IP-адрес вашей виртуальной машины.\n- <EMAIL> — email для регистрации сертификата.\n9. После выпуска сертификата перейдите по адресу https://crm.<IP-ADDRESS>.nip.io.\nОткроется страница с текстом «502 Bad Gateway».\nВ свойствах сайта браузер отметит соединение как безопасное.\n\n## 4. Разверните приложение\nРазверните серверное приложение Twenty CRM с помощью Docker Compose.\n1. Подключитесь к виртуальной машине crm-service через серийную консоль или по SSH .\n2. Создайте структуру проекта:\n```\nmkdir ~/twenty-crmcd ~/twenty-crm\n```\n3. Сгенерируйте уникальный ключ и сохраните его, он понадобится в дальнейшем:\n```\nopenssl rand -base64 32\n```\n4. Сгенерируйте пароль для базы данных и сохраните его, он понадобится в дальнейшем:\n```\nopenssl rand -base64 15\n```\n5. Создайте файл docker-compose.yml:\n```\nnano docker-compose.yml\n```\n6. Вставьте код:\n```\nname: twenty\nservices:  server:    image: twentycrm/twenty:${TAG:-latest}    volumes:      - server-local-data:/app/packages/twenty-server/.local-storage    ports:      - \"3000:3000\"    environment:      NODE_PORT: 3000      PG_DATABASE_URL: postgres://${PG_DATABASE_USER:-postgres}:${PG_DATABASE_PASSWORD:-postgres}@${PG_DATABASE_HOST:-db}:${PG_DATABASE_PORT:-5432}/default      SERVER_URL: ${SERVER_URL}      REDIS_URL: ${REDIS_URL:-redis://redis:6379}      DISABLE_DB_MIGRATIONS: ${DISABLE_DB_MIGRATIONS}      DISABLE_CRON_JOBS_REGISTRATION: ${DISABLE_CRON_JOBS_REGISTRATION}      STORAGE_TYPE: ${STORAGE_TYPE}      STORAGE_S3_REGION: ${STORAGE_S3_REGION}      STORAGE_S3_NAME: ${STORAGE_S3_NAME}      STORAGE_S3_ENDPOINT: ${STORAGE_S3_ENDPOINT}      STORAGE_S3_ACCESS_KEY_ID: ${STORAGE_S3_ACCESS_KEY_ID}      STORAGE_S3_SECRET_ACCESS_KEY: ${STORAGE_S3_SECRET_ACCESS_KEY}      APP_SECRET: ${APP_SECRET:-replace_me_with_a_random_string}      # MESSAGING_PROVIDER_GMAIL_ENABLED: ${MESSAGING_PROVIDER_GMAIL_ENABLED}      # CALENDAR_PROVIDER_GOOGLE_ENABLED: ${CALENDAR_PROVIDER_GOOGLE_ENABLED}      # AUTH_GOOGLE_CLIENT_ID: ${AUTH_GOOGLE_CLIENT_ID}      # AUTH_GOOGLE_CLIENT_SECRET: ${AUTH_GOOGLE_CLIENT_SECRET}      # AUTH_GOOGLE_CALLBACK_URL: ${AUTH_GOOGLE_CALLBACK_URL}      # AUTH_GOOGLE_APIS_CALLBACK_URL: ${AUTH_GOOGLE_APIS_CALLBACK_URL}\n      # CALENDAR_PROVIDER_MICROSOFT_ENABLED: ${CALENDAR_PROVIDER_MICROSOFT_ENABLED}      # MESSAGING_PROVIDER_MICROSOFT_ENABLED: ${MESSAGING_PROVIDER_MICROSOFT_ENABLED}      # AUTH_MICROSOFT_ENABLED: ${AUTH_MICROSOFT_ENABLED}      # AUTH_MICROSOFT_CLIENT_ID: ${AUTH_MICROSOFT_CLIENT_ID}      # AUTH_MICROSOFT_CLIENT_SECRET: ${AUTH_MICROSOFT_CLIENT_SECRET}      # AUTH_MICROSOFT_CALLBACK_URL: ${AUTH_MICROSOFT_CALLBACK_URL}      # AUTH_MICROSOFT_APIS_CALLBACK_URL: ${AUTH_MICROSOFT_APIS_CALLBACK_URL}\n      # EMAIL_FROM_ADDRESS: ${EMAIL_FROM_ADDRESS:-contact@yourdomain.com}      # EMAIL_FROM_NAME: ${EMAIL_FROM_NAME:-\"John from YourDomain\"}      # EMAIL_SYSTEM_ADDRESS: ${EMAIL_SYSTEM_ADDRESS:-system@yourdomain.com}      # EMAIL_DRIVER: ${EMAIL_DRIVER:-smtp}      # EMAIL_SMTP_HOST: ${EMAIL_SMTP_HOST:-smtp.gmail.com}      # EMAIL_SMTP_PORT: ${EMAIL_SMTP_PORT:-465}      # EMAIL_SMTP_USER: ${EMAIL_SMTP_USER:-}      # EMAIL_SMTP_PASSWORD: ${EMAIL_SMTP_PASSWORD:-}\n    depends_on:      db:        condition: service_healthy    healthcheck:      test: curl --fail http://localhost:3000/healthz      interval: 5s      timeout: 5s      retries: 20    restart: always\n  worker:    image: twentycrm/twenty:${TAG:-latest}    volumes:      - server-local-data:/app/packages/twenty-server/.local-storage    command: [\"yarn\", \"worker:prod\"]    environment:      PG_DATABASE_URL: postgres://${PG_DATABASE_USER:-postgres}:${PG_DATABASE_PASSWORD:-postgres}@${PG_DATABASE_HOST:-db}:${PG_DATABASE_PORT:-5432}/default      SERVER_URL: ${SERVER_URL}      REDIS_URL: ${REDIS_URL:-redis://redis:6379}      DISABLE_DB_MIGRATIONS: \"true\"      DISABLE_CRON_JOBS_REGISTRATION: \"true\"      STORAGE_TYPE: ${STORAGE_TYPE}      STORAGE_S3_REGION: ${STORAGE_S3_REGION}      STORAGE_S3_NAME: ${STORAGE_S3_NAME}      STORAGE_S3_ENDPOINT: ${STORAGE_S3_ENDPOINT}      STORAGE_S3_ACCESS_KEY_ID: ${STORAGE_S3_ACCESS_KEY_ID}      STORAGE_S3_SECRET_ACCESS_KEY: ${STORAGE_S3_SECRET_ACCESS_KEY}      APP_SECRET: ${APP_SECRET:-replace_me_with_a_random_string}      # MESSAGING_PROVIDER_GMAIL_ENABLED: ${MESSAGING_PROVIDER_GMAIL_ENABLED}      # CALENDAR_PROVIDER_GOOGLE_ENABLED: ${CALENDAR_PROVIDER_GOOGLE_ENABLED}      # AUTH_GOOGLE_CLIENT_ID: ${AUTH_GOOGLE_CLIENT_ID}      # AUTH_GOOGLE_CLIENT_SECRET: ${AUTH_GOOGLE_CLIENT_SECRET}      # AUTH_GOOGLE_CALLBACK_URL: ${AUTH_GOOGLE_CALLBACK_URL}      # AUTH_GOOGLE_APIS_CALLBACK_URL: ${AUTH_GOOGLE_APIS_CALLBACK_URL}\n      # CALENDAR_PROVIDER_MICROSOFT_ENABLED: ${CALENDAR_PROVIDER_MICROSOFT_ENABLED}      # MESSAGING_PROVIDER_MICROSOFT_ENABLED: ${MESSAGING_PROVIDER_MICROSOFT_ENABLED}      # AUTH_MICROSOFT_ENABLED: ${AUTH_MICROSOFT_ENABLED}      # AUTH_MICROSOFT_CLIENT_ID: ${AUTH_MICROSOFT_CLIENT_ID}      # AUTH_MICROSOFT_CLIENT_SECRET: ${AUTH_MICROSOFT_CLIENT_SECRET}      # AUTH_MICROSOFT_CALLBACK_URL: ${AUTH_MICROSOFT_CALLBACK_URL}      # AUTH_MICROSOFT_APIS_CALLBACK_URL: ${AUTH_MICROSOFT_APIS_CALLBACK_URL}\n      # EMAIL_FROM_ADDRESS: ${EMAIL_FROM_ADDRESS:-contact@yourdomain.com}      # EMAIL_FROM_NAME: ${EMAIL_FROM_NAME:-\"John from YourDomain\"}      # EMAIL_SYSTEM_ADDRESS: ${EMAIL_SYSTEM_ADDRESS:-system@yourdomain.com}      # EMAIL_DRIVER: ${EMAIL_DRIVER:-smtp}      # EMAIL_SMTP_HOST: ${EMAIL_SMTP_HOST:-smtp.gmail.com}      # EMAIL_SMTP_PORT: ${EMAIL_SMTP_PORT:-465}      # EMAIL_SMTP_USER: ${EMAIL_SMTP_USER:-}      # EMAIL_SMTP_PASSWORD: ${EMAIL_SMTP_PASSWORD:-}\n    depends_on:      db:        condition: service_healthy      server:        condition: service_healthy    restart: always\n  db:    image: postgres:16    volumes:      - db-data:/var/lib/postgresql/data    environment:      POSTGRES_USER: ${PG_DATABASE_USER:-postgres}      POSTGRES_PASSWORD: ${PG_DATABASE_PASSWORD:-postgres}    healthcheck:      test: pg_isready -U ${PG_DATABASE_USER:-postgres} -h localhost -d postgres      interval: 5s      timeout: 5s      retries: 10    restart: always\n  redis:    image: redis    restart: always    command: [ \"redis-server\", \"--maxmemory-policy\", \"noeviction\" ]\nvolumes:  db-data:  server-local-data:\n```\n\nФайл docker-compose.yml содержит закоментированные секции для включения интеграций с Google, Microsoft и email.\nДля настройки этих интеграций, раскомментируйте необходимые параметры и добавьте значения в файл .env.\nПодробнее — в документации  Twenty CRM.\n7. Создайте файл .env:\n```\nnano .env\n```\n8. Вставьте код в файл:\n```\nTAG=<TAG>\nPG_DATABASE_USER=postgresPG_DATABASE_PASSWORD=<PG_DATABASE_PASSWORD>PG_DATABASE_HOST=dbPG_DATABASE_PORT=5432REDIS_URL=redis://redis:6379\nSERVER_URL=https://crm.<IP-ADDRESS>.nip.io\n# Use openssl rand -base64 32 for each secretAPP_SECRET=<APP_SECRET>\nSTORAGE_TYPE=s3STORAGE_S3_NAME=<OBJECT-STORAGE-NAME>STORAGE_S3_REGION=<REGION>STORAGE_S3_ENDPOINT=https://s3.cloud.ruSTORAGE_S3_ACCESS_KEY_ID=<TENANT_ID>:<SECRET_KEY_ID>STORAGE_S3_SECRET_ACCESS_KEY=<SECRET_KEY>STORAGE_S3_FORCE_PATH_STYLE=true\n```\n\nГде:\n- <TAG> — тeг docker-образа Twenty CRM. Для этой лабораторной работы используйте значение v1.3.0.\nДругие теги могут требовать иной конфигурации.\nАктуальный список тегов доступен на странице docker-образа Twenty CRM.\n- <APP_SECRET> — уникальный ключ, сгенерированный ранее.\n- <PG_DATABASE_PASSWORD> — пароль от базы данных, сгенерированный ранее.\n- <IP-ADDRESS> — IP-адрес вашей виртуальной машины.\n- <OBJECT-STORAGE-NAME> — название бакета Object Storage.\n- <TENANT_ID> — ID тенанта сервиса Object Storage.\n- <REGION> — регион Object Storage.\n- <SECRET_KEY_ID>, <SECRET_KEY> — ID ключа и секретный ключ доступа к Object Storage.\n- <BUCKET_NAME> — название бакета Object Storage.\n9. Запустите сервис:\n```\ndocker compose up -d\n```\n10. Проверьте, что сервисы запущены:\n```\ndocker compose ps\n```\n11. На компьютере в браузере откройте страницу https://crm.<IP-ADDRESS>.nip.io.\nОтобразится страница настройки Twenty CRM.\n\n## 5. Отключите SSH-доступ\nКогда вы развернули и настроили сервис, закройте доступ по SSH для повышения безопасности.\n1. В личном кабинете на верхней панели слева нажмите  и выберите Инфраструктура → Виртуальные машины.\n2. В списке виртуальных машин выберите crm-service.\n3. Перейдите на вкладку Сетевые параметры.\n4. В строке подсети нажмите  и выберите Изменить группы безопасности.\n5. Удалите группу SSH-access_ru и сохраните изменения.\n6. Убедитесь, что доступа нет — попробуйте подключиться к виртуальной машине по SSH.\nПосле отключения доступа по SSH, администрирование сервиса будет доступно через серийную консоль виртуальной машины.\n\n## 6. Обеспечьте сохранность данных приложения\nСоздайте резервную копию виртуальной машины со следующими параметрами:\n- Тип ресурса: Виртуальная машина.\n- Ресурс: crm-service.\n- Название: crm-service-backup.\n- Описание: Резервная копия CRM.\nУбедитесь, что в личном кабинете на странице Инфраструктура → Виртуальные машины отображается резервная копия crm-service-backup со статусом «Создана».\nПериодически создавайте резервные копии для сохранности данных.\n\n## Результат\nВы развернули CRM-сервис для командной работы на бесплатной виртуальной машине в облаке Cloud.ru с надежной сетевой изоляцией и публикацией по HTTPS.\nПолученные навыки помогут вам создавать сервисы с использованием облачного хранилища и безопасной инфраструктурой.\nДля создания отказоустойчивого и масштабируемого решения с надежным хранением данных вы можете воспользоваться сервисами Managed PostgreSQL®, Managed Redis® и Object Storage.\nПри необходимости активируйте интеграции с Google, Microsoft и email.\n\n  [© 2025 Cloud.ru](https://cloud.ru)",
      "debug": {
        "start_page": 1,
        "end_page": 1
      }
    }
  ]
}