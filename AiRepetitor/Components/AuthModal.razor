<!--AiRepetitor\Components\AuthModal.razor-->
@using Microsoft.AspNetCore.Identity
@using System.ComponentModel.DataAnnotations
@inject SignInManager<IdentityUser> SignInManager
@inject UserManager<IdentityUser> UserManager
@inject NavigationManager Nav

<div class="auth-backdrop">
    <div class="auth-modal">
        <div class="auth-tabs">
            <button type="button"
                    class="auth-tab @(isLoginMode ? "auth-tab--active" : "")"
                    @onclick="@(() => SwitchMode(true))">
                Вход
            </button>
            <button type="button"
                    class="auth-tab @(!isLoginMode ? "auth-tab--active" : "")"
                    @onclick="@(() => SwitchMode(false))">
                Регистрация
            </button>
        </div>

        <div class="auth-body">
            <h2 class="auth-title">@((isLoginMode ? "Вход" : "Регистрация"))</h2>

            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="auth-alert">
                    @errorMessage
                </div>
            }

            @if (isLoginMode)
            {
                <EditForm Model="@loginModel" OnValidSubmit="@HandleLoginAsync">
                    <DataAnnotationsValidator />
                    <ValidationSummary class="auth-validation-summary" />

                    <div class="auth-field">
                        <label class="auth-label">E-mail</label>
                        <InputText class="auth-input" @bind-Value="loginModel.Email" />
                        <ValidationMessage For="@(() => loginModel.Email)" class="auth-validation" />
                    </div>

                    <div class="auth-field">
                        <label class="auth-label">Пароль</label>
                        <InputText class="auth-input" type="password" @bind-Value="loginModel.Password" />
                        <ValidationMessage For="@(() => loginModel.Password)" class="auth-validation" />
                    </div>

                    <div class="auth-field auth-field--horizontal">
                        <InputCheckbox class="auth-checkbox" @bind-Value="loginModel.RememberMe" />
                        <label class="auth-label-inline">Запомнить меня</label>
                    </div>

                    <button type="submit" class="auth-button-primary">
                        Войти
                    </button>
                </EditForm>
            }
            else
            {
                <EditForm Model="@registerModel" OnValidSubmit="@HandleRegisterAsync">
                    <DataAnnotationsValidator />
                    <ValidationSummary class="auth-validation-summary" />

                    <div class="auth-field">
                        <label class="auth-label">E-mail</label>
                        <InputText class="auth-input" @bind-Value="registerModel.Email" />
                        <ValidationMessage For="@(() => registerModel.Email)" class="auth-validation" />
                    </div>

                    <div class="auth-field">
                        <label class="auth-label">Пароль</label>
                        <InputText class="auth-input" type="password" @bind-Value="registerModel.Password" />
                        <ValidationMessage For="@(() => registerModel.Password)" class="auth-validation" />
                    </div>

                    <div class="auth-field">
                        <label class="auth-label">Повтор пароля</label>
                        <InputText class="auth-input" type="password" @bind-Value="registerModel.ConfirmPassword" />
                        <ValidationMessage For="@(() => registerModel.ConfirmPassword)" class="auth-validation" />
                    </div>

                    <button type="submit" class="auth-button-primary">
                        Зарегистрироваться
                    </button>
                </EditForm>
            }
        </div>
    </div>
</div>

@code {
    private bool isLoginMode = true;
    private string? errorMessage;

    private readonly LoginModel loginModel = new();
    private readonly RegisterModel registerModel = new();

    private void SwitchMode(bool login)
    {
        isLoginMode = login;
        errorMessage = null;
    }

    @* private async Task HandleLoginAsync()
    {
        errorMessage = null;

        var result = await SignInManager.PasswordSignInAsync(
            loginModel.Email,
            loginModel.Password,
            loginModel.RememberMe,
            lockoutOnFailure: false);

        if (result.Succeeded)
        {
            // Обновляем страницу, чтобы подтянулось новое состояние аутентификации
            Nav.NavigateTo(Nav.Uri, forceLoad: true);
        }
        else
        {
            errorMessage = "Неверный логин или пароль";
        }
    } *@

private async Task HandleLoginAsync()
{
    errorMessage = "Логин сейчас не активен (cookie аутентификация отключена внутри компонента).";
}
    private async Task HandleRegisterAsync()
{
    errorMessage = null;

    var user = new IdentityUser
    {
        UserName = registerModel.Email,
        Email = registerModel.Email
    };

    var result = await UserManager.CreateAsync(user, registerModel.Password);

    if (result.Succeeded)
    {
        // НЕ вызываем SignInAsync — из Blazor-сокета нельзя безопасно ставить cookie
        // Переключаемся на вкладку "Вход" и подставляем e-mail
        isLoginMode = true;
        loginModel.Email = registerModel.Email;
        loginModel.Password = string.Empty;

        errorMessage = "Аккаунт создан. Введите пароль, чтобы войти.";
        StateHasChanged();
    }
    else
    {
        errorMessage = string.Join("; ", result.Errors.Select(e => e.Description));
    }
}


    public class LoginModel
    {
        [Required, EmailAddress]
        public string Email { get; set; } = string.Empty;

        [Required, DataType(DataType.Password)]
        public string Password { get; set; } = string.Empty;

        public bool RememberMe { get; set; }
    }

    public class RegisterModel
    {
        [Required, EmailAddress]
        public string Email { get; set; } = string.Empty;

        [Required, MinLength(6)]
        [DataType(DataType.Password)]
        public string Password { get; set; } = string.Empty;

        [Required]
        [DataType(DataType.Password)]
        [Compare(nameof(Password), ErrorMessage = "Пароли не совпадают")]
        public string ConfirmPassword { get; set; } = string.Empty;
    }
}
