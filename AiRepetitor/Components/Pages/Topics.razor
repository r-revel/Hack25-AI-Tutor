<!-- AiRepetitor\Components\Pages\Topics.razor.css -->
@page "/topics"
@attribute [Authorize]
@using AiRepetitor.Services
@using Microsoft.AspNetCore.Authorization
@inject BackendApi Backend
@inject NavigationManager Nav

<h3>Темы</h3>

@if (topics is null)
{
    <p>Загрузка...</p>
}
else if (!topics.Any())
{
    <p>Тем пока нет.</p>
}
else
{
    <div class="topics-container">
        @foreach (var t in topics)
        {
            <div class="topic-card">
                <h4>@t.title</h4>

                <p class="topic-description">
                    @if (!expandedTopics.Contains(t.id))
                    {
                        @(t.description?.Length > 150 ? t.description[..150] + "..." : t.description)
                        @if (t.description?.Length > 150)
                        {
                            <span class="expand-link" @onclick="() => ToggleExpand(t.id)">Читать далее</span>

                        }
                    }
                    else
                    {
                        @(t.description ?? "")
                        <a href="#" @onclick="() => ToggleExpand(t.id)" @onclick:preventDefault>Свернуть</a>
                    }
                </p>

                <button class="btn btn-primary" @onclick="() => StartTest(t.id)">
                    Начать тест
                </button>
            </div>
        }
    </div>
}

@code {
    private List<TopicResponseDto>? topics;
    private HashSet<int> expandedTopics = new();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            topics = (await Backend.GetTopicsAsync()).ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine("Ошибка загрузки тем: " + ex.Message);
        }
    }

    private async Task StartTest(int topicId)
    {
        var session = await Backend.StartTestAsync(topicId);
        if (session is not null)
        {
            Nav.NavigateTo($"/test/{session.id}");
        }
    }

    private void ToggleExpand(int topicId)
    {
        if (expandedTopics.Contains(topicId))
            expandedTopics.Remove(topicId);
        else
            expandedTopics.Add(topicId);
    }
}
