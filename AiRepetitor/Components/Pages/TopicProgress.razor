@page "/topics/{TopicId:int}"
@attribute [Authorize]
@using AiRepetitor.Services
@using Microsoft.AspNetCore.Authorization
@using System.Security.Claims
@inject BackendApi Backend
@inject AuthenticationStateProvider AuthStateProvider

<h3>Обучение по теме</h3>

@if (messages is null)
{
    <p>Загрузка...</p>
}
else
{
    <div class="chat">
        @foreach (var m in messages)
        {
            <div class="chat-msg">
                @m.message
            </div>
        }
    </div>

    <input @bind="input" />
    <button @onclick="Send">Отправить</button>
}

@code {
    [Parameter] public int TopicId { get; set; }

    private List<UserProgressResponseDto>? messages;
    private string input = "";
    private ClaimsPrincipal? _user;

    protected override async Task OnInitializedAsync()
    {
        var auth = await AuthStateProvider.GetAuthenticationStateAsync();
        _user = auth.User;

        messages = (await Backend.GetTopicProgressAsync(TopicId, _user)).ToList();
    }

    private async Task Send()
    {
        if (string.IsNullOrWhiteSpace(input) || _user is null)
            return;

        var list = await Backend.SendTopicMessageAsync(TopicId, input, _user);
        messages = list.ToList();

        input = "";
    }
}
