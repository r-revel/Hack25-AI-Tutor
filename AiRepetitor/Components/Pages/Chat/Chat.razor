@page "/"

@using System.ComponentModel
@using Microsoft.AspNetCore.Authorization
@inject BackendApi BackendApi
@inject SemanticSearch Search
@inject NavigationManager Nav

@implements IDisposable
@using Blazored.LocalStorage
@inject ILocalStorageService LocalStorage

<PageTitle>Chat</PageTitle>

<AuthorizeView>
    <Authorized>
        <!-- Верхний sticky header -->
        <header class="chat-header-bar">
            <div class="chat-header-left">
                <button class="chat-action-btn" @onclick="@(() => Nav.NavigateTo("/topics"))">
                    Темы
                </button>
                <button class="chat-action-btn" @onclick="@(() => Nav.NavigateTo("/test/history"))">
                    История
                </button>
                <!-- Кнопка для перехода на страницу создания нового топика -->
                <button class="chat-action-btn" @onclick="@(() => Nav.NavigateTo("/create-topic"))">
                    Создать новый топик
                </button>
            </div>

            <div class="chat-header-right">
                <button class="chat-action-btn" @onclick="@ResetConversationAsync">
                    Новый чат
                </button>

                <form method="post" action="/logout">
                    <button type="submit" class="chat-action-btn chat-action-btn--ghost">
                        Выйти
                    </button>
                </form>
            </div>
        </header>

        <!-- Chat messages -->
        <ChatMessageList Messages="@messages" InProgressMessage="@currentResponseMessage">
            <NoMessagesContent>
                <div>
                    <div class="example-docs mt-2 flex flex-col gap-1">
                    </div>
                </div>
            </NoMessagesContent>
        </ChatMessageList>

        <!-- Chat input & suggestions -->
        <div class="chat-container">
            <ChatSuggestions OnSelected="@AddUserMessageAsync" @ref="@chatSuggestions" />
            <ChatInput OnSend="@AddUserMessageAsync" @ref="@chatInput" />
            <SurveyPrompt />
        </div>
    </Authorized>

    <NotAuthorized>
        <AuthModal />
    </NotAuthorized>
</AuthorizeView>


@code {
    private const string SystemPrompt = @"
    You are an assistant who answers questions about information you retrieve.
    Do not answer questions about anything else.
    Use only simple markdown to format your responses.

    Use the search tool to find relevant information. When you do this, end your
    reply with citations in the special XML format:

    <citation filename='string' page_number='number'>exact quote here</citation>

    Always include the citation in your response if there are results.
    The quote must be max 5 words, taken word-for-word from the search result, and is the basis for why the citation is relevant.
    ";

    private readonly ChatOptions chatOptions = new();
    private readonly List<ChatMessage> messages = new();
    private readonly List<string> exampleDocuments = new()
    {
        "Example_GPS_Watch.pdf",
        "Example_Emergency_Survival_Kit.pdf"
    };

    private CancellationTokenSource? currentResponseCancellation;
    private ChatMessage? currentResponseMessage;
    private ChatInput? chatInput;
    private ChatSuggestions? chatSuggestions;
    private bool isFirstLoad = true;
    @inject AuthenticationStateProvider AuthStateProvider

    

    protected override async Task OnInitializedAsync()
    {
        // Попробуем загрузить сохраненные сообщения
        var savedMessages = await LocalStorage.GetItemAsync<List<ChatMessage>>("chatMessages");
        if (savedMessages != null)
        {
            messages.AddRange(savedMessages);
        }
        else
        {
            messages.Add(new(ChatRole.System, SystemPrompt));
        }

        chatOptions.Tools = new[] { AIFunctionFactory.Create(SearchAsync) };


        if (isFirstLoad)
        {
            await LoadTopicProgressAsync();
            isFirstLoad = false;
        }
    }
    private async Task LoadTopicProgressAsync()
    {
        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;
            
            var progressData = await BackendApi.GetTopicProgressAsync(
                topicId: 1,
                user: user
            );
            
                 // Преобразуем прогресс в сообщения чата
            foreach (var progress in progressData)
            {
                messages.Add(new ChatMessage(
                    ChatRole.Assistant,
                    $"Прогресс: {progress.message} (Дата: {progress.created_at})"
                ));
            }
            @* chatSuggestions?.Update(messages); *@
        
        // Сохраняем в LocalStorage
        }
        catch (Exception ex)
        {
            // Обработка ошибки
            Console.WriteLine($"Error loading topic progress: {ex.Message}");
        }
    }
    private async Task AddUserMessageAsync(ChatMessage userMessage)
    {
        CancelAnyCurrentResponse();

        messages.Add(userMessage);
        chatSuggestions?.Clear();
        await chatInput!.FocusAsync();

        currentResponseCancellation = new();

        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (messageText is { Length: > 0 } text)
        {
            await BackendApi.SendTopicMessageAsync(
            topicId: 1,
            message: text,
            user: user,
            ct: currentResponseCancellation.Token
            );

        }

        @* var assistantText = await BackendApi.ChatAsync(
            model: "my-custom-model",
            messages: messages,
            ct: currentResponseCancellation.Token); *@

        @* messages.Add(new(ChatRole.Assistant, assistantText)); *@
        @* chatSuggestions?.Update(messages); *@

        // Сохранить обновленные сообщения в LocalStorage
        @* await LocalStorage.SetItemAsync("chatMessages", messages); *@
    }

    private void CancelAnyCurrentResponse()
    {
        currentResponseCancellation?.Cancel();
        currentResponseMessage = null;
    }

    private async Task ResetConversationAsync()
    {
        CancelAnyCurrentResponse();
        messages.Clear();
        messages.Add(new(ChatRole.System, SystemPrompt));
        chatSuggestions?.Clear();
        await chatInput!.FocusAsync();

        // Сбросить сохраненные сообщения в LocalStorage
        await LocalStorage.RemoveItemAsync("chatMessages");
    }

    private async Task<IEnumerable<string>> SearchAsync(string searchPhrase, string? filenameFilter = null)
    {
        var results = await Search.SearchAsync(searchPhrase, filenameFilter, maxResults: 5);
        return results.Select(r =>
            $"<result filename=\"{r.FileName}\" page_number=\"{r.PageNumber}\">{r.Text}</result>");
    }

    private void OpenDocument(string fileName)
    {
        var url = $"Data/{fileName}";
        Nav.NavigateTo(url, true); // открытие PDF в новой вкладке
    }

    public void Dispose() => currentResponseCancellation?.Cancel();
}