<!-- AiRepetitor/Components/Pages/Chat/Chat.razor -->
@page "/"

@using System.ComponentModel
@using Microsoft.AspNetCore.Authorization
@inject BackendApi BackendApi
@inject SemanticSearch Search
@inject NavigationManager Nav

@implements IDisposable

<PageTitle>Chat</PageTitle>

<AuthorizeView>
    <Authorized>

      <nav class="chat-toolbar">
    <div class="chat-toolbar__left">
        <span class="chat-app-title">AI Repetitor</span>
    </div>

    <div class="chat-toolbar__right">
        <button class="chat-link" @onclick="@(() => Nav.NavigateTo("/topics"))">
            Темы
        </button>

        <button class="chat-link" @onclick="@(() => Nav.NavigateTo("/test/history"))">
            История
        </button>

        <form method="post" action="/logout">
            <button type="submit" class="chat-link chat-link--danger">
                Выйти
            </button>
        </form>
    </div>
</nav>



        <ChatHeader OnNewChat="@ResetConversationAsync" />

        <ChatMessageList Messages="@messages" InProgressMessage="@currentResponseMessage">
            <NoMessagesContent>
                <div>
                    To get started, try asking about these example documents.
                </div>
            </NoMessagesContent>
        </ChatMessageList>

        <div class="chat-container">
            <ChatSuggestions OnSelected="@AddUserMessageAsync" @ref="@chatSuggestions" />
            <ChatInput OnSend="@AddUserMessageAsync" @ref="@chatInput" />
            <SurveyPrompt />
        </div>

    </Authorized>

    <NotAuthorized>
        <AuthModal />
    </NotAuthorized>
</AuthorizeView>

@code {
        private const string SystemPrompt = @"
        You are an assistant who answers questions about information you retrieve.
        Do not answer questions about anything else.
        Use only simple markdown to format your responses.

        Use the search tool to find relevant information. When you do this, end your
        reply with citations in the special XML format:

        <citation filename='string' page_number='number'>exact quote here</citation>

        Always include the citation in your response if there are results.

        The quote must be max 5 words, taken word-for-word from the search result, and is the basis for why the citation is relevant.
        Don't refer to the presence of citations; just emit these tags right at the end, with no surrounding text.
    ";


    private readonly ChatOptions chatOptions = new();
    private readonly List<ChatMessage> messages = new();
    private CancellationTokenSource? currentResponseCancellation;
    private ChatMessage? currentResponseMessage;
    private ChatInput? chatInput;
    private ChatSuggestions? chatSuggestions;

    protected override void OnInitialized()
    {
        messages.Add(new(ChatRole.System, SystemPrompt));
        chatOptions.Tools = [AIFunctionFactory.Create(SearchAsync)];
    }

    private async Task AddUserMessageAsync(ChatMessage userMessage)
    {
        CancelAnyCurrentResponse();

        messages.Add(userMessage);
        chatSuggestions?.Clear();
        await chatInput!.FocusAsync();

        currentResponseCancellation = new();

        var assistantText = await BackendApi.ChatAsync(
            model: "my-custom-model",
            messages: messages,
            ct: currentResponseCancellation.Token);

        messages.Add(new(ChatRole.Assistant, assistantText));
        chatSuggestions?.Update(messages);
    }

    private void CancelAnyCurrentResponse()
    {
        currentResponseCancellation?.Cancel();
        currentResponseMessage = null;
    }

    private async Task ResetConversationAsync()
    {
        CancelAnyCurrentResponse();
        messages.Clear();
        messages.Add(new(ChatRole.System, SystemPrompt));
        chatSuggestions?.Clear();
        await chatInput!.FocusAsync();
    }

    private async Task<IEnumerable<string>> SearchAsync(string searchPhrase, string? filenameFilter = null)
    {
        var results = await Search.SearchAsync(searchPhrase, filenameFilter, maxResults: 5);
        return results.Select(r =>
            $"<result filename=\"{r.FileName}\" page_number=\"{r.PageNumber}\">{r.Text}</result>");
    }

    public void Dispose()
        => currentResponseCancellation?.Cancel();
}


