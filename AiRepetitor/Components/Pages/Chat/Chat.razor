@page "/"

@using System.ComponentModel
@using Microsoft.AspNetCore.Authorization
@inject BackendApi BackendApi
@inject SemanticSearch Search
@inject NavigationManager Nav

@implements IDisposable
@using Blazored.LocalStorage
@inject ILocalStorageService LocalStorage

<PageTitle>Chat</PageTitle>

<AuthorizeView>
    <Authorized>

        <!-- Верхний sticky header -->
        <header class="chat-header-bar">
            <div class="chat-header-left">
                <button class="chat-action-btn" @onclick="@(() => Nav.NavigateTo("/topics"))">
                    Темы
                </button>
                <button class="chat-action-btn" @onclick="@(() => Nav.NavigateTo("/test/history"))">
                    История
                </button>
            </div>

            <div class="chat-header-right">
                <button class="chat-action-btn" @onclick="@ResetConversationAsync">
                    Новый чат
                </button>

                <form method="post" action="/logout">
                    <button type="submit" class="chat-action-btn chat-action-btn--ghost">
                        Выйти
                    </button>
                </form>
            </div>
        </header>

        <!-- Chat messages -->
        <ChatMessageList Messages="@messages" InProgressMessage="@currentResponseMessage">
            <NoMessagesContent>
                <div>
                    To get started, try asking about these example documents:
                    <div class="example-docs mt-2 flex flex-col gap-1">
                        @foreach (var doc in exampleDocuments.Distinct())
                        {
                            <button class="example-doc-btn text-blue-600 hover:underline"
                                    @onclick="() => OpenDocument(doc)">
                                @doc
                            </button>
                        }
                    </div>
                </div>
            </NoMessagesContent>
        </ChatMessageList>

        <!-- Chat input & suggestions -->
        <div class="chat-container">
            <ChatSuggestions OnSelected="@AddUserMessageAsync" @ref="@chatSuggestions" />
            <ChatInput OnSend="@AddUserMessageAsync" @ref="@chatInput" />
            <SurveyPrompt />
        </div>

    </Authorized>

    <NotAuthorized>
        <AuthModal />
    </NotAuthorized>
</AuthorizeView>

@code {
    private const string SystemPrompt = @"
    You are an assistant who answers questions about information you retrieve.
    Do not answer questions about anything else.
    Use only simple markdown to format your responses.

    Use the search tool to find relevant information. When you do this, end your
    reply with citations in the special XML format:

    <citation filename='string' page_number='number'>exact quote here</citation>

    Always include the citation in your response if there are results.
    The quote must be max 5 words, taken word-for-word from the search result, and is the basis for why the citation is relevant.
    ";

    private readonly ChatOptions chatOptions = new();
    private readonly List<ChatMessage> messages = new();
    private readonly List<string> exampleDocuments = new()
    {
        "Example_GPS_Watch.pdf",
        "Example_Emergency_Survival_Kit.pdf"
    };

    private CancellationTokenSource? currentResponseCancellation;
    private ChatMessage? currentResponseMessage;
    private ChatInput? chatInput;
    private ChatSuggestions? chatSuggestions;

    protected override async Task OnInitializedAsync()
    {
        // Попробуем загрузить сохраненные сообщения
        var savedMessages = await LocalStorage.GetItemAsync<List<ChatMessage>>("chatMessages");
        if (savedMessages != null)
        {
            messages.AddRange(savedMessages);
        }
        else
        {
            messages.Add(new(ChatRole.System, SystemPrompt));
        }

        chatOptions.Tools = new[] { AIFunctionFactory.Create(SearchAsync) };
    }

    private async Task AddUserMessageAsync(ChatMessage userMessage)
    {
        CancelAnyCurrentResponse();

        messages.Add(userMessage);
        chatSuggestions?.Clear();
        await chatInput!.FocusAsync();

        currentResponseCancellation = new();

        var assistantText = await BackendApi.ChatAsync(
            model: "my-custom-model",
            messages: messages,
            ct: currentResponseCancellation.Token);

        messages.Add(new(ChatRole.Assistant, assistantText));
        chatSuggestions?.Update(messages);

        // Сохранить обновленные сообщения в LocalStorage
        await LocalStorage.SetItemAsync("chatMessages", messages);
    }

    private void CancelAnyCurrentResponse()
    {
        currentResponseCancellation?.Cancel();
        currentResponseMessage = null;
    }

    private async Task ResetConversationAsync()
    {
        CancelAnyCurrentResponse();
        messages.Clear();
        messages.Add(new(ChatRole.System, SystemPrompt));
        chatSuggestions?.Clear();
        await chatInput!.FocusAsync();

        // Сбросить сохраненные сообщения в LocalStorage
        await LocalStorage.RemoveItemAsync("chatMessages");
    }

    private async Task<IEnumerable<string>> SearchAsync(string searchPhrase, string? filenameFilter = null)
    {
        var results = await Search.SearchAsync(searchPhrase, filenameFilter, maxResults: 5);
        return results.Select(r =>
            $"<result filename=\"{r.FileName}\" page_number=\"{r.PageNumber}\">{r.Text}</result>");
    }

    private void OpenDocument(string fileName)
    {
        var url = $"Data/{fileName}";
        Nav.NavigateTo(url, true); // открытие PDF в новой вкладке
    }

    public void Dispose() => currentResponseCancellation?.Cancel();
}